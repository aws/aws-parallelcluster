name: ParallelClusterTest
description: Test ParallelCluster AMI
schemaVersion: 1.0

constants:
  - CookbookDefaultFile:
      type: string
      value: /etc/chef/cookbooks/aws-parallelcluster/attributes/default.rb

phases:
  - name: test
    steps:
      ### utils ###
      - name: NvSwitches
        action: ExecuteBash
        inputs:
          commands:
            - |
              set -v
              NVSWITCHES=$(lspci -d 10de:1af1 | wc -l)
              echo "${NVSWITCHES}"

      - name: BaseUID
        action: ExecuteBash
        inputs:
          commands:
            - |
              set -v
              PATTERN=$(grep -F "default['cluster']['reserved_base_uid']" {{ CookbookDefaultFile }})
              RESERVED_BASE_UID=$(echo ${PATTERN} | tr -d '\n' | cut -d = -f 2 | xargs)
              echo "${RESERVED_BASE_UID}"

      ### tests ###
      - name: FabricManager
        action: ExecuteBash
        inputs:
          commands:
            - |
              set -vx
              if [ {{ test.NvSwitches.outputs.stdout }} -gt 1 ]; then
                echo "test fabric-manager daemon"
                systemctl show -p SubState nvidia-fabricmanager | grep -i running
                [[ $? -ne 0 ]] && echo "fabric-manager daemon test failed" && exit 1
                echo "NVIDIA Fabric Manager service correctly started"
              fi

      - name: CloudWatch
        action: ExecuteBash
        inputs:
          commands:
            - |
              set -vx
              /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a status | grep status | grep stopped
              [[ $? -ne 0 ]] && echo "amazon-cloudwatch-agent is not stopped" && exit 1
              echo "CloudWatch test passed"

      - name: SchedulerPluginUser
        action: ExecuteBash
        inputs:
          commands:
            - |
              set -vx
              SYSTEM_USER_ID_START=$(( {{ test.BaseUID.outputs.stdout }} + 10 ))
              for i in $(seq 0 9);
              do
                  USER_ID=$(($i + $SYSTEM_USER_ID_START))
                  getent passwd ${USER_ID}
                  [[ $? -eq 0 ]] && echo "uid ${USER_ID} exists, it should be reserved for ParallelCluster system users. Reserved uid range is ${SYSTEM_USER_ID_START} - $(($SYSTEM_USER_ID_START + 9))" && exit 1
              done
              echo "SchedulerPlugin User test passed"

      - name: SchedulerPluginGroup
        action: ExecuteBash
        inputs:
          commands:
            - |
              set -vx
              SYSTEM_GROUP_ID_START=$(( {{ test.BaseUID.outputs.stdout }} + 10 ))
              for i in $(seq 0 9);
              do
                  GROUP_ID=$(($i + $SYSTEM_GROUP_ID_START))
                  getent group ${GROUP_ID}
                  [[ $? -eq 0 ]] && echo "gid ${GROUP_ID} exists, it should be reserved for ParallelCluster system group. Reserved gid range is ${SYSTEM_GROUP_ID_START} - $(($SYSTEM_GROUP_ID_START + 9))" && exit 1
              done
              echo "SchedulerPlugin Group test passed"
