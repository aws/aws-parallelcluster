[global]
cluster_template = default

[aws]
aws_region_name = {{ region }}

[cluster default]
base_os = {{ os }}
key_name = {{ key_name }}
vpc_settings = parallelcluster-vpc
scheduler = {{ scheduler }}
master_instance_type = {{ head_node_instance }}
queue_settings = efa-enabled
{% if instance == "p4d.24xlarge" %}
# Needed to use the p4d capacity reservation 
additional_iam_policies = arn:aws:iam::aws:policy/AmazonEC2FullAccess
post_install = s3://{{ bucket_name }}/run_instance_override.sh
s3_read_resource = arn:aws:s3:::{{ bucket_name }}/*
{% endif %}

[queue efa-enabled]
compute_resource_settings = efa-enabled_i1
enable_efa = true
disable_hyperthreading = {{ multithreading_disabled }}
{% if instance != "p4d.24xlarge" %}
# placement group cannot be used for p4d because we have PG/ODCR
placement_group = DYNAMIC
{% endif %}

[compute_resource efa-enabled_i1]
instance_type = {{ instance }}
min_count = {{ max_queue_size }}
max_count = {{ max_queue_size }}

[vpc parallelcluster-vpc]
vpc_id = {{ vpc_id }}
master_subnet_id = {{ public_subnet_id }}
compute_subnet_id = {{ private_subnet_id }}
use_public_ips = true
