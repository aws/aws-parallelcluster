# This file is automatically generated by pcluster
{% set ns = namespace(has_node=false) %}

{% for compute_resource in queue_config.ComputeResources %}
    {% set static_size = compute_resource.MinCount %}
    {% set dynamic_size = compute_resource.MaxCount - compute_resource.MinCount %}
    {% set instance_type = compute_resource.InstanceType%}
    {% if static_size > 0 %}
NodeName={{ queue_name }}-st-{{ compute_resource.Name }}-[1-{{ static_size }}] CPUs={{ compute_resource | vcpus }} State=CLOUD Feature=static,{{ instance_type }},{{ compute_resource.Name }}{% if compute_resource.Efa.Enabled %},efa{% endif %}{% if instance_type | gpus > 0 %},gpu{% if not no_gpu %} Gres=gpu:{{ instance_type | gpu_type }}:{{ instance_type | gpus }}{% endif %}{% endif %}

    {% endif %}
    {% if dynamic_size > 0 %}
NodeName={{ queue_name }}-dy-{{ compute_resource.Name }}-[1-{{ dynamic_size }}] CPUs={{ compute_resource | vcpus }} State=CLOUD Feature=dynamic,{{ instance_type }},{{ compute_resource.Name }}{% if compute_resource.Efa.Enabled %},efa{% endif %}{% if instance_type | gpus > 0 %},gpu{% if not no_gpu %} Gres=gpu:{{ instance_type | gpu_type }}:{{ instance_type | gpus }}{% endif %}{% endif %}

    {% endif %}
    {% if static_size > 0 or dynamic_size > 0 %}
        {% set ns.has_node = true %}
    {% endif %}
{% endfor %}
{% if ns.has_node %}

NodeSet={{ queue_name }}_nodes Nodes=
    {%- for compute_resource in queue_config.ComputeResources %}
        {% set static_size = compute_resource.MinCount %}
        {% set dynamic_size = compute_resource.MaxCount - compute_resource.MinCount %}
        {%- if static_size > 0 and dynamic_size > 0 -%}
{{ queue_name }}-st-{{ compute_resource.Name }}-[1-{{ static_size }}],{{ queue_name }}-dy-{{ compute_resource.Name }}-[1-{{ dynamic_size }}]
        {%- elif static_size > 0 -%}
{{ queue_name }}-st-{{ compute_resource.Name }}-[1-{{ static_size }}]
        {%- elif dynamic_size > 0 -%}
{{ queue_name }}-dy-{{ compute_resource.Name }}-[1-{{ dynamic_size }}]
        {%- endif %}
    {{- "," if not loop.last else "" -}}
    {% endfor %}

PartitionName={{ queue_name }} Nodes={{ queue_name }}_nodes MaxTime=INFINITE State=UP{% if is_default_queue %} Default=YES{% endif %} {% for key, value in queue_config.get('PartitionExtraConfig').items() %}{{ key }}={{ value }} {% endfor %}

{% endif %}
