{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "AWS CloudFormation Sample Template cfncluster.cfn.json: Sample template showing an framework for deploying master + compute type clusters on AWS.  **WARNING** This template creates AWS resources. You will be billed for the AWS resources used if you create a stack from this template. Version: cfncluster-1.5.2",
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "Network - Basic Settings"
          },
          "Parameters": [
            "VPCId",
            "MasterSubnetId"
          ]
        },
        {
          "Label": {
            "default": "Cluster - Basic Setting"
          },
          "Parameters": [
            "KeyName",
            "AvailabilityZone",
            "MasterInstanceType",
            "ComputeInstanceType",
            "BaseOS",
            "Scheduler"
          ]
        },
        {
          "Label": {
            "default": "EBS - Basic Settings"
          },
          "Parameters": [
            "VolumeSize"
          ]
        },
        {
          "Label": {
            "default": "Network - Advanced Settings"
          },
          "Parameters": [
            "AccessFrom",
            "ComputeSubnetId",
            "ComputeSubnetCidr",
            "UsePublicIps",
            "AdditionalSG",
            "VPCSecurityGroupId"
          ]
        },
        {
          "Label": {
            "default": "Cluster - Advanced Setting"
          },
          "Parameters": [
            "InitialQueueSize",
            "ComputeWaitConditionCount",
            "MaxQueueSize",
            "SpotPrice",
            "ClusterType",
            "ProxyServer",
            "CustomAMI",
            "MaintainInitialSize",
            "PreInstallScript",
            "PreInstallArgs",
            "PostInstallArgs",
            "PostInstallScript",
            "S3ReadResource",
            "S3ReadWriteResource",
            "Placement",
            "PlacementGroup",
            "EncryptedEphemeral",
            "EphemeralDir",
            "SharedDir",
            "CustomChefRunList",
            "CustomChefCookbook",
            "ExtraJson",
            "Tenancy",
            "EphemeralKMSKeyId",
            "ClusterReadyScript",
            "MasterRootVolumeSize",
            "ComputeRootVolumeSize",
            "EC2IAMRoleName"
          ]
        },
        {
          "Label": {
            "default": "EBS - Advanced Settings"
          },
          "Parameters": [
            "VolumeType",
            "EBSSnapshotId",
            "VolumeIOPS",
            "EBSEncryption",
            "EBSKMSKeyId",
            "EBSVolumeId"
          ]
        },
        {
          "Label": {
            "default": "Scaling Settings"
          },
          "Parameters": [
            "ScaleDownIdleTime"
          ]
        },
        {
          "Label": {
            "default": "Additonal Settings"
          },
          "Parameters": [
            "CLITemplate"
          ]
        }
      ],
      "ParameterLabels": {
        "KeyName": {
          "default": "key_name"
        },
        "AccessFrom": {
          "default": "access_from",
          "AccessFrom": {
            "default": "access_from"
          }
        },
        "VPCId": {
          "default": "vpc_id"
        },
        "MasterSubnetId": {
          "default": "master_subnet_id"
        },
        "ComputeSubnetId": {
          "default": "compute_subnet_id"
        },
        "ComputeSubnetCidr": {
          "default": "compute_subnet_cidr"
        },
        "UsePublicIps": {
          "default": "use_public_ips"
        },
        "AdditionalSG": {
          "default": "additional_sg"
        },
        "VPCSecurityGroupId": {
          "default": "vpc_security_group_id"
        },
        "ComputeInstanceType": {
          "default": "compute_instance_type"
        },
        "MasterInstanceType": {
          "default": "master_instance_type"
        },
        "InitialQueueSize": {
          "default": "initial_queue_size"
        },
        "MaxQueueSize": {
          "default": "max_queue_size"
        },
        "MaintainInitialSize": {
          "default": "maintain_initial_size"
        },
        "Scheduler": {
          "default": "scheduler"
        },
        "ClusterType": {
          "default": "cluster_type"
        },
        "EphemeralDir": {
          "default": "ephemeral_dir"
        },
        "SpotPrice": {
          "default": "spot_price"
        },
        "CustomAMI": {
          "default": "custom_ami"
        },
        "PreInstallScript": {
          "default": "pre_install"
        },
        "PostInstallScript": {
          "default": "post_install"
        },
        "PreInstallArgs": {
          "default": "pre_install_args"
        },
        "PostInstallArgs": {
          "default": "post_install_args"
        },
        "S3ReadResource": {
          "default": "s3_read_resource"
        },
        "S3ReadWriteResource": {
          "default": "s3_read_write_resource"
        },
        "ProxyServer": {
          "default": "proxy_server"
        },
        "Placement": {
          "default": "placement"
        },
        "PlacementGroup": {
          "default": "placement_group"
        },
        "EncryptedEphemeral": {
          "default": "encrypted_ephemeral"
        },
        "SharedDir": {
          "default": "shared_dir"
        },
        "Tenancy": {
          "default": "tenancy"
        },
        "EphemeralKMSKeyId": {
          "default": "ephemeral_kms_key_id"
        },
        "ClusterReadyScript": {
          "default": "cluster_ready"
        },
        "MasterRootVolumeSize": {
          "default": "master_root_volume_size"
        },
        "ComputeRootVolumeSize": {
          "default": "compute_volume_size"
        },
        "BaseOS": {
          "default": "base_os"
        },
        "EC2IAMRoleName": {
          "default": "ec2_iam_role"
        },
        "ExtraJson": {
          "default": "extra_json"
        },
        "CustomChefCookbook": {
          "default": "custom_chef_cookbook"
        },
        "CustomChefRunList": {
          "default": "custom_chef_runlist"
        },
        "EBSSnapshotId": {
          "default": "ebs_snapshot_id"
        },
        "VolumeType": {
          "default": "volume_type"
        },
        "VolumeSize": {
          "default": "volume_size"
        },
        "EBSKMSKeyId": {
          "default": "ebs_kms_key_id"
        },
        "VolumeIOPS": {
          "default": "volume_iops"
        },
        "EBSEncryption": {
          "default": "ebs_encryption"
        },
        "EBSVolumeId": {
          "default": "ebs_volume_id"
        },
        "ScaleDownIdleTime": {
          "default": "scaledown_idletime"
        },
        "ComputeWaitConditionCount": {
          "default": "WAIT COUNT"
        },
        "AvailabilityZone": {
          "default": "AVAILABILITY ZONE"
        },
        "CLITemplate": {
          "default": "CLI TEMPLATE"
        }
      }
    },
    "AWS::CloudFormation::Designer": {
      "ee5f3006-419e-4786-b527-e9503a662e5e": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": -170,
          "y": 390
        },
        "z": 1,
        "embeds": []
      },
      "c8d3da13-fd27-4377-b606-0f41728c17e1": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": -170,
          "y": 310
        },
        "z": 1,
        "embeds": []
      },
      "2904615e-c0ad-4325-b0c5-b9ea7c482b4e": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 60,
          "y": 390
        },
        "z": 1,
        "embeds": []
      },
      "45360a4f-64aa-49f8-b016-78fe5ed86819": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 60,
          "y": 310
        },
        "z": 1,
        "embeds": [],
        "ismemberof": [
          "2904615e-c0ad-4325-b0c5-b9ea7c482b4e"
        ]
      },
      "619070e4-82e5-445a-93a0-4795ff69d61c": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 180,
          "y": 480
        },
        "z": 1,
        "embeds": [],
        "isrelatedto": [
          "2904615e-c0ad-4325-b0c5-b9ea7c482b4e"
        ]
      },
      "466554d3-0e10-4ae4-bfee-51b0aadbf923": {
        "source": {
          "id": "2904615e-c0ad-4325-b0c5-b9ea7c482b4e"
        },
        "target": {
          "id": "619070e4-82e5-445a-93a0-4795ff69d61c"
        }
      },
      "0824f592-a72b-4bb5-8c67-4ce6df509cdd": {
        "size": {
          "width": 240,
          "height": 240
        },
        "position": {
          "x": -430,
          "y": 30
        },
        "z": 1,
        "embeds": []
      },
      "596ddc76-44b9-4747-921c-c000c5b636c0": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 60,
          "y": 150
        },
        "z": 0,
        "embeds": [],
        "references": [
          "45360a4f-64aa-49f8-b016-78fe5ed86819"
        ]
      },
      "bb5a532f-bb43-472a-9965-c4054cd61cc9": {
        "size": {
          "width": 150,
          "height": 150
        },
        "position": {
          "x": -150,
          "y": 70
        },
        "z": 1,
        "embeds": []
      },
      "9dd9772e-03a3-4983-b28e-a52ac42f0ffe": {
        "source": {
          "id": "0824f592-a72b-4bb5-8c67-4ce6df509cdd"
        },
        "target": {
          "id": "bb5a532f-bb43-472a-9965-c4054cd61cc9"
        }
      },
      "d5bad569-ad14-487d-bcc6-5569373bc8cd": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 180,
          "y": 310
        },
        "z": 1,
        "embeds": []
      },
      "e9ac6c41-8110-49b9-a92c-de57be8a292a": {
        "source": {
          "id": "d5bad569-ad14-487d-bcc6-5569373bc8cd"
        },
        "target": {
          "id": "45360a4f-64aa-49f8-b016-78fe5ed86819"
        }
      },
      "ce1cdcde-8551-4c33-b846-e1b0ab9ac8fb": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 270,
          "y": 30
        },
        "z": 1,
        "embeds": []
      },
      "a8fbc80f-2514-4cc9-aee8-ba7936add0a7": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 170,
          "y": 30
        },
        "z": 1,
        "embeds": [],
        "isassociatedwith": [
          "ce1cdcde-8551-4c33-b846-e1b0ab9ac8fb"
        ]
      },
      "0c5a1e92-ffdd-4344-8ba0-65270e5fd472": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 390,
          "y": 30
        },
        "z": 1,
        "embeds": [],
        "isassociatedwith": [
          "ce1cdcde-8551-4c33-b846-e1b0ab9ac8fb"
        ]
      },
      "2522b048-2b7c-44ed-9d35-6cc66069ca5b": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 390,
          "y": 130
        },
        "z": 1,
        "embeds": [],
        "isassociatedwith": [
          "ce1cdcde-8551-4c33-b846-e1b0ab9ac8fb"
        ]
      },
      "d3204db6-c821-400d-bf31-6afd5739923c": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 60,
          "y": 480
        },
        "z": 1,
        "embeds": [],
        "ismemberof": [
          "619070e4-82e5-445a-93a0-4795ff69d61c"
        ],
        "isrelatedto": [
          "2522b048-2b7c-44ed-9d35-6cc66069ca5b"
        ]
      },
      "88da1502-8179-4be3-9123-fdc5eac0b6a3": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": -50,
          "y": 310
        },
        "z": 1,
        "embeds": [],
        "isconnectedto": [
          "45360a4f-64aa-49f8-b016-78fe5ed86819"
        ],
        "isrelatedto": [
          "2522b048-2b7c-44ed-9d35-6cc66069ca5b",
          "ee5f3006-419e-4786-b527-e9503a662e5e"
        ]
      },
      "789cb442-3b1a-4673-a07e-8acb1c59c271": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 270,
          "y": 380
        },
        "z": 1,
        "embeds": []
      },
      "2f599618-92e8-49cf-92bd-551ba9775f39": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 450,
          "y": 380
        },
        "z": 1,
        "embeds": []
      },
      "7b0e0a3f-3a02-4e70-9e79-7647b98fd579": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 270,
          "y": 130
        },
        "z": 1,
        "embeds": [],
        "isassociatedwith": [
          "ce1cdcde-8551-4c33-b846-e1b0ab9ac8fb"
        ],
        "isrelatedto": [
          "2f599618-92e8-49cf-92bd-551ba9775f39",
          "789cb442-3b1a-4673-a07e-8acb1c59c271"
        ]
      },
      "210b5501-b505-4ee1-917c-a20cae3ac837": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 360,
          "y": 380
        },
        "z": 1,
        "embeds": [],
        "isrelatedto": [
          "2f599618-92e8-49cf-92bd-551ba9775f39"
        ]
      },
      "3fa053e5-8ab7-4cdf-a737-4d20386e4717": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": -50,
          "y": 480
        },
        "z": 1,
        "embeds": [],
        "isassociatedwith": [
          "d3204db6-c821-400d-bf31-6afd5739923c"
        ],
        "dependson": [
          "88da1502-8179-4be3-9123-fdc5eac0b6a3"
        ],
        "isrelatedto": [
          "bb5a532f-bb43-472a-9965-c4054cd61cc9",
          "210b5501-b505-4ee1-917c-a20cae3ac837",
          "ee5f3006-419e-4786-b527-e9503a662e5e"
        ]
      },
      "8e63b592-a50f-4b89-a40b-e991adaef77b": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": -50,
          "y": 600
        },
        "z": 1,
        "embeds": [],
        "isassociatedwith": [
          "3fa053e5-8ab7-4cdf-a737-4d20386e4717"
        ]
      },
      "23ed10e0-7726-4099-8370-4116c0bc78a2": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": -50,
          "y": 680
        },
        "z": 1,
        "embeds": [],
        "isrelatedto": [
          "8e63b592-a50f-4b89-a40b-e991adaef77b"
        ]
      },
      "89b41ceb-a2fb-4e17-a808-9bedc37b2b2c": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 60,
          "y": 600
        },
        "z": 1,
        "embeds": [],
        "isassociatedwith": [
          "3fa053e5-8ab7-4cdf-a737-4d20386e4717"
        ]
      },
      "127f78c3-d47a-4770-8aad-3fd733c3e1b0": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 60,
          "y": 680
        },
        "z": 1,
        "embeds": [],
        "isrelatedto": [
          "89b41ceb-a2fb-4e17-a808-9bedc37b2b2c"
        ]
      },
      "6a874346-80de-4412-9677-00590371a8a2": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 450,
          "y": 470
        },
        "z": 1,
        "embeds": [],
        "isassociatedwith": [
          "2f599618-92e8-49cf-92bd-551ba9775f39"
        ],
        "isrelatedto": [
          "210b5501-b505-4ee1-917c-a20cae3ac837"
        ]
      }
    }
  },
  "Parameters": {
    "KeyName": {
      "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instances using the default cluster user.",
      "Type": "AWS::EC2::KeyPair::KeyName"
    },
    "MasterInstanceType": {
      "Description": "MasterServer EC2 instance type",
      "Type": "String",
      "Default": "t2.micro",
      "ConstraintDescription": "Must be a valid EC2 instance type, with support for HVM."
    },
    "ComputeInstanceType": {
      "Description": "ComputeFleet EC2 instance type",
      "Type": "String",
      "Default": "t2.micro",
      "ConstraintDescription": "Must be a valid EC2 instance type, with support for HVM."
    },
    "InitialQueueSize": {
      "Description": "Initial number of EC2 instances to launch as compute nodes within the cluster. This value maps to the DesiredSize parameter for the ComputeFleet AutoScaling Group.",
      "Type": "Number",
      "Default": "2"
    },
    "MaxQueueSize": {
      "Description": "Maximum number of EC2 instances that can be launched in the cluster. This value maps to the MaxSize parameter for the ComputeFleet AutoScaling Group.",
      "Type": "Number",
      "Default": "10"
    },
    "ComputeSubnetId": {
      "Description": "ID of the Subnet you want to provision the Compute Servers into",
      "Type": "String",
      "Default": "NONE",
      "AllowedPattern": "(NONE|^subnet-[0-9a-z]{8}$|^subnet-[0-9a-z]{17}$)"
    },
    "SpotPrice": {
      "Description": "Spot bid price for the ComputeFleet AutoScaling Group when the ClusterType = \"spot\".",
      "Type": "Number",
      "Default": "0.00"
    },
    "ClusterType": {
      "Description": "Type of cluster to launch. Can either be \"ondemand\" or \"spot\". Choosing \"spot\" will cause the ComputeFleet AutoScaling group to launch EC2 Spot instances. Default value is \"ondemand\".",
      "Type": "String",
      "Default": "ondemand",
      "ConstraintDescription": "Must be a supported cluster type: ondemand, spot",
      "AllowedValues": [
        "ondemand",
        "spot"
      ]
    },
    "ProxyServer": {
      "Description": "hostname and port of HTTP proxy server for cfn-init, boto and yum i.e. proxy.example.com:8080",
      "Type": "String",
      "Default": "NONE"
    },
    "VolumeSize": {
      "Description": "Size of EBS volume in GB, if creating a new one",
      "Type": "Number",
      "Default": "20"
    },
    "VolumeType": {
      "Description": "Type of volume to create either new or from snapshot",
      "Type": "String",
      "Default": "gp2",
      "ConstraintDescription": "must be a supported volume type: standard, io1, gp2, st1, sc1",
      "AllowedValues": [
        "standard",
        "gp2",
        "io1",
        "st1",
        "sc1"
      ]
    },
    "MasterSubnetId": {
      "Description": "ID of the Subnet you want to provision the Master server into",
      "Type": "AWS::EC2::Subnet::Id"
    },
    "AvailabilityZone": {
      "Description": "Availability Zone the cluster will launch into. THIS IS REQUIRED",
      "Type": "AWS::EC2::AvailabilityZone::Name"
    },
    "EBSSnapshotId": {
      "Description": "Id of EBS snapshot if using snapshot as source for volume",
      "Type": "String",
      "Default": "NONE",
      "AllowedPattern": "(NONE|^snap-[0-9a-z]{8}$|^snap-[0-9a-z]{17}$)"
    },
    "CustomAMI": {
      "Description": "ID of a Custom AMI, to use instead of published AMI's",
      "Type": "String",
      "Default": "NONE",
      "AllowedPattern": "(NONE|^ami-[0-9a-z]{8}$|^ami-[0-9a-z]{17}$)"
    },
    "VPCId": {
      "Description": "ID of the VPC you want to provision cluster into. Only used with UseVPCBase=false",
      "Type": "AWS::EC2::VPC::Id"
    },
    "AccessFrom": {
      "Description": "Lockdown SSH/HTTP access (default can be accessed from anywhere)",
      "Type": "String",
      "MinLength": "9",
      "MaxLength": "18",
      "Default": "0.0.0.0/0",
      "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription": "must be a valid CIDR range of the form x.x.x.x/x."
    },
    "ComputeSubnetCidr": {
      "Description": "CIDR(s) for new backend subnet(s) i.e. 10.0.100.0/24. This is a comma-delimited list and can support multiple CIDR ranges for a multi-AZ cluster. The order and length of this list MUST match the AvailabilityZones parameter.",
      "Type": "String",
      "ConstraintDescription": "must be a valid CIDR range of the form x.x.x.x/x.",
      "AllowedPattern": "(NONE|(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2}))",
      "Default": "NONE"
    },
    "MaintainInitialSize": {
      "Description": "Boolean flag to set autoscaling group to maintain initial size and scale back",
      "Type": "String",
      "Default": "false",
      "ConstraintDescription": "true/false",
      "AllowedValues": [
        "true",
        "false"
      ]
    },
    "UsePublicIps": {
      "Description": "Boolean flag to use public IP's for instances. If false, the VPC must be correctly setup to use NAT for all traffic.",
      "Type": "String",
      "Default": "true",
      "ConstraintDescription": "true/false",
      "AllowedValues": [
        "true",
        "false"
      ]
    },
    "VolumeIOPS": {
      "Description": "Number of IOPS for volume type io1. Not used for other volume types.",
      "Type": "Number",
      "Default": "100"
    },
    "PreInstallScript": {
      "Description": "Preinstall script URL. This is run before any host configuration.",
      "Type": "String",
      "Default": "NONE"
    },
    "PostInstallScript": {
      "Description": "Postinstall script URL. This is run before any host configuration.",
      "Type": "String",
      "Default": "NONE"
    },
    "ComputeWaitConditionCount": {
      "Description": "Specific number of instances to wait for while creating the cluster",
      "Type": "Number",
      "Default": "2"
    },
    "S3ReadResource": {
      "Description": "S3 resource with read access from cfncluster nodes",
      "Type": "String",
      "Default": "NONE"
    },
    "S3ReadWriteResource": {
      "Description": "Addtional policy document to be added to EC2 IAM role created and assigned to all nodes.",
      "Type": "String",
      "Default": "NONE"
    },
    "Placement": {
      "Description": "Type of placement requird in cfncluster, it can either be cluster or compute.",
      "Type": "String",
      "Default": "cluster",
      "AllowedValues": [
        "cluster",
        "compute"
      ]
    },
    "PlacementGroup": {
      "Description": "The name of an existing placement group",
      "Type": "String",
      "Default": "NONE"
    },
    "EncryptedEphemeral": {
      "Description": "Boolean flag to encrypt local ephemeral drives. The keys are in-memory and non-recoverable.",
      "Type": "String",
      "Default": "false",
      "ConstraintDescription": "true/false",
      "AllowedValues": [
        "true",
        "false"
      ]
    },
    "PreInstallArgs": {
      "Description": "Preinstall script args passed to the preinstall script.",
      "Type": "String",
      "Default": "NONE"
    },
    "PostInstallArgs": {
      "Description": "Postinstall script args passed to the postinstall script.",
      "Type": "String",
      "Default": "NONE"
    },
    "EBSEncryption": {
      "Description": "Boolean flag to use EBS encryption for /shared volume. (Not to be used for snapshots)",
      "Type": "String",
      "Default": "false",
      "ConstraintDescription": "true/false",
      "AllowedValues": [
        "true",
        "false"
      ]
    },
    "EphemeralDir": {
      "Description": "The path/mountpoint for the ephemeral drive",
      "Type": "String",
      "Default": "/scratch"
    },
    "BaseOS": {
      "Description": "Base OS type for cluster AMI",
      "Type": "String",
      "Default": "alinux",
      "ConstraintDescription": "must be a supported base OS",
      "AllowedValues": [
        "centos6",
        "centos7",
        "alinux",
        "ubuntu1404",
        "ubuntu1604"
      ]
    },
    "ScaleDownIdleTime": {
      "Description": "Period in minutes without jobs after which compute node will terminate ",
      "Type": "String",
      "Default": "10"
    },
    "Scheduler": {
      "Description": "Cluster scheduler",
      "Type": "String",
      "Default": "sge",
      "ConstraintDescription": "must be a supported scheduler",
      "AllowedValues": [
        "sge",
        "torque",
        "slurm",
        "custom",
        "test"
      ]
    },
    "SharedDir": {
      "Description": "The path/mountpoint for the shared drive",
      "Type": "String",
      "Default": "/shared"
    },
    "CLITemplate": {
      "Description": "cluster_template section used in the config.",
      "Type": "String",
      "Default": "default"
    },
    "AdditionalSG": {
      "Description": "Additional VPC secuirty group to be added to instances. Defaults to NONE",
      "Type": "String",
      "Default": "NONE",
      "AllowedPattern": "(NONE|^sg-[0-9a-z]{8}$|^sg-[0-9a-z]{17}$)"
    },
    "CustomChefRunList": {
      "Description": "Custom run list, which will override the default",
      "Type": "String",
      "Default": "NONE"
    },
    "CustomChefCookbook": {
      "Description": "URL of custom cookbook that will override the default. This will be unpacked and then dependencies resolved with Berkshelf.",
      "Type": "String",
      "Default": "NONE"
    },
    "ExtraJson": {
      "Description": "Extra json to be added to Chef dna.json",
      "Type": "String",
      "Default": "{}"
    },
    "Tenancy": {
      "Description": "Type of placement requird in cfncluster, it can either be cluster or compute.",
      "Type": "String",
      "Default": "default",
      "AllowedValues": [
        "default",
        "dedicated"
      ]
    },
    "EBSKMSKeyId": {
      "Description": "KMS ARN for customer created master key, will be used for EBS encryption",
      "Type": "String",
      "Default": "NONE"
    },
    "EphemeralKMSKeyId": {
      "Description": "KMS ARN for customer created master key, will be used for ephemeral encryption",
      "Type": "String",
      "Default": "NONE"
    },
    "ClusterReadyScript": {
      "Description": "Cluster ready script URL. This is only on the MasterServer, when the cluster reaches CREATE_COMPLETE.",
      "Type": "String",
      "Default": "NONE"
    },
    "MasterRootVolumeSize": {
      "Description": "Size of MasterServer EBS root volume in GB",
      "Type": "Number",
      "Default": "15",
      "MinValue": "15"
    },
    "ComputeRootVolumeSize": {
      "Description": "Size of ComputeFleet EBS root volume in GB",
      "Type": "Number",
      "Default": "15",
      "MinValue": "15"
    },
    "EC2IAMRoleName": {
      "Description": "Existing EC2 IAM role name",
      "Type": "String",
      "Default": "NONE"
    },
    "VPCSecurityGroupId": {
      "Description": "Existing VPC security group Id",
      "Type": "String",
      "Default": "NONE",
      "AllowedPattern": "(NONE|^sg-[0-9a-z]{8}$|^sg-[0-9a-z]{17}$)"
    },
    "EBSVolumeId": {
      "Description": "Existing EBS volume Id",
      "Type": "String",
      "Default": "NONE",
      "AllowedPattern": "(NONE|^vol-[0-9a-z]{8}$|^vol-[0-9a-z]{17}$)"
    },
    "AdditionalCfnTemplate": {
      "Description": "A second CloudFormation template to launch with the cluster",
      "Type": "String",
      "Default": "NONE"
    }
  },
  "Conditions": {
    "IsMasterInstanceEbsOpt": {
      "Fn::Not": [
        {
          "Fn::Or": [
            {
              "Fn::Or": [
                {
                  "Fn::Equals": [
                    "cc2.8xlarge",
                    {
                      "Ref": "MasterInstanceType"
                    }
                  ]
                },
                {
                  "Fn::Equals": [
                    "cr1.8xlarge",
                    {
                      "Ref": "MasterInstanceType"
                    }
                  ]
                },
                {
                  "Fn::Equals": [
                    "g2.8xlarge",
                    {
                      "Ref": "MasterInstanceType"
                    }
                  ]
                },
                {
                  "Fn::Equals": [
                    "m3.medium",
                    {
                      "Ref": "MasterInstanceType"
                    }
                  ]
                },
                {
                  "Fn::Equals": [
                    "m3.large",
                    {
                      "Ref": "MasterInstanceType"
                    }
                  ]
                },
                {
                  "Fn::Equals": [
                    "c3.8xlarge",
                    {
                      "Ref": "MasterInstanceType"
                    }
                  ]
                },
                {
                  "Fn::Equals": [
                    "c3.large",
                    {
                      "Ref": "MasterInstanceType"
                    }
                  ]
                },
                {
                  "Fn::Equals": [
                    "r3.8xlarge",
                    {
                      "Ref": "MasterInstanceType"
                    }
                  ]
                },
                {
                  "Fn::Equals": [
                    "r3.large",
                    {
                      "Ref": "MasterInstanceType"
                    }
                  ]
                },
                {
                  "Fn::Equals": [
                    "i2.8xlarge",
                    {
                      "Ref": "MasterInstanceType"
                    }
                  ]
                }
              ]
            },
            {
              "Fn::Or": [
                {
                  "Fn::Equals": [
                    "i2.large",
                    {
                      "Ref": "MasterInstanceType"
                    }
                  ]
                },
                {
                  "Fn::Equals": [
                    "cg1.4xlarge",
                    {
                      "Ref": "MasterInstanceType"
                    }
                  ]
                },
                {
                  "Fn::Equals": [
                    "t2.nano",
                    {
                      "Ref": "MasterInstanceType"
                    }
                  ]
                },
                {
                  "Fn::Equals": [
                    "t2.micro",
                    {
                      "Ref": "MasterInstanceType"
                    }
                  ]
                },
                {
                  "Fn::Equals": [
                    "t2.small",
                    {
                      "Ref": "MasterInstanceType"
                    }
                  ]
                },
                {
                  "Fn::Equals": [
                    "t2.medium",
                    {
                      "Ref": "MasterInstanceType"
                    }
                  ]
                },
                {
                  "Fn::Equals": [
                    "t2.large",
                    {
                      "Ref": "MasterInstanceType"
                    }
                  ]
                },
                {
                  "Fn::Equals": [
                    "t2.xlarge",
                    {
                      "Ref": "MasterInstanceType"
                    }
                  ]
                },
                {
                  "Fn::Equals": [
                    "t2.2xlarge",
                    {
                      "Ref": "MasterInstanceType"
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    "UseSpotInstances": {
      "Fn::Equals": [
        {
          "Ref": "ClusterType"
        },
        "spot"
      ]
    },
    "UseSpotPrice": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "SpotPrice"
            },
            "0.00"
          ]
        }
      ]
    },
    "CreateComputeSubnetForCompute": {
      "Fn::And": [
        {
          "Fn::Equals": [
            {
              "Ref": "ComputeSubnetId"
            },
            "NONE"
          ]
        },
        {
          "Fn::Not": [
            {
              "Fn::Equals": [
                {
                  "Ref": "ComputeSubnetCidr"
                },
                "NONE"
              ]
            }
          ]
        }
      ]
    },
    "UseComputeSubnetForCompute": {
      "Fn::And": [
        {
          "Fn::Equals": [
            {
              "Ref": "ComputeSubnetCidr"
            },
            "NONE"
          ]
        },
        {
          "Fn::Not": [
            {
              "Fn::Equals": [
                {
                  "Ref": "ComputeSubnetId"
                },
                "NONE"
              ]
            }
          ]
        }
      ]
    },
    "UseMasterSubnetForCompute": {
      "Fn::And": [
        {
          "Fn::Equals": [
            {
              "Ref": "ComputeSubnetId"
            },
            "NONE"
          ]
        },
        {
          "Fn::Equals": [
            {
              "Ref": "ComputeSubnetCidr"
            },
            "NONE"
          ]
        }
      ]
    },
    "UseEBSSnapshot": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "EBSSnapshotId"
            },
            "NONE"
          ]
        }
      ]
    },
    "UseCustomRunList": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "CustomChefRunList"
            },
            "NONE"
          ]
        }
      ]
    },
    "UseCustomAMI": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "CustomAMI"
            },
            "NONE"
          ]
        }
      ]
    },
    "UseProxy": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "ProxyServer"
            },
            "NONE"
          ]
        }
      ]
    },
    "MaintainInitialASGSize": {
      "Fn::Equals": [
        {
          "Ref": "MaintainInitialSize"
        },
        "true"
      ]
    },
    "MasterPublicIp": {
      "Fn::Equals": [
        {
          "Ref": "UsePublicIps"
        },
        "true"
      ]
    },
    "ComputePublicIps": {
      "Fn::And": [
        {
          "Fn::Equals": [
            {
              "Ref": "UsePublicIps"
            },
            "true"
          ]
        },
        {
          "Condition": "UseMasterSubnetForCompute"
        }
      ]
    },
    "UseEBSPIOPS": {
      "Fn::Equals": [
        {
          "Ref": "VolumeType"
        },
        "io1"
      ]
    },
    "UseS3ReadPolicy": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "S3ReadResource"
            },
            "NONE"
          ]
        }
      ]
    },
    "UsePlacementGroup": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "PlacementGroup"
            },
            "NONE"
          ]
        }
      ]
    },
    "UseClusterPlacement": {
      "Fn::And": [
        {
          "Fn::Equals": [
            {
              "Ref": "Placement"
            },
            "cluster"
          ]
        },
        {
          "Condition": "UsePlacementGroup"
        }
      ]
    },
    "UseEBSEncryption": {
      "Fn::Equals": [
        {
          "Ref": "EBSEncryption"
        },
        "true"
      ]
    },
    "UseS3ReadWritePolicy": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "S3ReadWriteResource"
            },
            "NONE"
          ]
        }
      ]
    },
    "AddAdditionalSG": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AdditionalSG"
            },
            "NONE"
          ]
        }
      ]
    },
    "UseEBSKMSKey": {
      "Fn::And": [
        {
          "Fn::Not": [
            {
              "Fn::Equals": [
                {
                  "Ref": "EBSKMSKeyId"
                },
                "NONE"
              ]
            }
          ]
        },
        {
          "Condition": "UseEBSEncryption"
        }
      ]
    },
    "UseEphemeralKMSKey": {
      "Fn::And": [
        {
          "Fn::Not": [
            {
              "Fn::Equals": [
                {
                  "Ref": "EphemeralKMSKeyId"
                },
                "NONE"
              ]
            }
          ]
        },
        {
          "Fn::Equals": [
            {
              "Ref": "EncryptedEphemeral"
            },
            "true"
          ]
        }
      ]
    },
    "UseDedicatedTenancy": {
      "Fn::Equals": [
        {
          "Ref": "Tenancy"
        },
        "dedicated"
      ]
    },
    "UseEC2IAMRole": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "EC2IAMRoleName"
            },
            "NONE"
          ]
        }
      ]
    },
    "CreateEC2IAMRole": {
      "Fn::Equals": [
        {
          "Ref": "EC2IAMRoleName"
        },
        "NONE"
      ]
    },
    "UseExistingSecurityGroup": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "VPCSecurityGroupId"
            },
            "NONE"
          ]
        }
      ]
    },
    "UseExistingEBSVolume": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "EBSVolumeId"
            },
            "NONE"
          ]
        }
      ]
    },
    "CreateEBSVolume": {
      "Fn::Equals": [
        {
          "Ref": "EBSVolumeId"
        },
        "NONE"
      ]
    },
    "CreateSecurityGroups": {
      "Fn::Equals": [
        {
          "Ref": "VPCSecurityGroupId"
        },
        "NONE"
      ]
    },
    "CreateSubStack": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AdditionalCfnTemplate"
            },
            "NONE"
          ]
        }
      ]
    },
    "CreatePlacementGroup": {
      "Fn::And": [
        {
          "Fn::Equals": [
            {
              "Ref": "PlacementGroup"
            },
            "DYNAMIC"
          ]
        },
        {
          "Condition": "UsePlacementGroup"
        }
      ]
    },
    "GovCloudRegion": {
      "Fn::Equals": [
        { "Ref": "AWS::Partition" },
        "aws-us-gov"
      ]
    },
    "CreateLaunchTemplate": {
      "Fn::Not": [
        {
          "Condition": "GovCloudRegion"
        }
      ]
    }
  },
  "Mappings": {
    "AWSRegionOS2AMI": {
      "ap-northeast-1": {
        "alinux": "ami-0775ab7ad13c0e74f",
        "centos6": "ami-0f676dc2bebea5b1a",
        "centos7": "ami-0b13eb5fa94691483",
        "ubuntu1404": "ami-05b67b05deba61e8c",
        "ubuntu1604": "ami-0232ea8f3f82712a2"
      },
      "ap-northeast-2": {
        "alinux": "ami-09fdf91b4a93730f0",
        "centos6": "ami-0adf39100d009ad31",
        "centos7": "ami-015bf65572df2d94d",
        "ubuntu1404": "ami-06aa825c33309fdfd",
        "ubuntu1604": "ami-08d64fa4a89f85427"
      },
      "ap-northeast-3": {
        "alinux": "ami-03a0e4ad407dd7f55",
        "centos6": "ami-0da12c87d2aee0ef5",
        "centos7": "ami-0479721fa287d3cf7",
        "ubuntu1404": "ami-0c03a23da1606fa3a",
        "ubuntu1604": "ami-0cfdcf1603db9a672"
      },
      "ap-south-1": {
        "alinux": "ami-008d194619d177765",
        "centos6": "ami-05a8a28e5c8b74642",
        "centos7": "ami-087bda89547e089dc",
        "ubuntu1404": "ami-096a418446cd1eeb1",
        "ubuntu1604": "ami-009f971485befe66a"
      },
      "ap-southeast-1": {
        "alinux": "ami-08eef0c7d23753d49",
        "centos6": "ami-02ce4e46ca873697e",
        "centos7": "ami-0d339c926f9d35ba3",
        "ubuntu1404": "ami-0d413135984f7bd97",
        "ubuntu1604": "ami-02ab2d97bea65a826"
      },
      "ap-southeast-2": {
        "alinux": "ami-08d6ef8690d843ceb",
        "centos6": "ami-013201a7fda637e83",
        "centos7": "ami-0ac15e60210a10310",
        "ubuntu1404": "ami-079737fc9c635c09a",
        "ubuntu1604": "ami-0fc63c095a0c31f0a"
      },
      "ca-central-1": {
        "alinux": "ami-00f519fdeb5feb438",
        "centos6": "ami-0ee6c95ad927b2da4",
        "centos7": "ami-068d6a6fc5e7987f3",
        "ubuntu1404": "ami-00cec9c492f236616",
        "ubuntu1604": "ami-0705c0b15666e7d60"
      },
      "eu-central-1": {
        "alinux": "ami-07fa07aba1f6fc571",
        "centos6": "ami-0de3eb16b173ea6b3",
        "centos7": "ami-0f73d5d5bb22f7609",
        "ubuntu1404": "ami-0d6242ced07309e7b",
        "ubuntu1604": "ami-08ab664e40e331729"
      },
      "eu-west-1": {
        "alinux": "ami-09cbb5230da5b6cc2",
        "centos6": "ami-0c8eca7deb52169cc",
        "centos7": "ami-05479870b31fa535e",
        "ubuntu1404": "ami-06581a7f68c539440",
        "ubuntu1604": "ami-096183a7e31fc4e35"
      },
      "eu-west-2": {
        "alinux": "ami-006cd2956238a6dd7",
        "centos6": "ami-013d7f40fc791f845",
        "centos7": "ami-08c5c6f990f8253e1",
        "ubuntu1404": "ami-00621b5f273783bce",
        "ubuntu1604": "ami-0a4fbb1dd660013b5"
      },
      "eu-west-3": {
        "alinux": "ami-0fce6e16d9970d71b",
        "centos6": "ami-0cac2d11252d18c27",
        "centos7": "ami-0d6c4b2dde29e341f",
        "ubuntu1404": "ami-07da72e5a66a93c71",
        "ubuntu1604": "ami-0fcf3de0f1913a190"
      },
      "sa-east-1": {
        "alinux": "ami-0165d34de1afd1618",
        "centos6": "ami-074dbf929dc0c8de0",
        "centos7": "ami-00cfa447d16329380",
        "ubuntu1404": "ami-0f4a298763a012d8e",
        "ubuntu1604": "ami-06fa4a172ebe11a10"
      },
      "us-east-1": {
        "alinux": "ami-0fd8b1245d1435bf3",
        "centos6": "ami-044fd430f1fd3b163",
        "centos7": "ami-0fb2dca992af734f2",
        "ubuntu1404": "ami-07df96c1d8e62161d",
        "ubuntu1604": "ami-0b9750a5856891754"
      },
      "us-east-2": {
        "alinux": "ami-0cb3d04ae4b4ca8db",
        "centos6": "ami-03c508534d6f54859",
        "centos7": "ami-03421fa006b964767",
        "ubuntu1404": "ami-0f7c7f69478093925",
        "ubuntu1604": "ami-0a2c6075e91d8bbc3"
      },
      "us-gov-west-1": {
        "alinux": "ami-e0fd6781",
        "ubuntu1404": "ami-38f36959",
        "ubuntu1604": "ami-3bf3695a"
      },
      "us-west-1": {
        "alinux": "ami-02f24f766b5b7502f",
        "centos6": "ami-05ee27a886e16ba39",
        "centos7": "ami-012c5239be2beb7f1",
        "ubuntu1404": "ami-077e3b1efa9443476",
        "ubuntu1604": "ami-00b0c33ebc9576bf8"
      },
      "us-west-2": {
        "alinux": "ami-01e7f12fc989e7004",
        "centos6": "ami-08675896633a1d9fb",
        "centos7": "ami-0053bef6747ca58bf",
        "ubuntu1404": "ami-0581577b81f865ae9",
        "ubuntu1604": "ami-00e5e4cc71cf05d6e"
      }
    },
    "OSFeatures": {
      "centos6": {
        "User": "centos",
        "RootDevice": "/dev/sda1"
      },
      "centos7": {
        "User": "centos",
        "RootDevice": "/dev/sda1"
      },
      "alinux": {
        "User": "ec2-user",
        "RootDevice": "/dev/xvda"
      },
      "ubuntu1404": {
        "User": "ubuntu",
        "RootDevice": "/dev/sda1"
      },
      "ubuntu1604": {
        "User": "ubuntu",
        "RootDevice": "/dev/sda1"
      }
    },
    "CfnClusterVersions": {
      "default": {
        "cfncluster": "cfncluster-1.6.2",
        "cookbook": "cfncluster-cookbook-1.6.2",
        "chef": "14.2.0",
        "ridley": "5.1.1",
        "berkshelf": "7.0.4",
        "ami": "dev"
      }
    }
  },
  "Resources": {
    "SQS": {
      "Type": "AWS::SQS::Queue",
      "Properties": {
        "MessageRetentionPeriod": 1209600
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "2f599618-92e8-49cf-92bd-551ba9775f39"
        }
      }
    },
    "SQSPolicy": {
      "Type": "AWS::SQS::QueuePolicy",
      "Properties": {
        "PolicyDocument": {
          "Id": "MyQueuePolicy",
          "Statement": [
            {
              "Sid": "Allow-SendMessage-From-AS-SNS-Topic",
              "Effect": "Allow",
              "Principal": {
                "AWS": "*"
              },
              "Action": [
                "sqs:SendMessage"
              ],
              "Resource": "*",
              "Condition": {
                "ArnEquals": {
                  "aws:SourceArn": {
                    "Ref": "SNS"
                  }
                }
              }
            }
          ]
        },
        "Queues": [
          {
            "Ref": "SQS"
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "6a874346-80de-4412-9677-00590371a8a2"
        }
      }
    },
    "SNS": {
      "Type": "AWS::SNS::Topic",
      "Properties": {
        "Subscription": [
          {
            "Endpoint": {
              "Fn::GetAtt": [
                "SQS",
                "Arn"
              ]
            },
            "Protocol": "sqs"
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "210b5501-b505-4ee1-917c-a20cae3ac837"
        }
      }
    },
    "DynamoDBTable": {
      "Type": "AWS::DynamoDB::Table",
      "Properties": {
        "AttributeDefinitions": [
          {
            "AttributeName": "instanceId",
            "AttributeType": "S"
          }
        ],
        "KeySchema": [
          {
            "AttributeName": "instanceId",
            "KeyType": "HASH"
          }
        ],
        "ProvisionedThroughput": {
          "ReadCapacityUnits": "5",
          "WriteCapacityUnits": "5"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "789cb442-3b1a-4673-a07e-8acb1c59c271"
        }
      }
    },
    "RootRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "ec2.amazonaws.com"
                ]
              },
              "Action": [
                "sts:AssumeRole"
              ]
            }
          ]
        },
        "Path": "/"
      },
      "Condition": "CreateEC2IAMRole",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "ce1cdcde-8551-4c33-b846-e1b0ab9ac8fb"
        }
      }
    },
    "RootInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {"Fn::If": [
            "UseEC2IAMRole",
            {
              "Ref": "EC2IAMRoleName"
            },
            {
              "Ref": "RootRole"
            }
          ]}
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "2522b048-2b7c-44ed-9d35-6cc66069ca5b"
        }
      }
    },  
    "CfnClusterPolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyName": "cfncluster",
        "PolicyDocument": {
          "Statement": [
            {
              "Sid": "EC2",
              "Action": [
                "ec2:DescribeVolumes",
                "ec2:AttachVolume",
                "ec2:DescribeInstanceAttribute",
                "ec2:DescribeInstanceStatus",
                "ec2:DescribeInstances"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Sid": "DynamoDBList",
              "Action": [
                "dynamodb:ListTables"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Sid": "SQSQueue",
              "Action": [
                "sqs:SendMessage",
                "sqs:ReceiveMessage",
                "sqs:ChangeMessageVisibility",
                "sqs:DeleteMessage",
                "sqs:GetQueueUrl"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "SQS",
                    "Arn"
                  ]
                }
              ]
            },
            {
              "Sid": "Autoscaling",
              "Action": [
                "autoscaling:DescribeAutoScalingGroups",
                "autoscaling:TerminateInstanceInAutoScalingGroup",
                "autoscaling:SetDesiredCapacity",
                "autoscaling:UpdateAutoScalingGroup",
                "autoscaling:DescribeTags"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Sid": "Cloudformation",
              "Action": [
                "cloudformation:DescribeStacks"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition"
                      },
                      ":cloudformation:",
                      {
                        "Ref": "AWS::Region"
                      },
                      ":",
                      {
                        "Ref": "AWS::AccountId"
                      },
                      ":stack/cfncluster-*"
                    ]
                  ]
                }
              ]
            },
            {
              "Sid": "DynamoDBTable",
              "Action": [
                "dynamodb:PutItem",
                "dynamodb:Query",
                "dynamodb:GetItem",
                "dynamodb:DeleteItem",
                "dynamodb:DescribeTable"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition"
                      },
                      ":dynamodb:",
                      {
                        "Ref": "AWS::Region"
                      },
                      ":",
                      {
                        "Ref": "AWS::AccountId"
                      },
                      ":table/",
                      {
                        "Ref": "DynamoDBTable"
                      }
                    ]
                  ]
                }
              ]
            },
            {
              "Sid": "S3GetObj",
              "Action": [
                "s3:GetObject"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition"
                      },
                      ":s3:::",
                      {
                        "Ref": "AWS::Region"
                      },
                      "-cfncluster/*"
                    ]
                  ]
                }
              ]
            },
            {
              "Sid": "SQSList",
              "Action": [
                "sqs:ListQueues"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            }
          ]
        },
        "Roles": [
          {
            "Ref": "RootRole"
          }
        ]
      },
      "Condition": "CreateEC2IAMRole",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "7b0e0a3f-3a02-4e70-9e79-7647b98fd579"
        }
      }
    },
    "S3ReadRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyName": "S3Read",
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "S3Read",
              "Effect": "Allow",
              "Action": [
                "s3:Get*",
                "s3:List*"
              ],
              "Resource": [
                {
                  "Ref": "S3ReadResource"
                }
              ]
            }
          ]
        },
        "Roles": [
          {
            "Ref": "RootRole"
          }
        ]
      },
      "Condition": "UseS3ReadPolicy",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "0c5a1e92-ffdd-4344-8ba0-65270e5fd472"
        }
      }
    },
    "S3ReadWriteRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyName": "S3ReadWrite",
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "S3ReadWrite",
              "Effect": "Allow",
              "Action": [
                "s3:*"
              ],
              "Resource": [
                {
                  "Ref": "S3ReadWriteResource"
                }
              ]
            }
          ]
        },
        "Roles": [
          {
            "Ref": "RootRole"
          }
        ]
      },
      "Condition": "UseS3ReadWritePolicy",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "a8fbc80f-2514-4cc9-aee8-ba7936add0a7"
        }
      }
    },
    "MasterEIP": {
      "Type": "AWS::EC2::EIP",
      "Properties": {
        "Domain": "vpc"
      },
      "Condition": "MasterPublicIp",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "d5bad569-ad14-487d-bcc6-5569373bc8cd"
        }
      }
    },
    "MasterServer": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "InstanceType": {
          "Ref": "MasterInstanceType"
        },
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/xvdba",
            "VirtualName": "ephemeral0"
          },
          {
            "DeviceName": "/dev/xvdbb",
            "VirtualName": "ephemeral1"
          },
          {
            "DeviceName": "/dev/xvdbc",
            "VirtualName": "ephemeral2"
          },
          {
            "DeviceName": "/dev/xvdbd",
            "VirtualName": "ephemeral3"
          },
          {
            "DeviceName": "/dev/xvdbe",
            "VirtualName": "ephemeral4"
          },
          {
            "DeviceName": "/dev/xvdbf",
            "VirtualName": "ephemeral5"
          },
          {
            "DeviceName": "/dev/xvdbg",
            "VirtualName": "ephemeral6"
          },
          {
            "DeviceName": "/dev/xvdbh",
            "VirtualName": "ephemeral7"
          },
          {
            "DeviceName": "/dev/xvdbi",
            "VirtualName": "ephemeral8"
          },
          {
            "DeviceName": "/dev/xvdbj",
            "VirtualName": "ephemeral9"
          },
          {
            "DeviceName": "/dev/xvdbk",
            "VirtualName": "ephemeral10"
          },
          {
            "DeviceName": "/dev/xvdbl",
            "VirtualName": "ephemeral11"
          },
          {
            "DeviceName": "/dev/xvdbm",
            "VirtualName": "ephemeral12"
          },
          {
            "DeviceName": "/dev/xvdbn",
            "VirtualName": "ephemeral13"
          },
          {
            "DeviceName": "/dev/xvdbo",
            "VirtualName": "ephemeral14"
          },
          {
            "DeviceName": "/dev/xvdbp",
            "VirtualName": "ephemeral15"
          },
          {
            "DeviceName": "/dev/xvdbq",
            "VirtualName": "ephemeral16"
          },
          {
            "DeviceName": "/dev/xvdbr",
            "VirtualName": "ephemeral17"
          },
          {
            "DeviceName": "/dev/xvdbs",
            "VirtualName": "ephemeral18"
          },
          {
            "DeviceName": "/dev/xvdbt",
            "VirtualName": "ephemeral19"
          },
          {
            "DeviceName": "/dev/xvdbu",
            "VirtualName": "ephemeral20"
          },
          {
            "DeviceName": "/dev/xvdbv",
            "VirtualName": "ephemeral21"
          },
          {
            "DeviceName": "/dev/xvdbw",
            "VirtualName": "ephemeral22"
          },
          {
            "DeviceName": "/dev/xvdbx",
            "VirtualName": "ephemeral23"
          },
          {
            "DeviceName": {
              "Fn::FindInMap": [
                "OSFeatures",
                {
                  "Ref": "BaseOS"
                },
                "RootDevice"
              ]
            },
            "Ebs": {
              "VolumeSize": {
                "Ref": "MasterRootVolumeSize"
              },
              "VolumeType": "gp2"
            }
          }
        ],
        "KeyName": {
          "Ref": "KeyName"
        },
        "Tags": [
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "Name",
            "Value": "Master"
          }
        ],
        "NetworkInterfaces": [
          {
            "NetworkInterfaceId": {
              "Ref": "MasterENI"
            },
            "DeviceIndex": "0"
          }
        ],
        "ImageId": {
          "Fn::If": [
            "UseCustomAMI",
            {
              "Ref": "CustomAMI"
            },
            {
              "Fn::FindInMap": [
                "AWSRegionOS2AMI",
                {
                  "Ref": "AWS::Region"
                },
                {
                  "Ref": "BaseOS"
                }
              ]
            }
          ]
        },
        "EbsOptimized": {
          "Fn::If": [
            "IsMasterInstanceEbsOpt",
            "true",
            "false"
          ]
        },
        "IamInstanceProfile": {"Ref": "RootInstanceProfile"},
        "PlacementGroupName": {
          "Fn::If": [
            "UseClusterPlacement",
            {
              "Fn::If": [
                "CreatePlacementGroup",
                {
                  "Ref": "DynamicPlacementGroup"
                },
                {
                  "Ref": "PlacementGroup"
                }
              ]
            },
            {
              "Ref": "AWS::NoValue"
            }
          ]
        },
        "Tenancy": {
          "Ref": "Tenancy"
        },
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "Content-Type: multipart/mixed; boundary=\"==BOUNDARY==\"\n",
                "MIME-Version: 1.0\n\n",
                "--==BOUNDARY==\n",
                "Content-Type: text/cloud-config; charset=\"us-ascii\"\n",
                "MIME-Version: 1.0\n\n",
                "#cloud-config:\n",
                "runcmd:\n",
                " - [ sh, -c, 'which yum && echo \"proxy=",
                {
                  "Fn::If": [
                    "UseProxy",
                    {
                      "Ref": "ProxyServer"
                    },
                    "_none_"
                  ]
                },
                "\" >> /etc/yum.conf' ]\n",
                " - [ sh, -c, 'which apt-get && echo \"Acquire::http::Proxy \\\"",
                {
                  "Fn::If": [
                    "UseProxy",
                    {
                      "Ref": "ProxyServer"
                    },
                    "false"
                  ]
                },
                "\\\";\" >> /etc/apt/apt.conf ]\n",
                "--==BOUNDARY==\n",
                "Content-Type: text/x-shellscript; charset=\"us-ascii\"\n",
                "MIME-Version: 1.0\n\n",
                "#!/bin/bash -x\n\n",
                "function error_exit\n",
                "{\n",
                "  cfn-signal ${proxy_args} --exit-code=1 --reason=\"$1\" --stack=",
                {
                  "Ref": "AWS::StackName"
                },
                " --resource=MasterServer --region=",
                {
                  "Ref": "AWS::Region"
                },
                "\n",
                "  exit 1\n",
                "}\n",
                "function bootstrap_instance\n",
                "{\n",
                "  which yum 2>/dev/null; yum=$?\n",
                "  which apt-get 2>/dev/null; apt=$?\n",
                "  if [ \"${yum}\" == \"0\" ]; then\n",
                "    yum -y groupinstall development && yum -y install curl wget\n",
                "  fi\n",
                "  if [ \"${apt}\" == \"0\" ]; then\n",
                "    apt-cache search build-essential; apt-get clean; apt-get update; apt-get -y install build-essential curl wget\n",
                "  fi\n",
                "  which cfn-init 2>/dev/null || ( curl -s -L -o /tmp/aws-cfn-bootstrap-latest.tar.gz https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz; easy_install -U /tmp/aws-cfn-bootstrap-latest.tar.gz)\n",
                "  mkdir -p /etc/chef && chown -R root:root /etc/chef\n",
                "  curl -L https://www.chef.io/chef/install.sh | bash -s -- -v ${chef_version}\n",
                "  /opt/chef/embedded/bin/gem install --no-rdoc --no-ri ridley:${ridley_version} berkshelf:${berkshelf_version}\n",
                "  curl -s -L -o /etc/chef/cfncluster-cookbook.tgz ${cookbook_url}\n",
                "  curl -s -L -o /etc/chef/cfncluster-cookbook.tgz.date ${cookbook_url}.date\n",
                "  curl -s -L -o /etc/chef/cfncluster-cookbook.tgz.md5 ${cookbook_url}.md5\n",
                "  mkdir /opt/cfncluster && echo ${cfncluster_version} | tee /opt/cfncluster/.bootstrapped\n",
                "}\n",
                "proxy=",
                {
                  "Ref": "ProxyServer"
                },
                "\n",
                "custom_cookbook=",
                {
                  "Ref": "CustomChefCookbook"
                },
                "\n",
                "if [ \"${proxy}\" != \"NONE\" ]; then\n",
                "  proxy_args=\"--http-proxy=${proxy} --https-proxy=${proxy}\"\n",
                "  proxy_host=$(echo \"${proxy}\" | awk -F/ '{print $3}' | cut -d: -f1)\n",
                "  proxy_port=$(echo \"${proxy}\" | awk -F/ '{print $3}' | cut -d: -f2)\n",
                "  export http_proxy=${proxy}; export https_proxy=${http_proxy}\n",
                "  export HTTP_PROXY=${proxy}; export HTTPS_PROXY=${http_proxy}\n",
                "  export no_proxy=169.254.169.254; export NO_PROXY=169.254.169.254\n",
                "  echo -e \"export http_proxy=${proxy}; export https_proxy=${http_proxy}\nexport HTTP_PROXY=${proxy}; export HTTPS_PROXY=${http_proxy}\nexport no_proxy=169.254.169.254; export NO_PROXY=169.254.169.254\n\" >/tmp/proxy.sh\n",
                "  echo -e \"[Boto]\nproxy = ${proxy_host}\nproxy_port = ${proxy_port}\n\" >/etc/boto.cfg\n",
                "else\n",
                "  proxy_args=\"\"\n",
                "  touch /tmp/proxy.sh\n",
                "fi\n",
                "if [ \"${custom_cookbook}\" != \"NONE\" ]; then\n",
                "  cookbook_url=${custom_cookbook}\n",
                "else\n",
                "  if [ \"",
                {
                  "Ref": "AWS::Region"
                },
                "\" == \"us-east-1\" ]; then\n",
                "    s3_prefix=s3\n",
                "  else\n",
                "    s3_prefix=s3-",
                {
                  "Ref": "AWS::Region"
                },
                "\n",
                "  fi\n",
                "  cookbook_url=https://${s3_prefix}.amazonaws.com/cfncluster-resources-",
                {
                  "Ref": "AWS::Region"
                },
                "/cookbooks/",
                {
                  "Fn::FindInMap": [
                    "CfnClusterVersions",
                    "default",
                    "cookbook"
                  ]
                },
                ".tgz\n",
                "fi\n",
                "export PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/opt/aws/bin\n",
                "export cfncluster_version=",
                {
                  "Fn::FindInMap": [
                    "CfnClusterVersions",
                    "default",
                    "cfncluster"
                  ]
                },
                "\n",
                "export cookbook_version=",
                {
                  "Fn::FindInMap": [
                    "CfnClusterVersions",
                    "default",
                    "cookbook"
                  ]
                },
                "\n",
                "export chef_version=",
                {
                  "Fn::FindInMap": [
                    "CfnClusterVersions",
                    "default",
                    "chef"
                  ]
                },
                "\n",
                "export ridley_version=",
                {
                  "Fn::FindInMap": [
                    "CfnClusterVersions",
                    "default",
                    "ridley"
                  ]
                },
                "\n",
                "export berkshelf_version=",
                {
                  "Fn::FindInMap": [
                    "CfnClusterVersions",
                    "default",
                    "berkshelf"
                  ]
                },
                "\n",
                "if [ -f /opt/cfncluster/.bootstrapped ]; then\n",
                "  installed_version=$(cat /opt/cfncluster/.bootstrapped)\n",
                "  if [ \"${cfncluster_version}\" != \"${installed_version}\" ]; then\n",
                "    bootstrap_instance\n",
                "  fi\n",
                "else\n",
                "  bootstrap_instance\n",
                "fi\n",
                "mkdir /tmp/cookbooks\n",
                "cd /tmp/cookbooks\n",
                "curl -v -L -o /etc/chef/cfncluster-cookbook.tgz -z \"$(cat /etc/chef/cfncluster-cookbook.tgz.date)\" ${cookbook_url}\n",
                "tar -xzf /etc/chef/cfncluster-cookbook.tgz\n",
                "cd /tmp\n",
                "# Call CloudFormation\n",
                "cfn-init ${proxy_args} -s ",
                {
                  "Ref": "AWS::StackName"
                },
                " -v -c default -r MasterServer --region ",
                {
                  "Ref": "AWS::Region"
                },
                " || error_exit 'Failed to run cfn-init. If --norollback was specified, check /var/log/cfn-init.log and /var/log/cloud-init-output.log.'\n",
                "cfn-signal ${proxy_args} --exit-code=0 --reason=\"MasterServer setup complete\" --stack=",
                {
                  "Ref": "AWS::StackName"
                },
                " --resource=MasterServer --region=",
                {
                  "Ref": "AWS::Region"
                },
                "\n",
                "# End of file\n",
                "--==BOUNDARY==\n"
              ]
            ]
          }
        }
      },
      "Metadata": {
        "Comment": "cfncluster Master server",
        "AWS::CloudFormation::Init": {
          "configSets": {
            "default": [
              "deployConfigFiles",
              "getCookbooks",
              "chefPrepEnv",
              "shellRunPreInstall",
              "chefConfig",
              "shellRunPostInstall",
              "shellForkClusterReadyInstall"
            ]
          },
          "deployConfigFiles": {
            "files": {
              "/tmp/dna.json": {
                "mode": "000644",
                "owner": "root",
                "group": "root",
                "content": {
                  "cfncluster": {
                    "stack_name": {
                      "Ref": "AWS::StackName"
                    },
                    "cfn_preinstall": {
                      "Ref": "PreInstallScript"
                    },
                    "cfn_preinstall_args": {
                      "Ref": "PreInstallArgs"
                    },
                    "cfn_postinstall": {
                      "Ref": "PostInstallScript"
                    },
                    "cfn_postinstall_args": {
                      "Ref": "PostInstallArgs"
                    },
                    "cfn_region": {
                      "Ref": "AWS::Region"
                    },
                    "cfn_volume": {
                      "Fn::If": [
                        "UseExistingEBSVolume",
                        {
                          "Ref": "EBSVolumeId"
                        },
                        {
                          "Ref": "SharedVolume"
                        }
                      ]
                    },
                    "cfn_scheduler": {
                      "Ref": "Scheduler"
                    },
                    "cfn_encrypted_ephemeral": {
                      "Ref": "EncryptedEphemeral"
                    },
                    "cfn_ephemeral_dir": {
                      "Ref": "EphemeralDir"
                    },
                    "cfn_shared_dir": {
                      "Ref": "SharedDir"
                    },
                    "cfn_proxy": {
                      "Ref": "ProxyServer"
                    },
                    "cfn_max_queue_size": {
                      "Ref": "MaxQueueSize"
                    },
                    "compute_instance_type": {
                      "Ref": "ComputeInstanceType"
                    },
                    "cfn_node_type": "MasterServer",
                    "cfn_cluster_user": {
                      "Fn::FindInMap": [
                        "OSFeatures",
                        {
                          "Ref": "BaseOS"
                        },
                        "User"
                      ]
                    },
                    "cfn_ddb_table": {
                      "Ref": "DynamoDBTable"
                    },
                    "cfn_sqs_queue": {
                      "Fn::GetAtt": [
                        "SQS",
                        "QueueName"
                      ]
                    }
                  },
                  "run_list": {
                    "Fn::If": [
                      "UseCustomRunList",
                      {
                        "Ref": "CustomChefRunList"
                      },
                      {
                        "Fn::Join": [
                          "",
                          [
                            "recipe[cfncluster::",
                            {
                              "Ref": "Scheduler"
                            },
                            "_config]"
                          ]
                        ]
                      }
                    ]
                  }
                }
              },
              "/etc/chef/client.rb": {
                "mode": "000644",
                "owner": "root",
                "group": "root",
                "content": {
                  "Fn::Join": [
                    "",
                    [
                      "cookbook_path ['/etc/chef/cookbooks']"
                    ]
                  ]
                }
              },
              "/tmp/extra.json": {
                "mode": "000644",
                "owner": "root",
                "group": "root",
                "content": {
                  "Ref": "ExtraJson"
                }
              }
            },
            "commands": {
              "mkdir": {
                "command": "mkdir -p /etc/chef/ohai/hints"
              },
              "touch": {
                "command": "touch /etc/chef/ohai/hints/ec2.json"
              },
              "jq": {
                "command": "/usr/local/bin/jq --argfile f1 /tmp/dna.json --argfile f2 /tmp/extra.json -n '$f1 + $f2 | .cfncluster = $f1.cfncluster + $f2.cfncluster' > /etc/chef/dna.json || ( echo \"jq not installed\"; cp /tmp/dna.json /etc/chef/dna.json )"
              }
            }
          },
          "getCookbooks": {
            "commands": {
              "berk": {
                "command": ". /tmp/proxy.sh; for d in `ls /tmp/cookbooks`; do cd /tmp/cookbooks/$d;LANG=en_US.UTF-8 /opt/chef/embedded/bin/berks vendor /etc/chef/cookbooks --delete; done ",
                "cwd": "/tmp/cookbooks",
                "env": {
                  "HOME": "/tmp"
                }
              }
            }
          },
          "chefPrepEnv": {
            "commands": {
              "chef": {
                "command": "chef-client --local-mode --config /etc/chef/client.rb --log_level auto --force-formatter --no-color --chef-zero-port 8889 --json-attributes /etc/chef/dna.json --override-runlist cfncluster::_prep_env",
                "cwd": "/etc/chef"
              }
            }
          },
          "shellRunPreInstall": {
            "commands": {
              "runpreinstall": {
                "command": "/opt/cfncluster/scripts/fetch_and_run -preinstall"
              }
            }
          },
          "chefConfig": {
            "commands": {
              "chef": {
                "command": "chef-client --local-mode --config /etc/chef/client.rb --log_level auto --force-formatter --no-color --chef-zero-port 8889 --json-attributes /etc/chef/dna.json",
                "cwd": "/etc/chef"
              }
            }
          },
          "shellRunPostInstall": {
            "commands": {
              "runpostinstall": {
                "command": "/opt/cfncluster/scripts/fetch_and_run -postinstall"
              }
            }
          },
          "shellForkClusterReadyInstall": {
            "commands": {
              "clusterreadyinstall": {
                "command": "/opt/cfncluster/scripts/fetch_and_run -clusterreadyinstall"
              }
            }
          }
        },
        "AWS::CloudFormation::Designer": {
          "id": "88da1502-8179-4be3-9123-fdc5eac0b6a3"
        }
      },
      "CreationPolicy": {
        "ResourceSignal": {
          "Count": "1",
          "Timeout": "PT30M"
        }
      }
    },
    "ComputeFleet": {
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "Properties": {
        "MaxSize": {
          "Ref": "MaxQueueSize"
        },
        "VPCZoneIdentifier": [
          {
            "Fn::If": [
              "UseMasterSubnetForCompute",
              {
                "Ref": "MasterSubnetId"
              },
              {
                "Fn::If": [
                  "CreateComputeSubnetForCompute",
                  {
                    "Ref": "ComputeSubnet"
                  },
                  {
                    "Ref": "ComputeSubnetId"
                  }
                ]
              }
            ]
          }
        ],
        "LaunchConfigurationName": {
          "Fn::If": [
            "GovCloudRegion",
            { "Ref": "ComputeServerLaunchConfig" },
            { "Ref": "AWS::NoValue" }
          ]
        },
        "LaunchTemplate": {
          "Fn::If": [
            "CreateLaunchTemplate",
            {
              "LaunchTemplateId": {
                "Ref": "ComputeServerLaunchTemplate"
              },
              "Version": {
                "Fn::GetAtt": [
                  "ComputeServerLaunchTemplate",
                  "LatestVersionNumber"
                ]
              }
            },
            { "Ref": "AWS::NoValue" }
          ]
        },
        "MinSize": {
          "Fn::If": [
            "MaintainInitialASGSize",
            {
              "Ref": "InitialQueueSize"
            },
            "0"
          ]
        },
        "DesiredCapacity": {
          "Ref": "InitialQueueSize"
        },
        "NotificationConfiguration": {
          "TopicARN": {
            "Ref": "SNS"
          },
          "NotificationTypes": [
            "autoscaling:EC2_INSTANCE_TERMINATE"
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "Compute",
            "PropagateAtLaunch": "true"
          }
        ],
        "PlacementGroup": {
          "Fn::If": [
            "UsePlacementGroup",
            {
              "Fn::If": [
                "CreatePlacementGroup",
                {
                  "Ref": "DynamicPlacementGroup"
                },
                {
                  "Ref": "PlacementGroup"
                }
              ]
            },
            {
              "Ref": "AWS::NoValue"
            }
          ]
        }
      },
      "DependsOn": "MasterServer",
      "CreationPolicy": {
        "ResourceSignal": {
          "Timeout": "PT30M",
          "Count": {
            "Ref": "ComputeWaitConditionCount"
          }
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "3fa053e5-8ab7-4cdf-a737-4d20386e4717"
        }
      }
    },
    "ComputeServerLaunchConfig": {
      "Type": "AWS::AutoScaling::LaunchConfiguration",
      "Properties": {
        "SecurityGroups": [
          {
            "Fn::If": [
              "CreateSecurityGroups",
              {
                "Ref": "ComputeSecurityGroup"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          },
          {
            "Fn::If": [
              "AddAdditionalSG",
              {
                "Ref": "AdditionalSG"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          },
          {
            "Fn::If": [
              "UseExistingSecurityGroup",
              {
                "Ref": "VPCSecurityGroupId"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          }
        ],
        "AssociatePublicIpAddress": {
          "Fn::If": [
            "ComputePublicIps",
            "true",
            "false"
          ]
        },
        "InstanceType": {
          "Ref": "ComputeInstanceType"
        },
        "KeyName": {
          "Ref": "KeyName"
        },
        "IamInstanceProfile": {"Ref": "RootInstanceProfile"},
        "SpotPrice": {
          "Fn::If": [
            "UseSpotInstances",
            {
              "Ref": "SpotPrice"
            },
            {
              "Ref": "AWS::NoValue"
            }
          ]
        },
        "ImageId": {
          "Fn::If": [
            "UseCustomAMI",
            {
              "Ref": "CustomAMI"
            },
            {
              "Fn::FindInMap": [
                "AWSRegionOS2AMI",
                {
                  "Ref": "AWS::Region"
                },
                {
                  "Ref": "BaseOS"
                }
              ]
            }
          ]
        },
        "InstanceMonitoring": "false",
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/xvdba",
            "VirtualName": "ephemeral0"
          },
          {
            "DeviceName": "/dev/xvdbb",
            "VirtualName": "ephemeral1"
          },
          {
            "DeviceName": "/dev/xvdbc",
            "VirtualName": "ephemeral2"
          },
          {
            "DeviceName": "/dev/xvdbd",
            "VirtualName": "ephemeral3"
          },
          {
            "DeviceName": "/dev/xvdbe",
            "VirtualName": "ephemeral4"
          },
          {
            "DeviceName": "/dev/xvdbf",
            "VirtualName": "ephemeral5"
          },
          {
            "DeviceName": "/dev/xvdbg",
            "VirtualName": "ephemeral6"
          },
          {
            "DeviceName": "/dev/xvdbh",
            "VirtualName": "ephemeral7"
          },
          {
            "DeviceName": "/dev/xvdbi",
            "VirtualName": "ephemeral8"
          },
          {
            "DeviceName": "/dev/xvdbj",
            "VirtualName": "ephemeral9"
          },
          {
            "DeviceName": "/dev/xvdbk",
            "VirtualName": "ephemeral10"
          },
          {
            "DeviceName": "/dev/xvdbl",
            "VirtualName": "ephemeral11"
          },
          {
            "DeviceName": "/dev/xvdbm",
            "VirtualName": "ephemeral12"
          },
          {
            "DeviceName": "/dev/xvdbn",
            "VirtualName": "ephemeral13"
          },
          {
            "DeviceName": "/dev/xvdbo",
            "VirtualName": "ephemeral14"
          },
          {
            "DeviceName": "/dev/xvdbp",
            "VirtualName": "ephemeral15"
          },
          {
            "DeviceName": "/dev/xvdbq",
            "VirtualName": "ephemeral16"
          },
          {
            "DeviceName": "/dev/xvdbr",
            "VirtualName": "ephemeral17"
          },
          {
            "DeviceName": "/dev/xvdbs",
            "VirtualName": "ephemeral18"
          },
          {
            "DeviceName": "/dev/xvdbt",
            "VirtualName": "ephemeral19"
          },
          {
            "DeviceName": "/dev/xvdbu",
            "VirtualName": "ephemeral20"
          },
          {
            "DeviceName": "/dev/xvdbv",
            "VirtualName": "ephemeral21"
          },
          {
            "DeviceName": "/dev/xvdbw",
            "VirtualName": "ephemeral22"
          },
          {
            "DeviceName": "/dev/xvdbx",
            "VirtualName": "ephemeral23"
          },
          {
            "DeviceName": {
              "Fn::FindInMap": [
                "OSFeatures",
                {
                  "Ref": "BaseOS"
                },
                "RootDevice"
              ]
            },
            "Ebs": {
              "VolumeSize": {
                "Ref": "ComputeRootVolumeSize"
              },
              "VolumeType": "gp2"
            }
          }
        ],
        "PlacementTenancy": {
          "Fn::If": [
            "UseDedicatedTenancy",
            {
              "Ref": "Tenancy"
            },
            {
              "Ref": "AWS::NoValue"
            }
          ]
        },
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "Content-Type: multipart/mixed; boundary=\"==BOUNDARY==\"\n",
                "MIME-Version: 1.0\n\n",
                "--==BOUNDARY==\n",
                "Content-Type: text/cloud-config; charset=\"us-ascii\"\n",
                "MIME-Version: 1.0\n\n",
                "#cloud-config:\n",
                "runcmd:\n",
                " - [ sh, -c, 'which yum && echo \"proxy=",
                {
                  "Fn::If": [
                    "UseProxy",
                    {
                      "Ref": "ProxyServer"
                    },
                    "_none_"
                  ]
                },
                "\" >> /etc/yum.conf' ]\n",
                " - [ sh, -c, 'which apt-get && echo \"Acquire::http::Proxy \\\"",
                {
                  "Fn::If": [
                    "UseProxy",
                    {
                      "Ref": "ProxyServer"
                    },
                    "false"
                  ]
                },
                "\\\";\" >> /etc/apt/apt.conf' ]\n",
                "--==BOUNDARY==\n",
                "Content-Type: text/x-shellscript; charset=\"us-ascii\"\n",
                "MIME-Version: 1.0\n\n",
                "#!/bin/bash -x\n\n",
                "function error_exit\n",
                "{\n",
                "  cfn-signal ${proxy_args} --exit-code=1 --reason=\"$1\" --stack=",
                {
                  "Ref": "AWS::StackName"
                },
                " --resource=ComputeFleet --region=",
                {
                  "Ref": "AWS::Region"
                },
                "\n",
                "  exit 1\n",
                "}\n",
                "function bootstrap_instance\n",
                "{\n",
                "  which yum 2>/dev/null; yum=$?\n",
                "  which apt-get 2>/dev/null; apt=$?\n",
                "  if [ \"${yum}\" == \"0\" ]; then\n",
                "    yum -y groupinstall development && yum -y install curl wget\n",
                "  fi\n",
                "  if [ \"${apt}\" == \"0\" ]; then\n",
                "    apt-cache search build-essential; apt-get clean; apt-get update; apt-get -y install build-essential curl wget\n",
                "  fi\n",
                "  which cfn-init 2>/dev/null || ( curl -s -L -o /tmp/aws-cfn-bootstrap-latest.tar.gz https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz; easy_install -U /tmp/aws-cfn-bootstrap-latest.tar.gz)\n",
                "  mkdir -p /etc/chef && chown -R root:root /etc/chef\n",
                "  curl -L https://www.chef.io/chef/install.sh | bash -s -- -v ${chef_version}\n",
                "  /opt/chef/embedded/bin/gem install --no-rdoc --no-ri ridley:${ridley_version} berkshelf:${berkshelf_version}\n",
                "  curl -s -L -o /etc/chef/cfncluster-cookbook.tgz ${cookbook_url}\n",
                "  curl -s -L -o /etc/chef/cfncluster-cookbook.tgz.date ${cookbook_url}.date\n",
                "  curl -s -L -o /etc/chef/cfncluster-cookbook.tgz.md5 ${cookbook_url}.md5\n",
                "  mkdir /opt/cfncluster && echo ${cfncluster_version} | tee /opt/cfncluster/.bootstrapped\n",
                "}\n",
                "proxy=",
                {
                  "Ref": "ProxyServer"
                },
                "\n",
                "custom_cookbook=",
                {
                  "Ref": "CustomChefCookbook"
                },
                "\n",
                "if [ \"${proxy}\" != \"NONE\" ]; then\n",
                "  proxy_args=\"--http-proxy=${proxy} --https-proxy=${proxy}\"\n",
                "  proxy_host=$(echo \"${proxy}\" | awk -F/ '{print $3}' | cut -d: -f1)\n",
                "  proxy_port=$(echo \"${proxy}\" | awk -F/ '{print $3}' | cut -d: -f2)\n",
                "  export http_proxy=${proxy}; export https_proxy=${http_proxy}\n",
                "  export HTTP_PROXY=${proxy}; export HTTPS_PROXY=${http_proxy}\n",
                "  export no_proxy=169.254.169.254; export NO_PROXY=169.254.169.254\n",
                "  echo -e \"export http_proxy=${proxy}; export https_proxy=${http_proxy}\nexport HTTP_PROXY=${proxy}; export HTTPS_PROXY=${http_proxy}\nexport no_proxy=169.254.169.254; export NO_PROXY=169.254.169.254\n\" >/tmp/proxy.sh\n",
                "  echo -e \"[Boto]\nproxy = ${proxy_host}\nproxy_port = ${proxy_port}\n\" >/etc/boto.cfg\n",
                "else\n",
                "  proxy_args=\"\"\n",
                "  touch /tmp/proxy.sh\n",
                "fi\n",
                "if [ \"${custom_cookbook}\" != \"NONE\" ]; then\n",
                "  cookbook_url=${custom_cookbook}\n",
                "else\n",
                "  if [ \"",
                {
                  "Ref": "AWS::Region"
                },
                "\" == \"us-east-1\" ]; then\n",
                "    s3_prefix=s3\n",
                "  else\n",
                "    s3_prefix=s3-",
                {
                  "Ref": "AWS::Region"
                },
                "\n",
                "  fi\n",
                "  cookbook_url=https://${s3_prefix}.amazonaws.com/cfncluster-resources-",
                {
                  "Ref": "AWS::Region"
                },
                "/cookbooks/",
                {
                  "Fn::FindInMap": [
                    "CfnClusterVersions",
                    "default",
                    "cookbook"
                  ]
                },
                ".tgz\n",
                "fi\n",
                "export PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/opt/aws/bin\n",
                "export cfncluster_version=",
                {
                  "Fn::FindInMap": [
                    "CfnClusterVersions",
                    "default",
                    "cfncluster"
                  ]
                },
                "\n",
                "export cookbook_version=",
                {
                  "Fn::FindInMap": [
                    "CfnClusterVersions",
                    "default",
                    "cookbook"
                  ]
                },
                "\n",
                "export chef_version=",
                {
                  "Fn::FindInMap": [
                    "CfnClusterVersions",
                    "default",
                    "chef"
                  ]
                },
                "\n",
                "export ridley_version=",
                {
                  "Fn::FindInMap": [
                    "CfnClusterVersions",
                    "default",
                    "ridley"
                  ]
                },
                "\n",
                "export berkshelf_version=",
                {
                  "Fn::FindInMap": [
                    "CfnClusterVersions",
                    "default",
                    "berkshelf"
                  ]
                },
                "\n",
                "if [ -f /opt/cfncluster/.bootstrapped ]; then\n",
                "  installed_version=$(cat /opt/cfncluster/.bootstrapped)\n",
                "  if [ \"${cfncluster_version}\" != \"${installed_version}\" ]; then\n",
                "    bootstrap_instance\n",
                "  fi\n",
                "else\n",
                "  bootstrap_instance\n",
                "fi\n",
                "mkdir /tmp/cookbooks\n",
                "cd /tmp/cookbooks\n",
                "curl -v -L -o /etc/chef/cfncluster-cookbook.tgz -z \"$(cat /etc/chef/cfncluster-cookbook.tgz.date)\" ${cookbook_url}\n",
                "tar -xzf /etc/chef/cfncluster-cookbook.tgz\n",
                "cd /tmp\n",
                "# Call CloudFormation\n",
                "cfn-init ${proxy_args} -s ",
                {
                  "Ref": "AWS::StackName"
                },
                " -v -c default -r ComputeServerLaunchConfig --region ",
                {
                  "Ref": "AWS::Region"
                },
                " || error_exit 'Failed to run cfn-init. If --norollback was specified, check /var/log/cfn-init.log and /var/log/cloud-init-output.log.'\n",
                "cfn-signal ${proxy_args} --exit-code=0 --reason=\"MasterServer setup complete\" --stack=",
                {
                  "Ref": "AWS::StackName"
                },
                " --resource=ComputeFleet --region=",
                {
                  "Ref": "AWS::Region"
                },
                "\n",
                "# End of file\n",
                "--==BOUNDARY==\n"
              ]
            ]
          }
        }
      },
      "Condition": "GovCloudRegion",
      "Metadata": {
        "Comment": "cfncluster Compute server",
        "AWS::CloudFormation::Init": {
          "configSets": {
            "default": [
              "deployConfigFiles",
              "getCookbooks",
              "chefPrepEnv",
              "shellRunPreInstall",
              "chefConfig",
              "shellRunPostInstall",
              "shellForkClusterReadyInstall",
              "signalComputeReady"
            ]
          },
          "deployConfigFiles": {
            "files": {
              "/tmp/dna.json": {
                "mode": "000644",
                "owner": "root",
                "group": "root",
                "content": {
                  "cfncluster": {
                    "stack_name": {
                      "Ref": "AWS::StackName"
                    },
                    "cfn_preinstall": {
                      "Ref": "PreInstallScript"
                    },
                    "cfn_preinstall_args": {
                      "Ref": "PreInstallArgs"
                    },
                    "cfn_postinstall": {
                      "Ref": "PostInstallScript"
                    },
                    "cfn_postinstall_args": {
                      "Ref": "PostInstallArgs"
                    },
                    "cfn_region": {
                      "Ref": "AWS::Region"
                    },
                    "cfn_scheduler": {
                      "Ref": "Scheduler"
                    },
                    "cfn_scaledown_idletime": {
                      "Ref": "ScaleDownIdleTime"
                    },
                    "cfn_encrypted_ephemeral": {
                      "Ref": "EncryptedEphemeral"
                    },
                    "cfn_ephemeral_dir": {
                      "Ref": "EphemeralDir"
                    },
                    "cfn_shared_dir": {
                      "Ref": "SharedDir"
                    },
                    "cfn_proxy": {
                      "Ref": "ProxyServer"
                    },
                    "cfn_sqs_queue": {
                      "Ref": "SQS"
                    },
                    "cfn_master": {
                      "Fn::GetAtt": [
                        "MasterServer",
                        "PrivateDnsName"
                      ]
                    },
                    "cfn_node_type": "ComputeFleet",
                    "cfn_cluster_user": {
                      "Fn::FindInMap": [
                        "OSFeatures",
                        {
                          "Ref": "BaseOS"
                        },
                        "User"
                      ]
                    }
                  },
                  "run_list": {
                    "Fn::If": [
                      "UseCustomRunList",
                      {
                        "Ref": "CustomChefRunList"
                      },
                      {
                        "Fn::Join": [
                          "",
                          [
                            "recipe[cfncluster::",
                            {
                              "Ref": "Scheduler"
                            },
                            "_config]"
                          ]
                        ]
                      }
                    ]
                  }
                }
              },
              "/etc/chef/client.rb": {
                "mode": "000644",
                "owner": "root",
                "group": "root",
                "content": {
                  "Fn::Join": [
                    "",
                    [
                      "cookbook_path ['/etc/chef/cookbooks']"
                    ]
                  ]
                }
              },
              "/tmp/extra.json": {
                "mode": "000644",
                "owner": "root",
                "group": "root",
                "content": {
                  "Ref": "ExtraJson"
                }
              }
            },
            "commands": {
              "mkdir": {
                "command": "mkdir -p /etc/chef/ohai/hints"
              },
              "touch": {
                "command": "touch /etc/chef/ohai/hints/ec2.json"
              },
              "jq": {
                "command": "/usr/local/bin/jq --argfile f1 /tmp/dna.json --argfile f2 /tmp/extra.json -n '$f1 + $f2 | .cfncluster = $f1.cfncluster + $f2.cfncluster' > /etc/chef/dna.json || ( echo \"jq not installed\"; cp /tmp/dna.json /etc/chef/dna.json )"
              }
            }
          },
          "getCookbooks": {
            "commands": {
              "berk": {
                "command": ". /tmp/proxy.sh; for d in `ls /tmp/cookbooks`; do cd /tmp/cookbooks/$d;LANG=en_US.UTF-8 /opt/chef/embedded/bin/berks vendor /etc/chef/cookbooks --delete; done ",
                "cwd": "/tmp/cookbooks",
                "env": {
                  "HOME": "/tmp"
                }
              }
            }
          },
          "chefPrepEnv": {
            "commands": {
              "chef": {
                "command": "chef-client --local-mode --config /etc/chef/client.rb --log_level auto --force-formatter --no-color --chef-zero-port 8889 --json-attributes /etc/chef/dna.json --override-runlist cfncluster::_prep_env",
                "cwd": "/etc/chef"
              }
            }
          },
          "shellRunPreInstall": {
            "commands": {
              "runpreinstall": {
                "command": "/opt/cfncluster/scripts/fetch_and_run -preinstall"
              }
            }
          },
          "chefConfig": {
            "commands": {
              "chef": {
                "command": "chef-client --local-mode --config /etc/chef/client.rb --log_level auto --force-formatter --no-color --chef-zero-port 8889 --json-attributes /etc/chef/dna.json",
                "cwd": "/etc/chef"
              }
            }
          },
          "shellRunPostInstall": {
            "commands": {
              "runpostinstall": {
                "command": "/opt/cfncluster/scripts/fetch_and_run -postinstall"
              }
            }
          },
          "shellForkClusterReadyInstall": {
            "commands": {
              "clusterreadyinstall": {
                "command": "/opt/cfncluster/scripts/fetch_and_run -clusterreadyinstall"
              }
            }
          },
          "signalComputeReady": {
            "commands": {
              "compute_ready": {
                "command": "/opt/cfncluster/scripts/compute_ready"
              }
            }
          }
        },
        "AWS::CloudFormation::Designer": {
          "id": "d3204db6-c821-400d-bf31-6afd5739923c"
        }
      }
    },
    "ComputeServerLaunchTemplate": {
      "Type": "AWS::EC2::LaunchTemplate",
      "Properties": {
        "LaunchTemplateData": {
          "NetworkInterfaces": [
            {
              "DeviceIndex": 0,
              "Groups": [
                {
                  "Fn::If": [
                    "CreateSecurityGroups",
                    {
                      "Ref": "ComputeSecurityGroup"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                },
                {
                  "Fn::If": [
                    "AddAdditionalSG",
                    {
                      "Ref": "AdditionalSG"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                },
                {
                  "Fn::If": [
                    "UseExistingSecurityGroup",
                    {
                      "Ref": "VPCSecurityGroupId"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                }
              ],
              "AssociatePublicIpAddress": {
                "Fn::If": [
                  "ComputePublicIps",
                  true,
                  false
                ]
              }
            }
          ],
          "InstanceType": {
            "Ref": "ComputeInstanceType"
          },
          "KeyName": {
            "Ref": "KeyName"
          },
          "IamInstanceProfile": {
            "Fn::If": [
              "UseEC2IAMRole",
              {
                "Name": {
                  "Ref": "EC2IAMRoleName"
                }
              },
              {
                "Name": {
                  "Ref": "RootInstanceProfile"
                }
              }
            ]
          },
          "InstanceMarketOptions": {
            "Fn::If": [
              "UseSpotInstances",
              {
                "SpotOptions": {
                  "SpotInstanceType": "one-time",
                  "InstanceInterruptionBehavior": "terminate",
                  "MaxPrice": {
                    "Fn::If": [
                      "UseSpotPrice",
                      {
                        "Ref": "SpotPrice"
                      },
                      {
                        "Ref": "AWS::NoValue"
                      }
                    ]
                  }
                },
                "MarketType": "spot"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          },
          "ImageId": {
            "Fn::If": [
              "UseCustomAMI",
              {
                "Ref": "CustomAMI"
              },
              {
                "Fn::FindInMap": [
                  "AWSRegionOS2AMI",
                  {
                    "Ref": "AWS::Region"
                  },
                  {
                    "Ref": "BaseOS"
                  }
                ]
              }
            ]
          },
          "Monitoring": {
            "Enabled": "false"
          },
          "BlockDeviceMappings": [
            {
              "DeviceName": "/dev/xvdba",
              "VirtualName": "ephemeral0"
            },
            {
              "DeviceName": "/dev/xvdbb",
              "VirtualName": "ephemeral1"
            },
            {
              "DeviceName": "/dev/xvdbc",
              "VirtualName": "ephemeral2"
            },
            {
              "DeviceName": "/dev/xvdbd",
              "VirtualName": "ephemeral3"
            },
            {
              "DeviceName": "/dev/xvdbe",
              "VirtualName": "ephemeral4"
            },
            {
              "DeviceName": "/dev/xvdbf",
              "VirtualName": "ephemeral5"
            },
            {
              "DeviceName": "/dev/xvdbg",
              "VirtualName": "ephemeral6"
            },
            {
              "DeviceName": "/dev/xvdbh",
              "VirtualName": "ephemeral7"
            },
            {
              "DeviceName": "/dev/xvdbi",
              "VirtualName": "ephemeral8"
            },
            {
              "DeviceName": "/dev/xvdbj",
              "VirtualName": "ephemeral9"
            },
            {
              "DeviceName": "/dev/xvdbk",
              "VirtualName": "ephemeral10"
            },
            {
              "DeviceName": "/dev/xvdbl",
              "VirtualName": "ephemeral11"
            },
            {
              "DeviceName": "/dev/xvdbm",
              "VirtualName": "ephemeral12"
            },
            {
              "DeviceName": "/dev/xvdbn",
              "VirtualName": "ephemeral13"
            },
            {
              "DeviceName": "/dev/xvdbo",
              "VirtualName": "ephemeral14"
            },
            {
              "DeviceName": "/dev/xvdbp",
              "VirtualName": "ephemeral15"
            },
            {
              "DeviceName": "/dev/xvdbq",
              "VirtualName": "ephemeral16"
            },
            {
              "DeviceName": "/dev/xvdbr",
              "VirtualName": "ephemeral17"
            },
            {
              "DeviceName": "/dev/xvdbs",
              "VirtualName": "ephemeral18"
            },
            {
              "DeviceName": "/dev/xvdbt",
              "VirtualName": "ephemeral19"
            },
            {
              "DeviceName": "/dev/xvdbu",
              "VirtualName": "ephemeral20"
            },
            {
              "DeviceName": "/dev/xvdbv",
              "VirtualName": "ephemeral21"
            },
            {
              "DeviceName": "/dev/xvdbw",
              "VirtualName": "ephemeral22"
            },
            {
              "DeviceName": "/dev/xvdbx",
              "VirtualName": "ephemeral23"
            },
            {
              "DeviceName": {
                "Fn::FindInMap": [
                  "OSFeatures",
                  {
                    "Ref": "BaseOS"
                  },
                  "RootDevice"
                ]
              },
              "Ebs": {
                "VolumeSize": {
                  "Ref": "ComputeRootVolumeSize"
                },
                "VolumeType": "gp2"
              }
            }
          ],
          "Placement": {
            "Fn::If": [
              "UseDedicatedTenancy",
              {
                "Tenancy": {
                  "Ref": "Tenancy"
                }
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          },
          "UserData": {
            "Fn::Base64": {
              "Fn::Join": [
                "",
                [
                  "Content-Type: multipart/mixed; boundary=\"==BOUNDARY==\"\n",
                  "MIME-Version: 1.0\n\n",
                  "--==BOUNDARY==\n",
                  "Content-Type: text/cloud-config; charset=\"us-ascii\"\n",
                  "MIME-Version: 1.0\n\n",
                  "#cloud-config:\n",
                  "runcmd:\n",
                  " - [ sh, -c, 'which yum && echo \"proxy=",
                  {
                    "Fn::If": [
                      "UseProxy",
                      {
                        "Ref": "ProxyServer"
                      },
                      "_none_"
                    ]
                  },
                  "\" >> /etc/yum.conf' ]\n",
                  " - [ sh, -c, 'which apt-get && echo \"Acquire::http::Proxy \\\"",
                  {
                    "Fn::If": [
                      "UseProxy",
                      {
                        "Ref": "ProxyServer"
                      },
                      "false"
                    ]
                  },
                  "\\\";\" >> /etc/apt/apt.conf' ]\n",
                  "--==BOUNDARY==\n",
                  "Content-Type: text/x-shellscript; charset=\"us-ascii\"\n",
                  "MIME-Version: 1.0\n\n",
                  "#!/bin/bash -x\n\n",
                  "function error_exit\n",
                  "{\n",
                  "  cfn-signal ${proxy_args} --exit-code=1 --reason=\"$1\" --stack=",
                  {
                    "Ref": "AWS::StackName"
                  },
                  " --resource=ComputeFleet --region=",
                  {
                    "Ref": "AWS::Region"
                  },
                  "\n",
                  "  exit 1\n",
                  "}\n",
                  "function bootstrap_instance\n",
                  "{\n",
                  "  which yum 2>/dev/null; yum=$?\n",
                  "  which apt-get 2>/dev/null; apt=$?\n",
                  "  if [ \"${yum}\" == \"0\" ]; then\n",
                  "    yum -y groupinstall development && yum -y install curl wget\n",
                  "  fi\n",
                  "  if [ \"${apt}\" == \"0\" ]; then\n",
                  "    apt-cache search build-essential; apt-get clean; apt-get update; apt-get -y install build-essential curl wget\n",
                  "  fi\n",
                  "  which cfn-init 2>/dev/null || ( curl -s -L -o /tmp/aws-cfn-bootstrap-latest.tar.gz https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz; easy_install -U /tmp/aws-cfn-bootstrap-latest.tar.gz)\n",
                  "  mkdir -p /etc/chef && chown -R root:root /etc/chef\n",
                  "  curl -L https://www.chef.io/chef/install.sh | bash -s -- -v ${chef_version}\n",
                  "  /opt/chef/embedded/bin/gem install --no-rdoc --no-ri ridley:${ridley_version} berkshelf:${berkshelf_version}\n",
                  "  curl -s -L -o /etc/chef/cfncluster-cookbook.tgz ${cookbook_url}\n",
                  "  curl -s -L -o /etc/chef/cfncluster-cookbook.tgz.date ${cookbook_url}.date\n",
                  "  curl -s -L -o /etc/chef/cfncluster-cookbook.tgz.md5 ${cookbook_url}.md5\n",
                  "  mkdir /opt/cfncluster && echo ${cfncluster_version} | tee /opt/cfncluster/.bootstrapped\n",
                  "}\n",
                  "proxy=",
                  {
                    "Ref": "ProxyServer"
                  },
                  "\n",
                  "custom_cookbook=",
                  {
                    "Ref": "CustomChefCookbook"
                  },
                  "\n",
                  "if [ \"${proxy}\" != \"NONE\" ]; then\n",
                  "  proxy_args=\"--http-proxy=${proxy} --https-proxy=${proxy}\"\n",
                  "  proxy_host=$(echo \"${proxy}\" | awk -F/ '{print $3}' | cut -d: -f1)\n",
                  "  proxy_port=$(echo \"${proxy}\" | awk -F/ '{print $3}' | cut -d: -f2)\n",
                  "  export http_proxy=${proxy}; export https_proxy=${http_proxy}\n",
                  "  export HTTP_PROXY=${proxy}; export HTTPS_PROXY=${http_proxy}\n",
                  "  export no_proxy=169.254.169.254; export NO_PROXY=169.254.169.254\n",
                  "  echo -e \"export http_proxy=${proxy}; export https_proxy=${http_proxy}\nexport HTTP_PROXY=${proxy}; export HTTPS_PROXY=${http_proxy}\nexport no_proxy=169.254.169.254; export NO_PROXY=169.254.169.254\n\" >/tmp/proxy.sh\n",
                  "  echo -e \"[Boto]\nproxy = ${proxy_host}\nproxy_port = ${proxy_port}\n\" >/etc/boto.cfg\n",
                  "else\n",
                  "  proxy_args=\"\"\n",
                  "  touch /tmp/proxy.sh\n",
                  "fi\n",
                  "if [ \"${custom_cookbook}\" != \"NONE\" ]; then\n",
                  "  cookbook_url=${custom_cookbook}\n",
                  "else\n",
                  "  if [ \"",
                  {
                    "Ref": "AWS::Region"
                  },
                  "\" == \"us-east-1\" ]; then\n",
                  "    s3_prefix=s3\n",
                  "  else\n",
                  "    s3_prefix=s3-",
                  {
                    "Ref": "AWS::Region"
                  },
                  "\n",
                  "  fi\n",
                  "  cookbook_url=https://${s3_prefix}.amazonaws.com/cfncluster-resources-",
                  {
                    "Ref": "AWS::Region"
                  },
                  "/cookbooks/",
                  {
                    "Fn::FindInMap": [
                      "CfnClusterVersions",
                      "default",
                      "cookbook"
                    ]
                  },
                  ".tgz\n",
                  "fi\n",
                  "export PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/opt/aws/bin\n",
                  "export cfncluster_version=",
                  {
                    "Fn::FindInMap": [
                      "CfnClusterVersions",
                      "default",
                      "cfncluster"
                    ]
                  },
                  "\n",
                  "export cookbook_version=",
                  {
                    "Fn::FindInMap": [
                      "CfnClusterVersions",
                      "default",
                      "cookbook"
                    ]
                  },
                  "\n",
                  "export chef_version=",
                  {
                    "Fn::FindInMap": [
                      "CfnClusterVersions",
                      "default",
                      "chef"
                    ]
                  },
                  "\n",
                  "export ridley_version=",
                  {
                    "Fn::FindInMap": [
                      "CfnClusterVersions",
                      "default",
                      "ridley"
                    ]
                  },
                  "\n",
                  "export berkshelf_version=",
                  {
                    "Fn::FindInMap": [
                      "CfnClusterVersions",
                      "default",
                      "berkshelf"
                    ]
                  },
                  "\n",
                  "if [ -f /opt/cfncluster/.bootstrapped ]; then\n",
                  "  installed_version=$(cat /opt/cfncluster/.bootstrapped)\n",
                  "  if [ \"${cfncluster_version}\" != \"${installed_version}\" ]; then\n",
                  "    bootstrap_instance\n",
                  "  fi\n",
                  "else\n",
                  "  bootstrap_instance\n",
                  "fi\n",
                  "mkdir /tmp/cookbooks\n",
                  "cd /tmp/cookbooks\n",
                  "curl -v -L -o /etc/chef/cfncluster-cookbook.tgz -z \"$(cat /etc/chef/cfncluster-cookbook.tgz.date)\" ${cookbook_url}\n",
                  "tar -xzf /etc/chef/cfncluster-cookbook.tgz\n",
                  "cd /tmp\n",
                  "# Call CloudFormation\n",
                  "cfn-init ${proxy_args} -s ",
                  {
                    "Ref": "AWS::StackName"
                  },
                  " -v -c default -r ComputeServerLaunchTemplate --region ",
                  {
                    "Ref": "AWS::Region"
                  },
                  " || error_exit 'Failed to run cfn-init. If --norollback was specified, check /var/log/cfn-init.log and /var/log/cloud-init-output.log.'\n",
                  "cfn-signal ${proxy_args} --exit-code=0 --reason=\"MasterServer setup complete\" --stack=",
                  {
                    "Ref": "AWS::StackName"
                  },
                  " --resource=ComputeFleet --region=",
                  {
                    "Ref": "AWS::Region"
                  },
                  "\n",
                  "# End of file\n",
                  "--==BOUNDARY==\n"
                ]
              ]
            }
          }
        }
      },
      "Condition": "CreateLaunchTemplate",
      "Metadata": {
        "Comment": "cfncluster Compute server",
        "AWS::CloudFormation::Init": {
          "configSets": {
            "default": [
              "deployConfigFiles",
              "getCookbooks",
              "chefPrepEnv",
              "shellRunPreInstall",
              "chefConfig",
              "shellRunPostInstall",
              "shellForkClusterReadyInstall",
              "signalComputeReady"
            ]
          },
          "deployConfigFiles": {
            "files": {
              "/tmp/dna.json": {
                "mode": "000644",
                "owner": "root",
                "group": "root",
                "content": {
                  "cfncluster": {
                    "stack_name": {
                      "Ref": "AWS::StackName"
                    },
                    "cfn_preinstall": {
                      "Ref": "PreInstallScript"
                    },
                    "cfn_preinstall_args": {
                      "Ref": "PreInstallArgs"
                    },
                    "cfn_postinstall": {
                      "Ref": "PostInstallScript"
                    },
                    "cfn_postinstall_args": {
                      "Ref": "PostInstallArgs"
                    },
                    "cfn_region": {
                      "Ref": "AWS::Region"
                    },
                    "cfn_scheduler": {
                      "Ref": "Scheduler"
                    },
                    "cfn_scaledown_idletime": {
                      "Ref": "ScaleDownIdleTime"
                    },
                    "cfn_encrypted_ephemeral": {
                      "Ref": "EncryptedEphemeral"
                    },
                    "cfn_ephemeral_dir": {
                      "Ref": "EphemeralDir"
                    },
                    "cfn_shared_dir": {
                      "Ref": "SharedDir"
                    },
                    "cfn_proxy": {
                      "Ref": "ProxyServer"
                    },
                    "cfn_sqs_queue": {
                      "Ref": "SQS"
                    },
                    "cfn_master": {
                      "Fn::GetAtt": [
                        "MasterServer",
                        "PrivateDnsName"
                      ]
                    },
                    "cfn_node_type": "ComputeFleet",
                    "cfn_cluster_user": {
                      "Fn::FindInMap": [
                        "OSFeatures",
                        {
                          "Ref": "BaseOS"
                        },
                        "User"
                      ]
                    }
                  },
                  "run_list": {
                    "Fn::If": [
                      "UseCustomRunList",
                      {
                        "Ref": "CustomChefRunList"
                      },
                      {
                        "Fn::Join": [
                          "",
                          [
                            "recipe[cfncluster::",
                            {
                              "Ref": "Scheduler"
                            },
                            "_config]"
                          ]
                        ]
                      }
                    ]
                  }
                }
              },
              "/etc/chef/client.rb": {
                "mode": "000644",
                "owner": "root",
                "group": "root",
                "content": {
                  "Fn::Join": [
                    "",
                    [
                      "cookbook_path ['/etc/chef/cookbooks']"
                    ]
                  ]
                }
              },
              "/tmp/extra.json": {
                "mode": "000644",
                "owner": "root",
                "group": "root",
                "content": {
                  "Ref": "ExtraJson"
                }
              }
            },
            "commands": {
              "mkdir": {
                "command": "mkdir -p /etc/chef/ohai/hints"
              },
              "touch": {
                "command": "touch /etc/chef/ohai/hints/ec2.json"
              },
              "jq": {
                "command": "/usr/local/bin/jq --argfile f1 /tmp/dna.json --argfile f2 /tmp/extra.json -n '$f1 + $f2 | .cfncluster = $f1.cfncluster + $f2.cfncluster' > /etc/chef/dna.json || ( echo \"jq not installed\"; cp /tmp/dna.json /etc/chef/dna.json )"
              }
            }
          },
          "getCookbooks": {
            "commands": {
              "berk": {
                "command": ". /tmp/proxy.sh; for d in `ls /tmp/cookbooks`; do cd /tmp/cookbooks/$d;LANG=en_US.UTF-8 /opt/chef/embedded/bin/berks vendor /etc/chef/cookbooks --delete; done ",
                "cwd": "/tmp/cookbooks",
                "env": {
                  "HOME": "/tmp"
                }
              }
            }
          },
          "chefPrepEnv": {
            "commands": {
              "chef": {
                "command": "chef-client --local-mode --config /etc/chef/client.rb --log_level auto --force-formatter --no-color --chef-zero-port 8889 --json-attributes /etc/chef/dna.json --override-runlist cfncluster::_prep_env",
                "cwd": "/etc/chef"
              }
            }
          },
          "shellRunPreInstall": {
            "commands": {
              "runpreinstall": {
                "command": "/opt/cfncluster/scripts/fetch_and_run -preinstall"
              }
            }
          },
          "chefConfig": {
            "commands": {
              "chef": {
                "command": "chef-client --local-mode --config /etc/chef/client.rb --log_level auto --force-formatter --no-color --chef-zero-port 8889 --json-attributes /etc/chef/dna.json",
                "cwd": "/etc/chef"
              }
            }
          },
          "shellRunPostInstall": {
            "commands": {
              "runpostinstall": {
                "command": "/opt/cfncluster/scripts/fetch_and_run -postinstall"
              }
            }
          },
          "shellForkClusterReadyInstall": {
            "commands": {
              "clusterreadyinstall": {
                "command": "/opt/cfncluster/scripts/fetch_and_run -clusterreadyinstall"
              }
            }
          },
          "signalComputeReady": {
            "commands": {
              "compute_ready": {
                "command": "/opt/cfncluster/scripts/compute_ready"
              }
            }
          }
        },
        "AWS::CloudFormation::Designer": {
          "id": "d3204db6-c821-400d-bf31-6afd5739923c"
        }
      }
    },
    "ComputeSubnet": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {
          "Ref": "VPCId"
        },
        "CidrBlock": {
          "Ref": "ComputeSubnetCidr"
        },
        "Tags": [
          {
            "Key": "Network",
            "Value": "ComputeSubnet"
          }
        ],
        "AvailabilityZone": {
          "Ref": "AvailabilityZone"
        }
      },
      "Condition": "CreateComputeSubnetForCompute",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "bb5a532f-bb43-472a-9965-c4054cd61cc9"
        }
      }
    },
    "ComputeRouteTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {
          "Ref": "VPCId"
        },
        "Tags": [
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "Network",
            "Value": "ComputeSubnet"
          }
        ]
      },
      "Condition": "CreateComputeSubnetForCompute",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "0824f592-a72b-4bb5-8c67-4ce6df509cdd"
        }
      }
    },
    "ComputeRoute": {
      "Type": "AWS::EC2::Route",
      "Properties": {
        "RouteTableId": {
          "Ref": "ComputeRouteTable"
        },
        "DestinationCidrBlock": "0.0.0.0/0",
        "NetworkInterfaceId": {
          "Ref": "MasterENI"
        }
      },
      "Condition": "CreateComputeSubnetForCompute",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "596ddc76-44b9-4747-921c-c000c5b636c0"
        }
      }
    },
    "ComputeSubnetRouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": {
          "Ref": "ComputeSubnet"
        },
        "RouteTableId": {
          "Ref": "ComputeRouteTable"
        }
      },
      "Condition": "CreateComputeSubnetForCompute",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "9dd9772e-03a3-4983-b28e-a52ac42f0ffe"
        }
      }
    },
    "MasterSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Enable access to the Master host",
        "VpcId": {
          "Ref": "VPCId"
        },
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "22",
            "ToPort": "22",
            "CidrIp": {
              "Ref": "AccessFrom"
            }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "80",
            "ToPort": "80",
            "CidrIp": {
              "Ref": "AccessFrom"
            }
          }
        ]
      },
      "Condition": "CreateSecurityGroups",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "2904615e-c0ad-4325-b0c5-b9ea7c482b4e"
        }
      }
    },
    "MasterSecurityGroupIngress": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "IpProtocol": "-1",
        "FromPort": "0",
        "ToPort": "65535",
        "SourceSecurityGroupId": {
          "Ref": "ComputeSecurityGroup"
        },
        "GroupId": {
          "Ref": "MasterSecurityGroup"
        }
      },
      "Condition": "CreateSecurityGroups",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "466554d3-0e10-4ae4-bfee-51b0aadbf923"
        }
      }
    },
    "ComputeSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Allow access to resources in subnets behind front",
        "VpcId": {
          "Ref": "VPCId"
        },
        "SecurityGroupIngress": [
          {
            "SourceSecurityGroupId": {
              "Ref": "MasterSecurityGroup"
            },
            "IpProtocol": "-1",
            "FromPort": "0",
            "ToPort": "65535"
          }
        ]
      },
      "Condition": "CreateSecurityGroups",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "619070e4-82e5-445a-93a0-4795ff69d61c"
        }
      }
    },
    "ComputeSecurityGroupIngress": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "IpProtocol": "-1",
        "FromPort": "0",
        "ToPort": "65535",
        "SourceSecurityGroupId": {
          "Ref": "ComputeSecurityGroup"
        },
        "GroupId": {
          "Ref": "ComputeSecurityGroup"
        }
      },
      "Condition": "CreateSecurityGroups"
    },
    "MasterENI": {
      "Type": "AWS::EC2::NetworkInterface",
      "Properties": {
        "Description": "cfncluster Master Server",
        "SubnetId": {
          "Ref": "MasterSubnetId"
        },
        "SourceDestCheck": "false",
        "GroupSet": [
          {
            "Fn::If": [
              "CreateSecurityGroups",
              {
                "Ref": "MasterSecurityGroup"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          },
          {
            "Fn::If": [
              "AddAdditionalSG",
              {
                "Ref": "AdditionalSG"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          },
          {
            "Fn::If": [
              "UseExistingSecurityGroup",
              {
                "Ref": "VPCSecurityGroupId"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "45360a4f-64aa-49f8-b016-78fe5ed86819"
        }
      }
    },
    "AdditionalCfnStack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": {
          "Ref": "AdditionalCfnTemplate"
        }
      },
      "Condition": "CreateSubStack"
    },
    "SharedVolume": {
      "Type": "AWS::EC2::Volume",
      "Properties": {
        "AvailabilityZone": {
          "Ref": "AvailabilityZone"
        },
        "VolumeType": {
          "Ref": "VolumeType"
        },
        "Size": {
          "Fn::If": [
            "UseEBSSnapshot",
            {
              "Ref": "AWS::NoValue"
            },
            {
              "Ref": "VolumeSize"
            }
          ]
        },
        "SnapshotId": {
          "Fn::If": [
            "UseEBSSnapshot",
            {
              "Ref": "EBSSnapshotId"
            },
            {
              "Ref": "AWS::NoValue"
            }
          ]
        },
        "Iops": {
          "Fn::If": [
            "UseEBSPIOPS",
            {
              "Ref": "VolumeIOPS"
            },
            {
              "Ref": "AWS::NoValue"
            }
          ]
        },
        "Encrypted": {
          "Fn::If": [
            "UseEBSEncryption",
            {
              "Ref": "EBSEncryption"
            },
            {
              "Ref": "AWS::NoValue"
            }
          ]
        },
        "KmsKeyId": {
          "Fn::If": [
            "UseEBSKMSKey",
            {
              "Ref": "EBSKMSKeyId"
            },
            {
              "Ref": "AWS::NoValue"
            }
          ]
        }
      },
      "Condition": "CreateEBSVolume",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "c8d3da13-fd27-4377-b606-0f41728c17e1"
        }
      }
    },
    "AssociateEIP": {
      "Type": "AWS::EC2::EIPAssociation",
      "Properties": {
        "AllocationId": {
          "Fn::GetAtt": [
            "MasterEIP",
            "AllocationId"
          ]
        },
        "NetworkInterfaceId": {
          "Ref": "MasterENI"
        }
      },
      "Condition": "MasterPublicIp",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "e9ac6c41-8110-49b9-a92c-de57be8a292a"
        }
      }
    },
    "DynamicPlacementGroup": {
      "Type": "AWS::EC2::PlacementGroup",
      "Properties": {
        "Strategy": "cluster"
      },
      "Condition": "CreatePlacementGroup",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "ee5f3006-419e-4786-b527-e9503a662e5e"
        }
      }
    }
  },
  "Outputs": {
    "ClusterUser": {
      "Description": "Username to login to Master host",
      "Value": {
        "Fn::FindInMap": [
          "OSFeatures",
          {
            "Ref": "BaseOS"
          },
          "User"
        ]
      }
    },
    "MasterPrivateIP": {
      "Description": "Private IP Address of the Master host",
      "Value": {
        "Fn::GetAtt": [
          "MasterServer",
          "PrivateIp"
        ]
      }
    },
    "MasterPublicIP": {
      "Description": "Public IP Address of the Master host",
      "Value": {
        "Fn::GetAtt": [
          "MasterServer",
          "PublicIp"
        ]
      },
      "Condition": "MasterPublicIp"
    },
    "GangliaPrivateURL": {
      "Description": "Private URL to access Ganglia",
      "Value": {
        "Fn::Join": [
          "",
          [
            "http://",
            {
              "Fn::GetAtt": [
                "MasterServer",
                "PrivateIp"
              ]
            },
            "/ganglia/"
          ]
        ]
      }
    },
    "GangliaPublicURL": {
      "Description": "Public URL to access Ganglia",
      "Value": {
        "Fn::Join": [
          "",
          [
            "http://",
            {
              "Fn::GetAtt": [
                "MasterServer",
                "PublicIp"
              ]
            },
            "/ganglia/"
          ]
        ]
      },
      "Condition": "MasterPublicIp"
    }
  }
}
