{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "AWS ParallelCluster Template. Version: aws-parallelcluster-2.11.6",
  "Parameters": {
    "KeyName": {
      "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instances using the default cluster user.",
      "Type": "String",
      "Default": "NONE"
    },
    "MasterInstanceType": {
      "Description": "Head node EC2 instance type",
      "Type": "String",
      "ConstraintDescription": "Must be a valid EC2 instance type, with support for HVM."
    },
    "ComputeInstanceType": {
      "Description": "ComputeFleet EC2 instance type",
      "Type": "String",
      "Default": "NONE",
      "ConstraintDescription": "Must be a valid EC2 instance type, with support for HVM."
    },
    "MinSize": {
      "Description": "Initial number of compute EC2 instances / vCpus to launch within the cluster.",
      "Type": "Number",
      "Default": 0
    },
    "DesiredSize": {
      "Description": "Desired number of compute EC2 instances / vCpus to launch within the cluster.",
      "Type": "Number",
      "Default": 0
    },
    "MaxSize": {
      "Description": "Maximum number of compute EC2 instances / vCpus to launch within the cluster.",
      "Type": "Number",
      "Default": 0
    },
    "ComputeSubnetId": {
      "Description": "ID of the Subnet you want to provision the Compute Servers into",
      "Type": "String",
      "Default": "NONE",
      "AllowedPattern": "(NONE|^subnet-[0-9a-z]{8}$|^subnet-[0-9a-z]{17}$)"
    },
    "SpotPrice": {
      "Description": "Spot bid price for the ComputeFleet AutoScaling Group when the ClusterType = \"spot\". When awsbatch is the scheduler, this is spot bid percentage.",
      "Type": "Number",
      "Default": "0"
    },
    "ClusterType": {
      "Description": "Type of cluster to launch. Can either be \"ondemand\" or \"spot\". Choosing \"spot\" will cause the ComputeFleet AutoScaling group to launch EC2 Spot instances. Default value is \"ondemand\".",
      "Type": "String",
      "Default": "ondemand",
      "ConstraintDescription": "Must be a supported cluster type: ondemand, spot",
      "AllowedValues": [
        "ondemand",
        "spot"
      ]
    },
    "ProxyServer": {
      "Description": "hostname and port of HTTP proxy server for cfn-init, boto and yum i.e. proxy.example.com:8080",
      "Type": "String",
      "Default": "NONE"
    },
    "VolumeSize": {
      "Description": "Comma delimited list of size of EBS volume in GB, if creating a new one",
      "Type": "String",
      "Default": "NONE,NONE,NONE,NONE,NONE"
    },
    "VolumeType": {
      "Description": "Comma delimited list of type of volume to create either new or from snapshot",
      "Type": "String",
      "Default": "gp2,gp2,gp2,gp2,gp2",
      "ConstraintDescription": "must be a supported volume type: standard, io1, io2, gp2, gp3, st1, sc1",
      "AllowedPattern": "^(NONE|standard|io1|io2|gp2|gp3|st1|sc1)((,|, )(NONE|standard|io1|io2|gp2|gp3|st1|sc1)){4}$"
    },
    "MasterSubnetId": {
      "Description": "ID of the Subnet you want to provision the head node into",
      "Type": "AWS::EC2::Subnet::Id"
    },
    "AvailabilityZone": {
      "Description": "Availability Zone the cluster will launch into. THIS IS REQUIRED",
      "Type": "AWS::EC2::AvailabilityZone::Name"
    },
    "EBSSnapshotId": {
      "Description": "Comma delimited list of Id of EBS snapshot if using snapshot as source for volume",
      "Type": "String",
      "Default": "NONE,NONE,NONE,NONE,NONE",
      "AllowedPattern": "^(NONE|snap-[0-9a-z]{8}|snap-[0-9a-z]{17})((,|, )(NONE|snap-[0-9a-z]{8}|snap-[0-9a-z]{17})){4}$"
    },
    "CustomAMI": {
      "Description": "ID of a Custom AMI, to use instead of published AMI's",
      "Type": "String",
      "Default": "NONE",
      "AllowedPattern": "(NONE|^ami-[0-9a-z]{8}$|^ami-[0-9a-z]{17}$)"
    },
    "VPCId": {
      "Description": "ID of the VPC you want to provision cluster into. Only used with UseVPCBase=false",
      "Type": "AWS::EC2::VPC::Id"
    },
    "AccessFrom": {
      "Description": "Lockdown SSH/HTTP access (default can be accessed from anywhere)",
      "Type": "String",
      "MinLength": "9",
      "MaxLength": "18",
      "Default": "0.0.0.0/0",
      "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription": "must be a valid CIDR range of the form x.x.x.x/x."
    },
    "ComputeSubnetCidr": {
      "Description": "CIDR(s) for new backend subnet(s) i.e. 10.0.100.0/24. This is a comma-delimited list and can support multiple CIDR ranges for a multi-AZ cluster. The order and length of this list MUST match the AvailabilityZones parameter.",
      "Type": "String",
      "ConstraintDescription": "must be a valid CIDR range of the form x.x.x.x/x.",
      "AllowedPattern": "(NONE|(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2}))",
      "Default": "NONE"
    },
    "UsePublicIps": {
      "Description": "Boolean flag to use public IP's for instances. If false, the VPC must be correctly setup to use NAT for all traffic.",
      "Type": "String",
      "Default": "true",
      "ConstraintDescription": "true/false",
      "AllowedValues": [
        "true",
        "false"
      ]
    },
    "VolumeIOPS": {
      "Description": "Comma delimited list of number of IOPS for volume type io1, io2 and gp3. Not used for other volume types.",
      "Type": "String",
      "Default": "NONE,NONE,NONE,NONE,NONE"
    },
    "VolumeThroughput": {
      "Description": "Comma delimited list of number of Throughtput for volume type gp3. Not used for other volume types.",
      "Type": "String",
      "Default": "125,125,125,125,125"
    },
    "PreInstallScript": {
      "Description": "Preinstall script URL. This is run before any host configuration.",
      "Type": "String",
      "Default": "NONE"
    },
    "PostInstallScript": {
      "Description": "Postinstall script URL. This is run before any host configuration.",
      "Type": "String",
      "Default": "NONE"
    },
    "S3ReadResource": {
      "Description": "S3 resource with read access from AWS ParallelCluster nodes",
      "Type": "String",
      "Default": "NONE"
    },
    "S3ReadWriteResource": {
      "Description": "Addtional policy document to be added to EC2 IAM role created and assigned to all nodes.",
      "Type": "String",
      "Default": "NONE"
    },
    "Placement": {
      "Description": "Type of placement requird in AWS ParallelCluster, it can either be cluster or compute.",
      "Type": "String",
      "Default": "compute",
      "AllowedValues": [
        "cluster",
        "compute"
      ]
    },
    "PlacementGroup": {
      "Description": "The name of an existing placement group",
      "Type": "String",
      "Default": "NONE"
    },
    "EncryptedEphemeral": {
      "Description": "Boolean flag to encrypt local ephemeral drives. The keys are in-memory and non-recoverable.",
      "Type": "String",
      "Default": "false",
      "ConstraintDescription": "true/false",
      "AllowedValues": [
        "true",
        "false"
      ]
    },
    "PreInstallArgs": {
      "Description": "Preinstall script args passed to the preinstall script.",
      "Type": "String",
      "Default": "NONE"
    },
    "PostInstallArgs": {
      "Description": "Postinstall script args passed to the postinstall script.",
      "Type": "String",
      "Default": "NONE"
    },
    "EBSEncryption": {
      "Description": "Comma delimited list of boolean flag to use EBS encryption for /shared volume. (Not to be used for snapshots)",
      "Type": "String",
      "Default": "false,false,false,false,false",
      "ConstraintDescription": "true/false",
      "AllowedPattern": "^(NONE|true|false)((,|, )(NONE|true|false)){4}$"
    },
    "EphemeralDir": {
      "Description": "The path/mountpoint for the ephemeral drive",
      "Type": "String",
      "Default": "/scratch"
    },
    "BaseOS": {
      "Description": "Base OS type for cluster AMI",
      "Type": "String",
      "Default": "alinux2",
      "ConstraintDescription": "must be a supported base OS",
      "AllowedValues": [
        "centos7",
        "alinux2",
        "ubuntu1804",
        "ubuntu2004"
      ]
    },
    "Architecture": {
      "Description": "Architecture to use when selecting default AMIs",
      "Type": "String",
      "Default": "x86_64",
      "ConstraintDescription": "Must be either x86_64 or arm64",
      "AllowedValues": [
        "x86_64",
        "arm64"
      ]
    },
    "Scheduler": {
      "Description": "Cluster scheduler",
      "Type": "String",
      "Default": "slurm",
      "ConstraintDescription": "must be a supported scheduler",
      "AllowedValues": [
        "slurm",
        "awsbatch"
      ]
    },
    "SharedDir": {
      "Description": "The path/mountpoint for the shared drive",
      "Type": "String",
      "Default": "/shared"
    },
    "ClusterConfigMetadata": {
      "Description": "Cluster configuration metadata.",
      "Type": "String",
      "Default": "{}"
    },
    "AdditionalSG": {
      "Description": "Additional VPC security group to be added to instances. Defaults to NONE",
      "Type": "String",
      "Default": "NONE",
      "AllowedPattern": "(NONE|^sg-[0-9a-z]{8}$|^sg-[0-9a-z]{17}$)"
    },
    "CustomChefCookbook": {
      "Description": "URL of custom cookbook that will override the default. This will be unpacked and then dependencies resolved with Berkshelf.",
      "Type": "String",
      "Default": "NONE"
    },
    "ExtraJson": {
      "Description": "Extra json to be added to Chef dna.json",
      "Type": "String",
      "Default": "{}"
    },
    "EBSKMSKeyId": {
      "Description": "Comma delimited list of KMS ARN for customer created master key, will be used for EBS encryption",
      "Type": "String",
      "Default": "NONE,NONE,NONE,NONE,NONE"
    },
    "MasterRootVolumeSize": {
      "Description": "Size of head node EBS root volume in GB",
      "Type": "Number",
      "Default": "35",
      "MinValue": "35"
    },
    "ComputeRootVolumeSize": {
      "Description": "Size of ComputeFleet EBS root volume in GB",
      "Type": "Number",
      "Default": "35",
      "MinValue": "35"
    },
    "EC2IAMRoleName": {
      "Description": "Existing EC2 IAM role name",
      "Type": "String",
      "Default": "NONE"
    },
    "EC2IAMPolicies": {
      "Description": "Attach additional IAM Policies to the created Root Role",
      "Type": "CommaDelimitedList",
      "Default": "NONE"
    },
    "IAMLambdaRoleName": {
      "Description": "Existing IAM role name for Lambda functions",
      "Type": "String",
      "Default": "NONE"
    },
    "VPCSecurityGroupId": {
      "Description": "Existing VPC security group Id",
      "Type": "String",
      "Default": "NONE",
      "AllowedPattern": "(NONE|^sg-[0-9a-z]{8}$|^sg-[0-9a-z]{17}$)"
    },
    "EBSVolumeId": {
      "Description": "Comma delimited list of existing EBS volume Id",
      "Type": "String",
      "Default": "NONE,NONE,NONE,NONE,NONE",
      "AllowedPattern": "^(NONE|vol-[0-9a-z]{8}|vol-[0-9a-z]{17})((,|, )(NONE|vol-[0-9a-z]{8}|vol-[0-9a-z]{17})){4}$"
    },
    "AdditionalCfnTemplate": {
      "Description": "A second CloudFormation template to launch with the cluster",
      "Type": "String",
      "Default": "NONE"
    },
    "ResourcesS3Bucket": {
      "Description": "S3 bucket where resources needed by the stack are located. The bucket gets deleted on stack deletion if it is not user-provided.",
      "Type": "String"
    },
    "ArtifactS3RootDirectory": {
      "Description": "Root directory in S3 bucket where cluster artifacts are stored, i.e. cluster artifacts would be under {ResourcesS3Bucket}/{ArtifactS3RootDirectory}.",
      "Type": "String"
    },
    "RemoveBucketOnDeletion": {
      "Description": "Parameter to control if bucket is removed on cluster deletion. pcluster created buckets are alway removed, user provided buckets are kept.",
      "Type": "String"
    },
    "RAIDOptions": {
      "Description": "Comma Separated List of RAID related options, 9 parameters in total, [shared_dir,raid_type,num_of_raid_volumes,volume_type,volume_size,volume_iops,encrypted,ebs_kms_key_id,volume_throughput]",
      "Type": "String",
      "Default": "NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE",
      "AllowedPattern": "^(NONE|.+)(,|, )(NONE|\\d)(,|, )(NONE|\\d)(,|, )(NONE|standard|io1|io2|gp2|gp3|st1|sc1)(,|, )(NONE|\\d+)(,|, )(NONE|\\d+)(,|, )(NONE|true|false)(,|, )(NONE|.+)(,|, )(NONE|\\d+)$"
    },
    "NumberOfEBSVol": {
      "Description": "Number of EBS Volumes the user requested, up to 5",
      "Type": "Number",
      "Default": "1"
    },
    "FSXOptions": {
      "Description": "Comma separated list of FSx related options, 20 parameters in total, [shared_dir,fsx_fs_id,storage_capacity,fsx_kms_key_id,imported_file_chunk_size,export_path,import_path,weekly_maintenance_start_time,deployment_type,per_unit_storage_throughput,daily_automatic_backup_start_time,automatic_backup_retention_days,copy_tags_to_backups,fsx_backup_id,auto_import_policy,storage_type,drive_cache_type,existing_mount_name,existing_dns_name,data_compression_type]",
      "Type": "String",
      "Default": "NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE"
    },
    "EFSOptions": {
      "Description": "Comma separated list of EFS related options, 9 parameters in total, [shared_dir,efs_fs_id,performance_mode,efs_kms_key_id,provisioned_throughput,encrypted,throughput_mode,exists_valid_head_node_mt,exists_valid_compute_mt]",
      "Type": "String",
      "Default": "NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE"
    },
    "Cores": {
      "Description": "Comma seperated string of [head node cores], [compute cores], [head node instance type supports disabling hyperthreading via CPU options], [compute instance type supports disabling hyperthreading via CPU options].",
      "Type": "CommaDelimitedList",
      "Default": "NONE,NONE,NONE,NONE"
    },
    "EFA": {
      "Description": "Enable EFA on the compute nodes, enable_efa = compute",
      "Type": "String",
      "Default": "NONE"
    },
    "DCVOptions": {
      "Description": "Comma separated list of NICE DCV related options, 3 parameters in total, [enabled,port,access_from]",
      "Type": "String",
      "Default": "NONE,NONE,NONE"
    },
    "IntelHPCPlatform": {
      "Description": "Enable Intel HPC Platform packages.",
      "Type": "String",
      "AllowedValues": [
        "true",
        "false"
      ]
    },
    "CWLogOptions": {
      "Description": "Comma separated list of CloudWatch logging, 2 parameters in total, [enabled, retention_days]",
      "Type": "String",
      "Default": "true,14"
    },
    "NetworkInterfacesCount": {
      "Description": "Comma separated string of [head node network interfaces], [compute network interfaces].",
      "Type": "CommaDelimitedList",
      "Default": "1,1"
    },
    "InstanceTypesData": {
      "Description": "Json string with information about instance types, as returned from EC2 describe-instance-types",
      "Type": "String",
      "Default": "{}"
    }
  },
  "Conditions": {
    "CreateEFSSubstack": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "0",
                {
                  "Fn::Split": [
                    ",",
                    {
                      "Ref": "EFSOptions"
                    }
                  ]
                }
              ]
            },
            "NONE"
          ]
        }
      ]
    },
    "CreateRAIDSubstack": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            "NONE",
            {
              "Fn::Select": [
                "0",
                {
                  "Fn::Split": [
                    ",",
                    {
                      "Ref": "RAIDOptions"
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    "CreateFSXSubstack": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "0",
                {
                  "Fn::Split": [
                    ",",
                    {
                      "Ref": "FSXOptions"
                    }
                  ]
                }
              ]
            },
            "NONE"
          ]
        }
      ]
    },
    "UseSpotPrice": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "SpotPrice"
            },
            "0"
          ]
        }
      ]
    },
    "CreateComputeSubnetForCompute": {
      "Fn::And": [
        {
          "Fn::Equals": [
            {
              "Ref": "ComputeSubnetId"
            },
            "NONE"
          ]
        },
        {
          "Fn::Not": [
            {
              "Fn::Equals": [
                {
                  "Ref": "ComputeSubnetCidr"
                },
                "NONE"
              ]
            }
          ]
        }
      ]
    },
    "UseMasterSubnetForCompute": {
      "Fn::Or": [
        {
          "Fn::And": [
            {
              "Fn::Equals": [
                {
                  "Ref": "ComputeSubnetId"
                },
                "NONE"
              ]
            },
            {
              "Fn::Equals": [
                {
                  "Ref": "ComputeSubnetCidr"
                },
                "NONE"
              ]
            }
          ]
        },
        {
          "Fn::Equals": [
            {
              "Ref": "ComputeSubnetId"
            },
            {
              "Ref": "MasterSubnetId"
            }
          ]
        }
      ]
    },
    "UseCustomAMI": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "CustomAMI"
            },
            "NONE"
          ]
        }
      ]
    },
    "MasterPublicIp": {
      "Fn::Equals": [
        {
          "Ref": "UsePublicIps"
        },
        "true"
      ]
    },
    "ComputePublicIps": {
      "Fn::And": [
        {
          "Fn::Equals": [
            {
              "Ref": "UsePublicIps"
            },
            "true"
          ]
        },
        {
          "Condition": "UseMasterSubnetForCompute"
        }
      ]
    },
    "UseS3ReadPolicy": {
      "Fn::And": [
        {
          "Fn::Not": [
            {
              "Fn::Equals": [
                {
                  "Ref": "S3ReadResource"
                },
                "NONE"
              ]
            }
          ]
        },
        {
          "Condition": "CreateEC2IAMRole"
        }
      ]
    },
    "UsePlacementGroup": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "PlacementGroup"
            },
            "NONE"
          ]
        }
      ]
    },
    "UseClusterPlacement": {
      "Fn::And": [
        {
          "Fn::Equals": [
            {
              "Ref": "Placement"
            },
            "cluster"
          ]
        },
        {
          "Condition": "UsePlacementGroup"
        }
      ]
    },
    "UseS3ReadWritePolicy": {
      "Fn::And": [
        {
          "Fn::Not": [
            {
              "Fn::Equals": [
                {
                  "Ref": "S3ReadWriteResource"
                },
                "NONE"
              ]
            }
          ]
        },
        {
          "Condition": "CreateEC2IAMRole"
        }
      ]
    },
    "AddAdditionalSG": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AdditionalSG"
            },
            "NONE"
          ]
        }
      ]
    },
    "UseEC2IAMRole": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "EC2IAMRoleName"
            },
            "NONE"
          ]
        }
      ]
    },
    "UseEC2IAMPolicies": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "0",
                {
                  "Ref": "EC2IAMPolicies"
                }
              ]
            },
            "NONE"
          ]
        }
      ]
    },
    "CreateEC2IAMRole": {
      "Fn::Equals": [
        {
          "Ref": "EC2IAMRoleName"
        },
        "NONE"
      ]
    },
    "CreateIAMLambdaRole": {
      "Fn::Equals": [
        {
          "Ref": "IAMLambdaRoleName"
        },
        "NONE"
      ]
    },
    "UseExistingSecurityGroup": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "VPCSecurityGroupId"
            },
            "NONE"
          ]
        }
      ]
    },
    "CreateSecurityGroups": {
      "Fn::Equals": [
        {
          "Ref": "VPCSecurityGroupId"
        },
        "NONE"
      ]
    },
    "CreateSubStack": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AdditionalCfnTemplate"
            },
            "NONE"
          ]
        }
      ]
    },
    "CreatePlacementGroup": {
      "Fn::And": [
        {
          "Fn::Equals": [
            {
              "Ref": "PlacementGroup"
            },
            "DYNAMIC"
          ]
        },
        {
          "Condition": "UsePlacementGroup"
        },
        {
          "Fn::Not": [
            {
              "Condition": "CreateHITSubstack"
            }
          ]
        }
      ]
    },
    "CreateHITSubstack": {
      "Fn::Equals": [
        {
          "Ref": "Scheduler"
        },
        "slurm"
      ]
    },
    "CreateAWSBatchStack": {
      "Fn::Equals": [
        {
          "Ref": "Scheduler"
        },
        "awsbatch"
      ]
    },
    "EnableDCV": {
      "Fn::Equals": [
        {
          "Fn::Select": [
            "0",
            {
              "Fn::Split": [
                ",",
                {
                  "Ref": "DCVOptions"
                }
              ]
            }
          ]
        },
        "master"
      ]
    },
    "UseArmAMIs": {
      "Fn::Equals": [
        {
          "Ref": "Architecture"
        },
        "arm64"
      ]
    },
    "UseProvidedResourcesS3Bucket": {
      "Fn::Equals": [
        {
          "Ref": "RemoveBucketOnDeletion"
        },
        "False"
      ]
    }
  },
  "Mappings": {
    "AWSRegionOS2AMIarm64": {
      "af-south-1": {
        "alinux2": "ami-0adc172bbe578cdf2",
        "centos7": "UNSUPPORTED",
        "ubuntu1804": "ami-0c25becd7bca5e854",
        "ubuntu2004": "ami-0792f5646ae4cf35d"
      },
      "ap-east-1": {
        "alinux2": "ami-0c55c4e6835d2d859",
        "centos7": "UNSUPPORTED",
        "ubuntu1804": "ami-08f7eb01bf46814fd",
        "ubuntu2004": "ami-0fb96dce3ef5cc297"
      },
      "ap-northeast-1": {
        "alinux2": "ami-00944312a2439a3a9",
        "centos7": "UNSUPPORTED",
        "ubuntu1804": "ami-04b5074a674382970",
        "ubuntu2004": "ami-084a4cf557c1c8d42"
      },
      "ap-northeast-2": {
        "alinux2": "ami-0f92792df6fb2c7d6",
        "centos7": "UNSUPPORTED",
        "ubuntu1804": "ami-0679f9e31b5e65385",
        "ubuntu2004": "ami-05b6a71cfb6a61ed1"
      },
      "ap-northeast-3": {
        "alinux2": "UNSUPPORTED",
        "centos7": "UNSUPPORTED",
        "ubuntu1804": "UNSUPPORTED",
        "ubuntu2004": "UNSUPPORTED"
      },
      "ap-south-1": {
        "alinux2": "ami-0802586f06308523e",
        "centos7": "UNSUPPORTED",
        "ubuntu1804": "ami-07431a30c652f4bf7",
        "ubuntu2004": "ami-0af380d37610b60ae"
      },
      "ap-southeast-1": {
        "alinux2": "ami-0db5bcfcb2d706d00",
        "centos7": "UNSUPPORTED",
        "ubuntu1804": "ami-0ed3daefdb1b7e7b4",
        "ubuntu2004": "ami-07f0cf69cd3e8e6e3"
      },
      "ap-southeast-2": {
        "alinux2": "ami-03f55ae542ba67f24",
        "centos7": "UNSUPPORTED",
        "ubuntu1804": "ami-0448cd3ee89e69145",
        "ubuntu2004": "ami-0aa678972bb17e1b8"
      },
      "ca-central-1": {
        "alinux2": "ami-08f42f0fa48cea20b",
        "centos7": "UNSUPPORTED",
        "ubuntu1804": "ami-0fea6435df83be923",
        "ubuntu2004": "ami-01c5397aa821f05b7"
      },
      "cn-north-1": {
        "alinux2": "ami-02c7ee8da41ffb98a",
        "centos7": "UNSUPPORTED",
        "ubuntu1804": "ami-0e086d8f8a04d643f",
        "ubuntu2004": "ami-0a0d4a7836c493a97"
      },
      "cn-northwest-1": {
        "alinux2": "ami-04103e41135d441f1",
        "centos7": "UNSUPPORTED",
        "ubuntu1804": "ami-035e4020c9e07773b",
        "ubuntu2004": "ami-0902c85d9cf158bcb"
      },
      "eu-central-1": {
        "alinux2": "ami-0904b6987ff4c6832",
        "centos7": "UNSUPPORTED",
        "ubuntu1804": "ami-00e08209ea90954ff",
        "ubuntu2004": "ami-06aae8ecd9add5019"
      },
      "eu-north-1": {
        "alinux2": "ami-0cfec8bb40e617af4",
        "centos7": "UNSUPPORTED",
        "ubuntu1804": "ami-04dfd1e397b8b1d10",
        "ubuntu2004": "ami-0a5454833421dc87f"
      },
      "eu-south-1": {
        "alinux2": "ami-052072833a513ef10",
        "centos7": "UNSUPPORTED",
        "ubuntu1804": "ami-071197d5df20c248c",
        "ubuntu2004": "ami-0091f40628f182149"
      },
      "eu-west-1": {
        "alinux2": "ami-0917fdbb9d3d0b2df",
        "centos7": "UNSUPPORTED",
        "ubuntu1804": "ami-0b303f67eb3873ba9",
        "ubuntu2004": "ami-0a650ecfcefa33942"
      },
      "eu-west-2": {
        "alinux2": "ami-080e855e1ca068e2a",
        "centos7": "UNSUPPORTED",
        "ubuntu1804": "ami-03929e84e7d043970",
        "ubuntu2004": "ami-0cdcc00bcc8fd9ed5"
      },
      "eu-west-3": {
        "alinux2": "ami-068406c06f582a9b9",
        "centos7": "UNSUPPORTED",
        "ubuntu1804": "ami-0120961c26c69e6b4",
        "ubuntu2004": "ami-08ece2eabf5f04752"
      },
      "me-south-1": {
        "alinux2": "ami-0ee9b63e2cf04b89b",
        "centos7": "UNSUPPORTED",
        "ubuntu1804": "ami-0c7f13d47ba8d4277",
        "ubuntu2004": "ami-09edd3475839e3985"
      },
      "sa-east-1": {
        "alinux2": "ami-04910cc80b5575e28",
        "centos7": "UNSUPPORTED",
        "ubuntu1804": "ami-0cd1781e1ee322aaa",
        "ubuntu2004": "ami-0803836b56f8b7ca3"
      },
      "us-east-1": {
        "alinux2": "ami-0d40857e362f7183f",
        "centos7": "UNSUPPORTED",
        "ubuntu1804": "ami-00a71431d5c941f20",
        "ubuntu2004": "ami-0f5198b7175bb46c4"
      },
      "us-east-2": {
        "alinux2": "ami-0202f81a528f90f61",
        "centos7": "UNSUPPORTED",
        "ubuntu1804": "ami-0bd684cccb8d7aa36",
        "ubuntu2004": "ami-0f5b0aea216993fd4"
      },
      "us-gov-east-1": {
        "alinux2": "ami-074f43cfe5b604b7e",
        "centos7": "UNSUPPORTED",
        "ubuntu1804": "ami-098f35002362495dc",
        "ubuntu2004": "ami-00b126b8309bb0866"
      },
      "us-gov-west-1": {
        "alinux2": "ami-026d149e0da457820",
        "centos7": "UNSUPPORTED",
        "ubuntu1804": "ami-059303787935ab817",
        "ubuntu2004": "ami-06b0a7e3cac1b80da"
      },
      "us-west-1": {
        "alinux2": "ami-0a5adf6485d890337",
        "centos7": "UNSUPPORTED",
        "ubuntu1804": "ami-025381de43b558dac",
        "ubuntu2004": "ami-0fd1c6ebc14746a00"
      },
      "us-west-2": {
        "alinux2": "ami-04c6183f72494fb51",
        "centos7": "UNSUPPORTED",
        "ubuntu1804": "ami-01c8e027c217e2933",
        "ubuntu2004": "ami-0b41711ee3513b2ef"
      }
    },
    "AWSRegionOS2AMIx86": {
      "af-south-1": {
        "alinux2": "ami-00e7f0a525bfe4c13",
        "centos7": "ami-0dcb2053cd1a99e16",
        "ubuntu1804": "ami-09e70ab2c6a359aa0",
        "ubuntu2004": "ami-0bc32fc55dd163d51"
      },
      "ap-east-1": {
        "alinux2": "ami-0757c35c9df5f5bb7",
        "centos7": "ami-02f898e18ee691884",
        "ubuntu1804": "ami-0ad89b98589fdf17a",
        "ubuntu2004": "ami-021286a59becb4633"
      },
      "ap-northeast-1": {
        "alinux2": "ami-01f442fe130e8b45b",
        "centos7": "ami-0a2eef1208de05713",
        "ubuntu1804": "ami-0a31a8c830ec2c94f",
        "ubuntu2004": "ami-064c8193c1c75ef2d"
      },
      "ap-northeast-2": {
        "alinux2": "ami-058a83400446b3a70",
        "centos7": "ami-0ebca9ab9cebb3cd3",
        "ubuntu1804": "ami-08ad3a46e591061a8",
        "ubuntu2004": "ami-09637516f3414e508"
      },
      "ap-northeast-3": {
        "alinux2": "UNSUPPORTED",
        "centos7": "UNSUPPORTED",
        "ubuntu1804": "UNSUPPORTED",
        "ubuntu2004": "UNSUPPORTED"
      },
      "ap-south-1": {
        "alinux2": "ami-075cd926ff395ea8f",
        "centos7": "ami-08fb1b6142e11765d",
        "ubuntu1804": "ami-057cea9ec9b3dfff6",
        "ubuntu2004": "ami-018d48f13e15e9da3"
      },
      "ap-southeast-1": {
        "alinux2": "ami-0f49779b97ce86bc8",
        "centos7": "ami-0338ea03ef7bfc775",
        "ubuntu1804": "ami-01b22d6a1283fc9c6",
        "ubuntu2004": "ami-07f2a95c23c63c84f"
      },
      "ap-southeast-2": {
        "alinux2": "ami-0b18691a64391cdbb",
        "centos7": "ami-098d013890be8bb00",
        "ubuntu1804": "ami-067b1bcf91479246c",
        "ubuntu2004": "ami-0134f25b1d9cf68a2"
      },
      "ca-central-1": {
        "alinux2": "ami-093cc039ba811dd07",
        "centos7": "ami-0bb3a2bde42ffd1e5",
        "ubuntu1804": "ami-0bd5c6582baf5dbb6",
        "ubuntu2004": "ami-0783ee9784fe602a3"
      },
      "cn-north-1": {
        "alinux2": "ami-05956232d4021ab3b",
        "centos7": "UNSUPPORTED",
        "ubuntu1804": "ami-0e3a9d38f053a7e42",
        "ubuntu2004": "ami-03b0449b7a3b8e17b"
      },
      "cn-northwest-1": {
        "alinux2": "ami-088a29e09f98494f9",
        "centos7": "UNSUPPORTED",
        "ubuntu1804": "ami-04e9dc387a0337a90",
        "ubuntu2004": "ami-0507ed9e17485825d"
      },
      "eu-central-1": {
        "alinux2": "ami-0537bbcea163107c3",
        "centos7": "ami-00ac24918812cb3f2",
        "ubuntu1804": "ami-066e77da072417788",
        "ubuntu2004": "ami-08862b70c6d768afe"
      },
      "eu-north-1": {
        "alinux2": "ami-0995fbf3bc6de9c5e",
        "centos7": "ami-0cd7d1265987bcbe8",
        "ubuntu1804": "ami-073c54f693b60eed8",
        "ubuntu2004": "ami-0fb2675ef7b516076"
      },
      "eu-south-1": {
        "alinux2": "ami-0e0bc339e944ecee6",
        "centos7": "ami-0354992be20c4639a",
        "ubuntu1804": "ami-03e2bfcc9533e76bc",
        "ubuntu2004": "ami-0ebd602d6d288c5fb"
      },
      "eu-west-1": {
        "alinux2": "ami-0c573af26bb43a91d",
        "centos7": "ami-0e6fd82f49bca2662",
        "ubuntu1804": "ami-092eba05e772ecac6",
        "ubuntu2004": "ami-00541ac0c9e8fa60e"
      },
      "eu-west-2": {
        "alinux2": "ami-018f8b671e823cf84",
        "centos7": "ami-00d6865c4674a1067",
        "ubuntu1804": "ami-08ddd20cc87bbe7d5",
        "ubuntu2004": "ami-0d232d47fc4882e8d"
      },
      "eu-west-3": {
        "alinux2": "ami-05032ac8e1d5f3083",
        "centos7": "ami-0f840b8a95af868cb",
        "ubuntu1804": "ami-016844c428a33746d",
        "ubuntu2004": "ami-0b9f4927625080486"
      },
      "me-south-1": {
        "alinux2": "ami-02123f03fd313e97f",
        "centos7": "ami-0359e13f6703d5a78",
        "ubuntu1804": "ami-09bb34fb71510bc78",
        "ubuntu2004": "ami-07c62b90ae1105ac9"
      },
      "sa-east-1": {
        "alinux2": "ami-09081fbe7562a9525",
        "centos7": "ami-04bf63a199ec85477",
        "ubuntu1804": "ami-048e97f5d5526d756",
        "ubuntu2004": "ami-0a6cf69c5886d931f"
      },
      "us-east-1": {
        "alinux2": "ami-0b411a470746e76cd",
        "centos7": "ami-09155ba78dfb53035",
        "ubuntu1804": "ami-0f49774d73447078e",
        "ubuntu2004": "ami-0ac4973fd719b9c31"
      },
      "us-east-2": {
        "alinux2": "ami-0e983b7966dd418dd",
        "centos7": "ami-00f7c86f02d2d1847",
        "ubuntu1804": "ami-004ef7e7c7d531560",
        "ubuntu2004": "ami-0e692e104c74a5f4b"
      },
      "us-gov-east-1": {
        "alinux2": "ami-0929bf0827abaf4be",
        "centos7": "UNSUPPORTED",
        "ubuntu1804": "ami-060cb93ea0a5d6d07",
        "ubuntu2004": "ami-0178e45119aaadc2a"
      },
      "us-gov-west-1": {
        "alinux2": "ami-023b92af8b4219065",
        "centos7": "UNSUPPORTED",
        "ubuntu1804": "ami-06aa93779d4d39ce9",
        "ubuntu2004": "ami-0b7b03e9dc2fb5643"
      },
      "us-west-1": {
        "alinux2": "ami-0b53ef882dbfa7ccd",
        "centos7": "ami-02089afcd1b73f14a",
        "ubuntu1804": "ami-049884d102552a6c9",
        "ubuntu2004": "ami-066e9265d6bc22976"
      },
      "us-west-2": {
        "alinux2": "ami-0e91b63c6394a8429",
        "centos7": "ami-06017b0fd5bbbe74e",
        "ubuntu1804": "ami-0eac746e8d3309105",
        "ubuntu2004": "ami-0a86c6d5ab23eefa7"
      }
    },
    "OSFeatures": {
      "centos7": {
        "User": "centos",
        "RootDevice": "/dev/sda1"
      },
      "alinux2": {
        "User": "ec2-user",
        "RootDevice": "/dev/xvda"
      },
      "ubuntu1804": {
        "User": "ubuntu",
        "RootDevice": "/dev/sda1"
      },
      "ubuntu2004": {
        "User": "ubuntu",
        "RootDevice": "/dev/sda1"
      }
    },
    "PackagesVersions": {
      "default": {
        "parallelcluster": "2.11.6",
        "cookbook": "aws-parallelcluster-cookbook-2.11.6",
        "chef": "17.2.29",
        "berkshelf": "7.0.10",
        "ami": "dev"
      }
    },
    "Partition2Url": {
      "aws": {
        "url": "amazonaws.com"
      },
      "aws-us-gov": {
        "url": "amazonaws.com"
      },
      "aws-cn": {
        "url": "amazonaws.com.cn"
      }
    }
  },
  "Resources": {
    "EFSSubstack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "Parameters": {
          "EFSOptions": {
            "Ref": "EFSOptions"
          },
          "ComputeSecurityGroup": {
            "Fn::If": [
              "CreateSecurityGroups",
              {
                "Ref": "ComputeSecurityGroup"
              },
              {
                "Ref": "VPCSecurityGroupId"
              }
            ]
          },
          "MasterSubnetId": {
            "Ref": "MasterSubnetId"
          },
          "ComputeSubnetId": {
            "Ref": "ComputeSubnetId"
          }
        },
        "TemplateURL": {
          "Fn::Sub": [
            "https://${AWS::Region}-aws-parallelcluster.s3.${AWS::Region}.${s3_url}/templates/efs-substack-${version}.cfn.json",
            {
              "s3_url": {
                "Fn::FindInMap": [
                  "Partition2Url",
                  {
                    "Ref": "AWS::Partition"
                  },
                  "url"
                ]
              },
              "version": {
                "Fn::FindInMap": [
                  "PackagesVersions",
                  "default",
                  "parallelcluster"
                ]
              }
            }
          ]
        }
      },
      "Condition": "CreateEFSSubstack"
    },
    "CloudWatchLogsSubstack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "Parameters": {
          "CWLogOptions": {
            "Ref": "CWLogOptions"
          },
          "CWLogGroupName": {
            "Fn::Sub": [
              "/aws/parallelcluster/${cluster_name}",
              {
                "cluster_name": {
                  "Fn::Select": [
                    "1",
                    {
                      "Fn::Split": [
                        "parallelcluster-",
                        {
                          "Ref": "AWS::StackName"
                        }
                      ]
                    }
                  ]
                }
              }
            ]
          },
          "MainStackName": {
            "Ref": "AWS::StackName"
          },
          "MainStackUniqueId": {
            "Fn::Select": [
              "2",
              {
                "Fn::Split": [
                  "/",
                  {
                    "Ref": "AWS::StackId"
                  }
                ]
              }
            ]
          },
          "CreateHITSubstack": {
            "Fn::If": [
              "CreateHITSubstack",
              "true",
              "false"
            ]
          },
          "CreateAWSBatchLogGroups": {
            "Fn::If": [
              "CreateAWSBatchStack",
              "true",
              "false"
            ]
          }
        },
        "TemplateURL": {
          "Fn::Sub": [
            "https://${AWS::Region}-aws-parallelcluster.s3.${AWS::Region}.${s3_url}/templates/cw-logs-substack-${version}.cfn.json",
            {
              "s3_url": {
                "Fn::FindInMap": [
                  "Partition2Url",
                  {
                    "Ref": "AWS::Partition"
                  },
                  "url"
                ]
              },
              "version": {
                "Fn::FindInMap": [
                  "PackagesVersions",
                  "default",
                  "parallelcluster"
                ]
              }
            }
          ]
        }
      }
    },
    "FSXSubstack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "Parameters": {
          "FSXOptions": {
            "Ref": "FSXOptions"
          },
          "ComputeSecurityGroup": {
            "Fn::If": [
              "CreateSecurityGroups",
              {
                "Ref": "ComputeSecurityGroup"
              },
              {
                "Ref": "VPCSecurityGroupId"
              }
            ]
          },
          "ComputeSecurityGroupIngress": {
            "Fn::If": [
              "CreateSecurityGroups",
              {
                "Ref": "ComputeSecurityGroupIngress"
              },
              {
                "Ref": "VPCSecurityGroupId"
              }
            ]
          },
          "SubnetId": {
            "Ref": "MasterSubnetId"
          }
        },
        "TemplateURL": {
          "Fn::Sub": [
            "https://${AWS::Region}-aws-parallelcluster.s3.${AWS::Region}.${s3_url}/templates/fsx-substack-${version}.cfn.json",
            {
              "s3_url": {
                "Fn::FindInMap": [
                  "Partition2Url",
                  {
                    "Ref": "AWS::Partition"
                  },
                  "url"
                ]
              },
              "version": {
                "Fn::FindInMap": [
                  "PackagesVersions",
                  "default",
                  "parallelcluster"
                ]
              }
            }
          ]
        }
      },
      "Condition": "CreateFSXSubstack"
    },
    "RootRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": {
          "Fn::If": [
            "UseEC2IAMPolicies",
            {
              "Ref": "EC2IAMPolicies"
            },
            {
              "Ref": "AWS::NoValue"
            }
          ]
        },
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  {
                    "Fn::Sub": [
                      "ec2.${s3_url}",
                      {
                        "s3_url": {
                          "Fn::FindInMap": [
                            "Partition2Url",
                            {
                              "Ref": "AWS::Partition"
                            },
                            "url"
                          ]
                        }
                      }
                    ]
                  }
                ]
              },
              "Action": [
                "sts:AssumeRole"
              ]
            }
          ]
        },
        "Path": "/"
      },
      "Condition": "CreateEC2IAMRole"
    },
    "RootInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Fn::If": [
              "UseEC2IAMRole",
              {
                "Ref": "EC2IAMRoleName"
              },
              {
                "Ref": "RootRole"
              }
            ]
          }
        ]
      }
    },
    "ParallelClusterPolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyName": "parallelcluster",
        "PolicyDocument": {
          "Statement": [
            {
              "Sid": "EC2",
              "Action": [
                "ec2:DescribeVolumes",
                "ec2:AttachVolume",
                "ec2:DescribeInstanceAttribute",
                "ec2:DescribeInstanceStatus",
                "ec2:DescribeInstances",
                "ec2:DescribeInstanceTypes"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Sid": "DynamoDBList",
              "Action": [
                "dynamodb:ListTables"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Sid": "Cloudformation",
              "Action": [
                "cloudformation:DescribeStacks",
                "cloudformation:DescribeStackResource",
                "cloudformation:SignalResource"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:${AWS::Partition}:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/parallelcluster-*/*"
                }
              ]
            },
            {
              "Sid": "DynamoDBTable",
              "Action": [
                "dynamodb:PutItem",
                "dynamodb:BatchWriteItem",
                "dynamodb:GetItem",
                "dynamodb:DeleteItem",
                "dynamodb:DescribeTable"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${AWS::StackName}"
                }
              ]
            },
            {
              "Sid": "S3GetObj",
              "Action": [
                "s3:GetObject"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:${AWS::Partition}:s3:::${AWS::Region}-aws-parallelcluster/*"
                }
              ]
            },
            {
              "Sid": "S3PutObj",
              "Action": [
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:${AWS::Partition}:s3:::${ResourcesS3Bucket}/${ArtifactS3RootDirectory}/batch/*"
                }
              ]
            },
            {
              "Sid": "FSx",
              "Action": [
                "fsx:DescribeFileSystems"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Sid": "BatchJobPassRole",
              "Action": [
                "iam:PassRole"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:${AWS::Partition}:iam::${AWS::AccountId}:role/parallelcluster-*"
                }
              ]
            },
            {
              "Sid": "DcvLicense",
              "Effect": "Allow",
              "Action": "s3:GetObject",
              "Resource": [
                {
                  "Fn::Sub": "arn:${AWS::Partition}:s3:::dcv-license.${AWS::Region}/*"
                }
              ]
            }
          ]
        },
        "Roles": [
          {
            "Ref": "RootRole"
          }
        ]
      },
      "Condition": "CreateEC2IAMRole"
    },
    "S3ReadRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyName": "S3Read",
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "S3Read",
              "Effect": "Allow",
              "Action": [
                "s3:Get*",
                "s3:List*"
              ],
              "Resource": [
                {
                  "Ref": "S3ReadResource"
                }
              ]
            }
          ]
        },
        "Roles": [
          {
            "Ref": "RootRole"
          }
        ]
      },
      "Condition": "UseS3ReadPolicy"
    },
    "S3ReadWriteRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyName": "S3ReadWrite",
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "S3ReadWrite",
              "Effect": "Allow",
              "Action": [
                "s3:*"
              ],
              "Resource": [
                {
                  "Ref": "S3ReadWriteResource"
                }
              ]
            }
          ]
        },
        "Roles": [
          {
            "Ref": "RootRole"
          }
        ]
      },
      "Condition": "UseS3ReadWritePolicy"
    },
    "MasterEIP": {
      "Type": "AWS::EC2::EIP",
      "Properties": {
        "Domain": "vpc"
      },
      "Condition": "MasterPublicIp"
    },
    "ComputeSubnet": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {
          "Ref": "VPCId"
        },
        "CidrBlock": {
          "Ref": "ComputeSubnetCidr"
        },
        "Tags": [
          {
            "Key": "Network",
            "Value": "ComputeSubnet"
          }
        ],
        "AvailabilityZone": {
          "Ref": "AvailabilityZone"
        }
      },
      "Condition": "CreateComputeSubnetForCompute"
    },
    "ComputeRouteTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {
          "Ref": "VPCId"
        },
        "Tags": [
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "Network",
            "Value": "ComputeSubnet"
          }
        ]
      },
      "Condition": "CreateComputeSubnetForCompute"
    },
    "ComputeRoute": {
      "Type": "AWS::EC2::Route",
      "Properties": {
        "RouteTableId": {
          "Ref": "ComputeRouteTable"
        },
        "DestinationCidrBlock": "0.0.0.0/0",
        "NetworkInterfaceId": {
          "Ref": "MasterENI"
        }
      },
      "Condition": "CreateComputeSubnetForCompute"
    },
    "ComputeSubnetRouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": {
          "Ref": "ComputeSubnet"
        },
        "RouteTableId": {
          "Ref": "ComputeRouteTable"
        }
      },
      "Condition": "CreateComputeSubnetForCompute"
    },
    "MasterSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Enable access to the head node",
        "VpcId": {
          "Ref": "VPCId"
        },
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 22,
            "ToPort": 22,
            "CidrIp": {
              "Ref": "AccessFrom"
            }
          },
          {
            "Fn::If": [
              "EnableDCV",
              {
                "IpProtocol": "tcp",
                "FromPort": {
                  "Fn::Select": [
                    "1",
                    {
                      "Fn::Split": [
                        ",",
                        {
                          "Ref": "DCVOptions"
                        }
                      ]
                    }
                  ]
                },
                "ToPort": {
                  "Fn::Select": [
                    "1",
                    {
                      "Fn::Split": [
                        ",",
                        {
                          "Ref": "DCVOptions"
                        }
                      ]
                    }
                  ]
                },
                "CidrIp": {
                  "Fn::Select": [
                    "2",
                    {
                      "Fn::Split": [
                        ",",
                        {
                          "Ref": "DCVOptions"
                        }
                      ]
                    }
                  ]
                }
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          }
        ]
      },
      "Condition": "CreateSecurityGroups"
    },
    "MasterSecurityGroupIngress": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "IpProtocol": "-1",
        "FromPort": 0,
        "ToPort": 65535,
        "SourceSecurityGroupId": {
          "Ref": "ComputeSecurityGroup"
        },
        "GroupId": {
          "Ref": "MasterSecurityGroup"
        }
      },
      "Condition": "CreateSecurityGroups"
    },
    "ComputeSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Allow access to resources in subnets behind front",
        "VpcId": {
          "Ref": "VPCId"
        },
        "SecurityGroupIngress": [
          {
            "SourceSecurityGroupId": {
              "Ref": "MasterSecurityGroup"
            },
            "IpProtocol": "-1",
            "FromPort": 0,
            "ToPort": 65535
          }
        ]
      },
      "Condition": "CreateSecurityGroups"
    },
    "ComputeSecurityGroupEgress": {
      "Type": "AWS::EC2::SecurityGroupEgress",
      "Properties": {
        "IpProtocol": "-1",
        "FromPort": 0,
        "ToPort": 65535,
        "DestinationSecurityGroupId": {
          "Ref": "ComputeSecurityGroup"
        },
        "GroupId": {
          "Ref": "ComputeSecurityGroup"
        }
      },
      "Condition": "CreateSecurityGroups"
    },
    "ComputeSecurityGroupNormalEgress": {
      "Type": "AWS::EC2::SecurityGroupEgress",
      "Properties": {
        "IpProtocol": "-1",
        "FromPort": 0,
        "ToPort": 65535,
        "CidrIp": "0.0.0.0/0",
        "GroupId": {
          "Ref": "ComputeSecurityGroup"
        }
      },
      "DependsOn": "ComputeSecurityGroupEgress",
      "Condition": "CreateSecurityGroups"
    },
    "ComputeSecurityGroupIngress": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "IpProtocol": "-1",
        "FromPort": 0,
        "ToPort": 65535,
        "SourceSecurityGroupId": {
          "Ref": "ComputeSecurityGroup"
        },
        "GroupId": {
          "Ref": "ComputeSecurityGroup"
        }
      },
      "Condition": "CreateSecurityGroups"
    },
    "MasterENI": {
      "Type": "AWS::EC2::NetworkInterface",
      "Properties": {
        "Description": "AWS ParallelCluster head node interface",
        "SubnetId": {
          "Ref": "MasterSubnetId"
        },
        "SourceDestCheck": false,
        "GroupSet": [
          {
            "Fn::If": [
              "CreateSecurityGroups",
              {
                "Ref": "MasterSecurityGroup"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          },
          {
            "Fn::If": [
              "AddAdditionalSG",
              {
                "Ref": "AdditionalSG"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          },
          {
            "Fn::If": [
              "UseExistingSecurityGroup",
              {
                "Ref": "VPCSecurityGroupId"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          }
        ]
      }
    },
    "AdditionalCfnStack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": {
          "Ref": "AdditionalCfnTemplate"
        }
      },
      "Condition": "CreateSubStack"
    },
    "AWSBatchStack": {
      "Type": "AWS::CloudFormation::Stack",
      "DependsOn": [
        "CleanupResourcesS3BucketCustomResource",
        "CloudWatchLogsSubstack"
      ],
      "Properties": {
        "Parameters": {
          "AttributeTags": {
            "Fn::Sub": [
              "${BaseOS}, ${Scheduler}, ${version}, ${Architecture}",
              {
                "version": {
                  "Fn::FindInMap": [
                    "PackagesVersions",
                    "default",
                    "parallelcluster"
                  ]
                }
              }
            ]
          },
          "S3Url": {
            "Fn::FindInMap": [
              "Partition2Url",
              {
                "Ref": "AWS::Partition"
              },
              "url"
            ]
          },
          "FileSystemTags": {
            "Fn::Sub": [
              "efs=${efs}, multiebs=${NumberOfEBSVol}, raid=${raid}",
              {
                "efs": {
                  "Fn::If": [
                    "CreateEFSSubstack",
                    "1",
                    "0"
                  ]
                },
                "raid": {
                  "Fn::If": [
                    "CreateRAIDSubstack",
                    "1",
                    "0"
                  ]
                }
              }
            ]
          },
          "EFSSharedDir": {
            "Fn::Select": [
              "0",
              {
                "Fn::Split": [
                  ",",
                  {
                    "Ref": "EFSOptions"
                  }
                ]
              }
            ]
          },
          "EFSFSId": {
            "Fn::If": [
              "CreateEFSSubstack",
              {
                "Fn::GetAtt": [
                  "EFSSubstack",
                  "Outputs.FileSystemId"
                ]
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          },
          "MinvCpus": {
            "Ref": "MinSize"
          },
          "DesiredvCpus": {
            "Ref": "DesiredSize"
          },
          "MaxvCpus": {
            "Ref": "MaxSize"
          },
          "InstanceTypes": {
            "Ref": "ComputeInstanceType"
          },
          "Subnet": {
            "Fn::If": [
              "UseMasterSubnetForCompute",
              {
                "Ref": "MasterSubnetId"
              },
              {
                "Fn::If": [
                  "CreateComputeSubnetForCompute",
                  {
                    "Ref": "ComputeSubnet"
                  },
                  {
                    "Ref": "ComputeSubnetId"
                  }
                ]
              }
            ]
          },
          "SecurityGroups": {
            "Fn::Join": [
              ",",
              [
                {
                  "Fn::If": [
                    "CreateSecurityGroups",
                    {
                      "Ref": "ComputeSecurityGroup"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                },
                {
                  "Fn::If": [
                    "AddAdditionalSG",
                    {
                      "Ref": "AdditionalSG"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                },
                {
                  "Fn::If": [
                    "UseExistingSecurityGroup",
                    {
                      "Ref": "VPCSecurityGroupId"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                }
              ]
            ]
          },
          "OS": {
            "Ref": "BaseOS"
          },
          "ClusterName": {
            "Ref": "AWS::StackName"
          },
          "ClusterType": {
            "Ref": "ClusterType"
          },
          "KeyName": {
            "Ref": "KeyName"
          },
          "SpotBidPercentage": {
            "Fn::If": [
              "UseSpotPrice",
              {
                "Ref": "SpotPrice"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          },
          "ResourcesS3Bucket": {
            "Ref": "ResourcesS3Bucket"
          },
          "ArtifactS3RootDirectory": {
            "Ref": "ArtifactS3RootDirectory"
          },
          "SharedDir": {
            "Ref": "SharedDir"
          },
          "RAIDSharedDir": {
            "Fn::Select": [
              "0",
              {
                "Fn::Split": [
                  ",",
                  {
                    "Ref": "RAIDOptions"
                  }
                ]
              }
            ]
          },
          "MainStackUniqueId": {
            "Fn::Select": [
              "2",
              {
                "Fn::Split": [
                  "/",
                  {
                    "Ref": "AWS::StackId"
                  }
                ]
              }
            ]
          },
          "Architecture": {
            "Ref": "Architecture"
          },
          "MasterPrivateIP": {
            "Fn::GetAtt": [
              "MasterServerSubstack",
              "Outputs.MasterPrivateIP"
            ]
          },
          "IAMLambdaRoleName": {
            "Ref": "IAMLambdaRoleName"
          }
        },
        "TemplateURL": {
          "Fn::Sub": [
            "https://${AWS::Region}-aws-parallelcluster.s3.${AWS::Region}.${s3_url}/templates/batch-substack-${version}.cfn.json",
            {
              "s3_url": {
                "Fn::FindInMap": [
                  "Partition2Url",
                  {
                    "Ref": "AWS::Partition"
                  },
                  "url"
                ]
              },
              "version": {
                "Fn::FindInMap": [
                  "PackagesVersions",
                  "default",
                  "parallelcluster"
                ]
              }
            }
          ]
        }
      },
      "Condition": "CreateAWSBatchStack"
    },
    "AssociateEIP": {
      "Type": "AWS::EC2::EIPAssociation",
      "Properties": {
        "AllocationId": {
          "Fn::GetAtt": [
            "MasterEIP",
            "AllocationId"
          ]
        },
        "NetworkInterfaceId": {
          "Ref": "MasterENI"
        }
      },
      "Condition": "MasterPublicIp"
    },
    "DynamicPlacementGroup": {
      "Type": "AWS::EC2::PlacementGroup",
      "Properties": {
        "Strategy": "cluster"
      },
      "Condition": "CreatePlacementGroup"
    },
    "CleanupResourcesFunctionExecutionRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [
                "sts:AssumeRole"
              ],
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "lambda.amazonaws.com"
                ]
              }
            }
          ],
          "Version": "2012-10-17"
        },
        "Path": "/",
        "Policies": [
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": [
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Effect": "Allow",
                  "Resource": {
                    "Fn::Sub": "arn:${AWS::Partition}:logs:*:*:*"
                  },
                  "Sid": "CloudWatchLogsPolicy"
                },
                {
                  "Action": {
                    "Fn::If": [
                      "UseProvidedResourcesS3Bucket",
                      [
                        "s3:DeleteObject",
                        "s3:DeleteObjectVersion",
                        "s3:ListBucket",
                        "s3:ListBucketVersions"
                      ],
                      [
                        "s3:DeleteBucket",
                        "s3:DeleteObject",
                        "s3:DeleteObjectVersion",
                        "s3:ListBucket",
                        "s3:ListBucketVersions"
                      ]
                    ]
                  },
                  "Effect": "Allow",
                  "Resource": [
                    {
                      "Fn::Sub": "arn:${AWS::Partition}:s3:::${ResourcesS3Bucket}"
                    },
                    {
                      "Fn::Sub": "arn:${AWS::Partition}:s3:::${ResourcesS3Bucket}/${ArtifactS3RootDirectory}/*"
                    }
                  ],
                  "Sid": "S3BucketPolicy"
                },
                {
                  "Fn::If": [
                    "CreateHITSubstack",
                    {
                      "Sid": "DescribeInstances",
                      "Effect": "Allow",
                      "Action": [
                        "ec2:DescribeInstances"
                      ],
                      "Resource": "*"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                },
                {
                  "Fn::If": [
                    "CreateHITSubstack",
                    {
                      "Sid": "FleetTerminatePolicy",
                      "Effect": "Allow",
                      "Action": [
                        "ec2:TerminateInstances"
                      ],
                      "Resource": "*",
                      "Condition": {
                        "StringEquals": {
                          "ec2:ResourceTag/Application": {
                            "Ref": "AWS::StackName"
                          }
                        }
                      }
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                }
              ],
              "Version": "2012-10-17"
            },
            "PolicyName": "LambdaPolicy"
          }
        ]
      },
      "Condition": "CreateIAMLambdaRole"
    },
    "CleanupResourcesS3BucketCustomResource": {
      "Type": "AWS::CloudFormation::CustomResource",
      "Properties": {
        "ResourcesS3Bucket": {
          "Ref": "ResourcesS3Bucket"
        },
        "ArtifactS3RootDirectory": {
          "Ref": "ArtifactS3RootDirectory"
        },
        "RemoveBucketOnDeletion": {
          "Ref": "RemoveBucketOnDeletion"
        },
        "Action": "DELETE_S3_ARTIFACTS",
        "ServiceToken": {
          "Fn::GetAtt": [
            "CleanupResourcesFunction",
            "Arn"
          ]
        }
      }
    },
    "TerminateComputeFleetCustomResource": {
      "Type": "AWS::CloudFormation::CustomResource",
      "Properties": {
        "StackName": {
          "Ref": "AWS::StackName"
        },
        "Action": "TERMINATE_EC2_INSTANCES",
        "ServiceToken": {
          "Fn::GetAtt": [
            "CleanupResourcesFunction",
            "Arn"
          ]
        }
      },
      "DependsOn": [
        "CloudWatchLogsSubstack",
        "ComputeFleetHITSubstack"
      ],
      "Condition": "CreateHITSubstack"
    },
    "CleanupResourcesFunction": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "FunctionName": {
          "Fn::Sub": [
            "pcluster-CleanupResources-${StackId}",
            {
              "StackId": {
                "Fn::Select": [
                  "2",
                  {
                    "Fn::Split": [
                      "/",
                      {
                        "Ref": "AWS::StackId"
                      }
                    ]
                  }
                ]
              }
            }
          ]
        },
        "Code": {
          "S3Bucket": {
            "Ref": "ResourcesS3Bucket"
          },
          "S3Key": {
            "Fn::Sub": "${ArtifactS3RootDirectory}/custom_resources_code/artifacts.zip"
          }
        },
        "Handler": "cleanup_resources.handler",
        "MemorySize": 128,
        "Role": {
          "Fn::If": [
            "CreateIAMLambdaRole",
            {
              "Fn::GetAtt": [
                "CleanupResourcesFunctionExecutionRole",
                "Arn"
              ]
            },
            {
              "Fn::Sub": "arn:${AWS::Partition}:iam::${AWS::AccountId}:role/${IAMLambdaRoleName}"
            }
          ]
        },
        "Runtime": "python3.8",
        "Timeout": 900
      }
    },
    "RAIDSubstack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "Parameters": {
          "RAIDOptions": {
            "Ref": "RAIDOptions"
          },
          "AvailabilityZone": {
            "Ref": "AvailabilityZone"
          }
        },
        "TemplateURL": {
          "Fn::Sub": [
            "https://${AWS::Region}-aws-parallelcluster.s3.${AWS::Region}.${s3_url}/templates/raid-substack-${version}.cfn.json",
            {
              "s3_url": {
                "Fn::FindInMap": [
                  "Partition2Url",
                  {
                    "Ref": "AWS::Partition"
                  },
                  "url"
                ]
              },
              "version": {
                "Fn::FindInMap": [
                  "PackagesVersions",
                  "default",
                  "parallelcluster"
                ]
              }
            }
          ]
        }
      },
      "Condition": "CreateRAIDSubstack"
    },
    "EBSCfnStack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "Parameters": {
          "AvailabilityZone": {
            "Ref": "AvailabilityZone"
          },
          "VolumeSize": {
            "Ref": "VolumeSize"
          },
          "VolumeType": {
            "Ref": "VolumeType"
          },
          "VolumeIOPS": {
            "Ref": "VolumeIOPS"
          },
          "VolumeThroughput": {
            "Ref": "VolumeThroughput"
          },
          "EBSEncryption": {
            "Ref": "EBSEncryption"
          },
          "EBSKMSKeyId": {
            "Ref": "EBSKMSKeyId"
          },
          "EBSVolumeId": {
            "Ref": "EBSVolumeId"
          },
          "EBSSnapshotId": {
            "Ref": "EBSSnapshotId"
          },
          "NumberOfEBSVol": {
            "Ref": "NumberOfEBSVol"
          }
        },
        "TemplateURL": {
          "Fn::Sub": [
            "https://${AWS::Region}-aws-parallelcluster.s3.${AWS::Region}.${s3_url}/templates/ebs-substack-${version}.cfn.json",
            {
              "s3_url": {
                "Fn::FindInMap": [
                  "Partition2Url",
                  {
                    "Ref": "AWS::Partition"
                  },
                  "url"
                ]
              },
              "version": {
                "Fn::FindInMap": [
                  "PackagesVersions",
                  "default",
                  "parallelcluster"
                ]
              }
            }
          ]
        }
      }
    },
    "MasterServerSubstack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "Parameters": {
          "MasterInstanceType": {
            "Ref": "MasterInstanceType"
          },
          "MasterSecurityGroups": {
            "Fn::Join": [
              ",",
              [
                {
                  "Fn::If": [
                    "CreateSecurityGroups",
                    {
                      "Ref": "MasterSecurityGroup"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                },
                {
                  "Fn::If": [
                    "AddAdditionalSG",
                    {
                      "Ref": "AdditionalSG"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                },
                {
                  "Fn::If": [
                    "UseExistingSecurityGroup",
                    {
                      "Ref": "VPCSecurityGroupId"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                }
              ]
            ]
          },
          "ComputeInstanceType": {
            "Ref": "ComputeInstanceType"
          },
          "MasterSubnetId": {
            "Ref": "MasterSubnetId"
          },
          "MasterCoreCount": {
            "Fn::Join": [
              ",",
              [
                {
                  "Fn::Select": [
                    "0",
                    {
                      "Ref": "Cores"
                    }
                  ]
                },
                {
                  "Fn::Select": [
                    "2",
                    {
                      "Ref": "Cores"
                    }
                  ]
                }
              ]
            ]
          },
          "ComputeCoreCount": {
            "Fn::Select": [
              "1",
              {
                "Ref": "Cores"
              }
            ]
          },
          "RootDevice": {
            "Fn::FindInMap": [
              "OSFeatures",
              {
                "Ref": "BaseOS"
              },
              "RootDevice"
            ]
          },
          "RootVolumeSize": {
            "Ref": "MasterRootVolumeSize"
          },
          "KeyName": {
            "Ref": "KeyName"
          },
          "MainStackName": {
            "Ref": "AWS::StackName"
          },
          "AttributesTagValue": {
            "Fn::Sub": [
              "${BaseOS}, ${Scheduler}, ${version}, ${Architecture}",
              {
                "version": {
                  "Fn::FindInMap": [
                    "PackagesVersions",
                    "default",
                    "parallelcluster"
                  ]
                }
              }
            ]
          },
          "NetworkingTagValue": {
            "Fn::Sub": "EFA=${EFA}"
          },
          "FilesystemTagValue": {
            "Fn::Sub": [
              "efs=${efs}, multiebs=${NumberOfEBSVol}, raid=${raid}, fsx=${fsx}",
              {
                "efs": {
                  "Fn::If": [
                    "CreateEFSSubstack",
                    "1",
                    "0"
                  ]
                },
                "raid": {
                  "Fn::If": [
                    "CreateRAIDSubstack",
                    "1",
                    "0"
                  ]
                },
                "fsx": {
                  "Fn::If": [
                    "CreateFSXSubstack",
                    "1",
                    "0"
                  ]
                }
              }
            ]
          },
          "MasterENI": {
            "Ref": "MasterENI"
          },
          "UseMasterPublicIp": {
            "Fn::If": [
              "MasterPublicIp",
              true,
              false
            ]
          },
          "ImageId": {
            "Fn::If": [
              "UseCustomAMI",
              {
                "Ref": "CustomAMI"
              },
              {
                "Fn::If": [
                  "UseArmAMIs",
                  {
                    "Fn::FindInMap": [
                      "AWSRegionOS2AMIarm64",
                      {
                        "Ref": "AWS::Region"
                      },
                      {
                        "Ref": "BaseOS"
                      }
                    ]
                  },
                  {
                    "Fn::FindInMap": [
                      "AWSRegionOS2AMIx86",
                      {
                        "Ref": "AWS::Region"
                      },
                      {
                        "Ref": "BaseOS"
                      }
                    ]
                  }
                ]
              }
            ]
          },
          "IamInstanceProfile": {
            "Ref": "RootInstanceProfile"
          },
          "IamRoleName": {
            "Fn::If": [
              "UseEC2IAMRole",
              {
                "Ref": "EC2IAMRoleName"
              },
              {
                "Ref": "RootRole"
              }
            ]
          },
          "PlacementGroup": {
            "Fn::If": [
              "UseClusterPlacement",
              {
                "Fn::If": [
                  "CreatePlacementGroup",
                  {
                    "Ref": "DynamicPlacementGroup"
                  },
                  {
                    "Ref": "PlacementGroup"
                  }
                ]
              },
              "NONE"
            ]
          },
          "EFA": {
            "Ref": "EFA"
          },
          "BaseOS": {
            "Ref": "BaseOS"
          },
          "OSUser": {
            "Fn::FindInMap": [
              "OSFeatures",
              {
                "Ref": "BaseOS"
              },
              "User"
            ]
          },
          "PreInstallScript": {
            "Ref": "PreInstallScript"
          },
          "PreInstallArgs": {
            "Ref": "PreInstallArgs"
          },
          "PostInstallScript": {
            "Ref": "PostInstallScript"
          },
          "PostInstallArgs": {
            "Ref": "PostInstallArgs"
          },
          "RAIDVolIds": {
            "Fn::If": [
              "CreateRAIDSubstack",
              {
                "Fn::GetAtt": [
                  "RAIDSubstack",
                  "Outputs.Volumeids"
                ]
              },
              ""
            ]
          },
          "RAIDOptions": {
            "Ref": "RAIDOptions"
          },
          "EFSId": {
            "Fn::If": [
              "CreateEFSSubstack",
              {
                "Fn::GetAtt": [
                  "EFSSubstack",
                  "Outputs.FileSystemId"
                ]
              },
              ""
            ]
          },
          "EFSOptions": {
            "Ref": "EFSOptions"
          },
          "FSXId": {
            "Fn::If": [
              "CreateFSXSubstack",
              {
                "Fn::GetAtt": [
                  "FSXSubstack",
                  "Outputs.FileSystemId"
                ]
              },
              ""
            ]
          },
          "FSXMountName": {
            "Fn::If": [
              "CreateFSXSubstack",
              {
                "Fn::GetAtt": [
                  "FSXSubstack",
                  "Outputs.MountName"
                ]
              },
              ""
            ]
          },
          "FSXDNSName": {
            "Fn::If": [
              "CreateFSXSubstack",
              {
                "Fn::GetAtt": [
                  "FSXSubstack",
                  "Outputs.DNSName"
                ]
              },
              ""
            ]
          },
          "FSXOptions": {
            "Ref": "FSXOptions"
          },
          "EBSVolIds": {
            "Fn::GetAtt": [
              "EBSCfnStack",
              "Outputs.Volumeids"
            ]
          },
          "Scheduler": {
            "Ref": "Scheduler"
          },
          "EncryptedEphemeral": {
            "Ref": "EncryptedEphemeral"
          },
          "EphemeralDir": {
            "Ref": "EphemeralDir"
          },
          "SharedDir": {
            "Ref": "SharedDir"
          },
          "ProxyServer": {
            "Ref": "ProxyServer"
          },
          "ClusterDNSDomain": {
            "Fn::If": [
              "CreateHITSubstack",
              {
                "Fn::GetAtt": [
                  "ComputeFleetHITSubstack",
                  "Outputs.ClusterDNSDomain"
                ]
              },
              ""
            ]
          },
          "ClusterHostedZone": {
            "Fn::If": [
              "CreateHITSubstack",
              {
                "Fn::GetAtt": [
                  "ComputeFleetHITSubstack",
                  "Outputs.ClusterHostedZone"
                ]
              },
              ""
            ]
          },
          "MaxSize": {
            "Ref": "MaxSize"
          },
          "DynamoDBTable": {
            "Ref": "AWS::StackName"
          },
          "DCVEnabled": {
            "Fn::If": [
              "EnableDCV",
              "master",
              "false"
            ]
          },
          "DCVPort": {
            "Fn::Select": [
              "1",
              {
                "Fn::Split": [
                  ",",
                  {
                    "Ref": "DCVOptions"
                  }
                ]
              }
            ]
          },
          "IntelHPCPlatform": {
            "Ref": "IntelHPCPlatform"
          },
          "CWLoggingEnabled": {
            "Fn::GetAtt": [
              "CloudWatchLogsSubstack",
              "Outputs.Enabled"
            ]
          },
          "ExtraJson": {
            "Ref": "ExtraJson"
          },
          "CustomChefCookbook": {
            "Ref": "CustomChefCookbook"
          },
          "AWSDomain": {
            "Fn::FindInMap": [
              "Partition2Url",
              {
                "Ref": "AWS::Partition"
              },
              "url"
            ]
          },
          "ParallelClusterVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "parallelcluster"
            ]
          },
          "CookbookVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "cookbook"
            ]
          },
          "ChefVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "chef"
            ]
          },
          "BerkshelfVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "berkshelf"
            ]
          },
          "ResourcesS3Bucket": {
            "Ref": "ResourcesS3Bucket"
          },
          "ArtifactS3RootDirectory": {
            "Ref": "ArtifactS3RootDirectory"
          },
          "DependsOnCustomResources": {
            "Fn::If": [
              "CreateHITSubstack",
              {
                "Fn::Sub": [
                  "DependsOn${fleetTermination}And${route53cleanup}",
                  {
                    "fleetTermination": {
                      "Ref": "TerminateComputeFleetCustomResource"
                    },
                    "route53cleanup": {
                      "Fn::GetAtt": [
                        "ComputeFleetHITSubstack",
                        "Outputs.CleanupRoute53CustomResource"
                      ]
                    }
                  }
                ]
              },
              ""
            ]
          },
          "HITConfigVersion": {
            "Fn::If": [
              "CreateHITSubstack",
              {
                "Fn::GetAtt": [
                  "ComputeFleetHITSubstack",
                  "Outputs.ConfigVersion"
                ]
              },
              ""
            ]
          },
          "UpdateWaiterFunctionArn": {
            "Fn::If": [
              "CreateHITSubstack",
              {
                "Fn::GetAtt": [
                  "ComputeFleetHITSubstack",
                  "Outputs.UpdateWaiterFunctionArn"
                ]
              },
              "NONE"
            ]
          },
          "MasterNetworkInterfacesCount": {
            "Fn::Select": [
              "0",
              {
                "Ref": "NetworkInterfacesCount"
              }
            ]
          },
          "InstanceTypesData": {
            "Ref": "InstanceTypesData"
          }
        },
        "TemplateURL": {
          "Fn::Sub": [
            "https://${AWS::Region}-aws-parallelcluster.s3.${AWS::Region}.${s3_url}/templates/master-server-substack-${version}.cfn.yaml",
            {
              "s3_url": {
                "Fn::FindInMap": [
                  "Partition2Url",
                  {
                    "Ref": "AWS::Partition"
                  },
                  "url"
                ]
              },
              "version": {
                "Fn::FindInMap": [
                  "PackagesVersions",
                  "default",
                  "parallelcluster"
                ]
              }
            }
          ]
        }
      }
    },
    "ComputeFleetHITSubstack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "Parameters": {
          "ComputeSubnetId": {
            "Fn::If": [
              "UseMasterSubnetForCompute",
              {
                "Ref": "MasterSubnetId"
              },
              {
                "Fn::If": [
                  "CreateComputeSubnetForCompute",
                  {
                    "Ref": "ComputeSubnet"
                  },
                  {
                    "Ref": "ComputeSubnetId"
                  }
                ]
              }
            ]
          },
          "RootDevice": {
            "Fn::FindInMap": [
              "OSFeatures",
              {
                "Ref": "BaseOS"
              },
              "RootDevice"
            ]
          },
          "RootVolumeSize": {
            "Ref": "ComputeRootVolumeSize"
          },
          "KeyName": {
            "Ref": "KeyName"
          },
          "MainStackName": {
            "Ref": "AWS::StackName"
          },
          "MainStackUniqueId": {
            "Fn::Select": [
              "2",
              {
                "Fn::Split": [
                  "/",
                  {
                    "Ref": "AWS::StackId"
                  }
                ]
              }
            ]
          },
          "AttributesTagValue": {
            "Fn::Sub": [
              "${BaseOS}, ${Scheduler}, ${version}, ${Architecture}",
              {
                "version": {
                  "Fn::FindInMap": [
                    "PackagesVersions",
                    "default",
                    "parallelcluster"
                  ]
                }
              }
            ]
          },
          "NetworkingTagValue": {
            "Fn::Sub": "EFA=${EFA}"
          },
          "FilesystemTagValue": {
            "Fn::Sub": [
              "efs=${efs}, multiebs=${NumberOfEBSVol}, raid=${raid}, fsx=${fsx}",
              {
                "efs": {
                  "Fn::If": [
                    "CreateEFSSubstack",
                    "1",
                    "0"
                  ]
                },
                "raid": {
                  "Fn::If": [
                    "CreateRAIDSubstack",
                    "1",
                    "0"
                  ]
                },
                "fsx": {
                  "Fn::If": [
                    "CreateFSXSubstack",
                    "1",
                    "0"
                  ]
                }
              }
            ]
          },
          "ImageId": {
            "Fn::If": [
              "UseCustomAMI",
              {
                "Ref": "CustomAMI"
              },
              {
                "Fn::If": [
                  "UseArmAMIs",
                  {
                    "Fn::FindInMap": [
                      "AWSRegionOS2AMIarm64",
                      {
                        "Ref": "AWS::Region"
                      },
                      {
                        "Ref": "BaseOS"
                      }
                    ]
                  },
                  {
                    "Fn::FindInMap": [
                      "AWSRegionOS2AMIx86",
                      {
                        "Ref": "AWS::Region"
                      },
                      {
                        "Ref": "BaseOS"
                      }
                    ]
                  }
                ]
              }
            ]
          },
          "IamInstanceProfile": {
            "Ref": "RootInstanceProfile"
          },
          "BaseOS": {
            "Ref": "BaseOS"
          },
          "OSUser": {
            "Fn::FindInMap": [
              "OSFeatures",
              {
                "Ref": "BaseOS"
              },
              "User"
            ]
          },
          "PreInstallScript": {
            "Ref": "PreInstallScript"
          },
          "PreInstallArgs": {
            "Ref": "PreInstallArgs"
          },
          "PostInstallScript": {
            "Ref": "PostInstallScript"
          },
          "PostInstallArgs": {
            "Ref": "PostInstallArgs"
          },
          "RAIDOptions": {
            "Ref": "RAIDOptions"
          },
          "EFSId": {
            "Fn::If": [
              "CreateEFSSubstack",
              {
                "Fn::GetAtt": [
                  "EFSSubstack",
                  "Outputs.FileSystemId"
                ]
              },
              ""
            ]
          },
          "EFSOptions": {
            "Ref": "EFSOptions"
          },
          "FSXId": {
            "Fn::If": [
              "CreateFSXSubstack",
              {
                "Fn::GetAtt": [
                  "FSXSubstack",
                  "Outputs.FileSystemId"
                ]
              },
              ""
            ]
          },
          "FSXMountName": {
            "Fn::If": [
              "CreateFSXSubstack",
              {
                "Fn::GetAtt": [
                  "FSXSubstack",
                  "Outputs.MountName"
                ]
              },
              ""
            ]
          },
          "FSXDNSName": {
            "Fn::If": [
              "CreateFSXSubstack",
              {
                "Fn::GetAtt": [
                  "FSXSubstack",
                  "Outputs.DNSName"
                ]
              },
              ""
            ]
          },
          "FSXOptions": {
            "Ref": "FSXOptions"
          },
          "Scheduler": {
            "Ref": "Scheduler"
          },
          "EncryptedEphemeral": {
            "Ref": "EncryptedEphemeral"
          },
          "EphemeralDir": {
            "Ref": "EphemeralDir"
          },
          "SharedDir": {
            "Ref": "SharedDir"
          },
          "ProxyServer": {
            "Ref": "ProxyServer"
          },
          "ClusterDNSDomain": {
            "Fn::Sub": [
              "${ClusterName}.pcluster",
              {
                "ClusterName": {
                  "Fn::Select": [
                    "1",
                    {
                      "Fn::Split": [
                        "parallelcluster-",
                        {
                          "Ref": "AWS::StackName"
                        }
                      ]
                    }
                  ]
                }
              }
            ]
          },
          "IntelHPCPlatform": {
            "Ref": "IntelHPCPlatform"
          },
          "CWLoggingEnabled": {
            "Fn::GetAtt": [
              "CloudWatchLogsSubstack",
              "Outputs.Enabled"
            ]
          },
          "ExtraJson": {
            "Ref": "ExtraJson"
          },
          "CustomChefCookbook": {
            "Ref": "CustomChefCookbook"
          },
          "AWSDomain": {
            "Fn::FindInMap": [
              "Partition2Url",
              {
                "Ref": "AWS::Partition"
              },
              "url"
            ]
          },
          "ParallelClusterVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "parallelcluster"
            ]
          },
          "CookbookVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "cookbook"
            ]
          },
          "ChefVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "chef"
            ]
          },
          "BerkshelfVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "berkshelf"
            ]
          },
          "ComputeSecurityGroups": {
            "Fn::Join": [
              ",",
              [
                {
                  "Fn::If": [
                    "CreateSecurityGroups",
                    {
                      "Ref": "ComputeSecurityGroup"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                },
                {
                  "Fn::If": [
                    "AddAdditionalSG",
                    {
                      "Ref": "AdditionalSG"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                },
                {
                  "Fn::If": [
                    "UseExistingSecurityGroup",
                    {
                      "Ref": "VPCSecurityGroupId"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                }
              ]
            ]
          },
          "AssociatePublicIpAddress": {
            "Fn::If": [
              "ComputePublicIps",
              true,
              false
            ]
          },
          "VPCId": {
            "Ref": "VPCId"
          },
          "RootRole": {
            "Fn::If": [
              "UseEC2IAMRole",
              "NONE",
              {
                "Ref": "RootRole"
              }
            ]
          },
          "IAMLambdaRoleName": {
            "Ref": "IAMLambdaRoleName"
          },
          "ResourcesS3Bucket": {
            "Ref": "ResourcesS3Bucket"
          },
          "ArtifactS3RootDirectory": {
            "Ref": "ArtifactS3RootDirectory"
          },
          "UseProvidedResourcesS3Bucket": {
            "Fn::If": [
              "UseProvidedResourcesS3Bucket",
              "true",
              "false"
            ]
          },
          "CreateEC2IAMRole": {
            "Fn::If": [
              "CreateEC2IAMRole",
              "true",
              "false"
            ]
          }
        },
        "TemplateURL": {
          "Fn::Sub": [
            "https://${ResourcesS3Bucket}.s3.${AWS::Region}.${s3_url}/${ArtifactS3RootDirectory}/templates/compute-fleet-hit-substack.rendered.cfn.yaml",
            {
              "s3_url": {
                "Fn::FindInMap": [
                  "Partition2Url",
                  {
                    "Ref": "AWS::Partition"
                  },
                  "url"
                ]
              }
            }
          ]
        }
      },
      "Condition": "CreateHITSubstack"
    },
    "CloudWatchDashboardSubstack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "Parameters": {
          "PclusterStackName": {
            "Ref": "AWS::StackName"
          },
          "CWLogGroupName": {
            "Fn::Sub": [
              "/aws/parallelcluster/${cluster_name}",
              {
                "cluster_name": {
                  "Fn::Select": [
                    "1",
                    {
                      "Fn::Split": [
                        "parallelcluster-",
                        {
                          "Ref": "AWS::StackName"
                        }
                      ]
                    }
                  ]
                }
              }
            ]
          },
          "MasterInstanceId": {
            "Fn::GetAtt": [
              "MasterServerSubstack",
              "Outputs.MasterInstanceID"
            ]
          },
          "MasterPrivateIP": {
            "Fn::GetAtt": [
              "MasterServerSubstack",
              "Outputs.MasterPrivateIP"
            ]
          },
          "EBSVolumesIds": {
            "Fn::GetAtt": [
              "EBSCfnStack",
              "Outputs.Volumeids"
            ]
          },
          "RAIDVolumesIds": {
            "Fn::If": [
              "CreateRAIDSubstack",
              {
                "Fn::GetAtt": [
                  "RAIDSubstack",
                  "Outputs.Volumeids"
                ]
              },
              "NONE"
            ]
          },
          "EFSFileSystemId": {
            "Fn::If": [
              "CreateEFSSubstack",
              {
                "Fn::GetAtt": [
                  "EFSSubstack",
                  "Outputs.FileSystemId"
                ]
              },
              "NONE"
            ]
          },
          "FSXFileSystemId": {
            "Fn::If": [
              "CreateFSXSubstack",
              {
                "Fn::GetAtt": [
                  "FSXSubstack",
                  "Outputs.FileSystemId"
                ]
              },
              "NONE"
            ]
          }
        },
        "TemplateURL": {
          "Fn::Sub": [
            "https://${ResourcesS3Bucket}.s3.${AWS::Region}.${s3_url}/${ArtifactS3RootDirectory}/templates/cw-dashboard-substack.rendered.cfn.yaml",
            {
              "s3_url": {
                "Fn::FindInMap": [
                  "Partition2Url",
                  {
                    "Ref": "AWS::Partition"
                  },
                  "url"
                ]
              }
            }
          ]
        }
      }
    }
  },
  "Outputs": {
    "ClusterUser": {
      "Description": "Username to login to head node",
      "Value": {
        "Fn::FindInMap": [
          "OSFeatures",
          {
            "Ref": "BaseOS"
          },
          "User"
        ]
      }
    },
    "MasterPrivateIP": {
      "Description": "Private IP Address of the head node",
      "Value": {
        "Fn::GetAtt": [
          "MasterServerSubstack",
          "Outputs.MasterPrivateIP"
        ]
      }
    },
    "MasterPublicIP": {
      "Description": "Public IP Address of the head node",
      "Value": {
        "Fn::GetAtt": [
          "MasterServerSubstack",
          "Outputs.MasterPublicIP"
        ]
      },
      "Condition": "MasterPublicIp"
    },
    "GangliaPrivateURL": {
      "Description": "Private URL to access Ganglia (disabled by default)",
      "Value": {
        "Fn::Join": [
          "",
          [
            "http://",
            {
              "Fn::GetAtt": [
                "MasterServerSubstack",
                "Outputs.MasterPrivateIP"
              ]
            },
            "/ganglia/"
          ]
        ]
      }
    },
    "GangliaPublicURL": {
      "Description": "Public URL to access Ganglia (disabled by default)",
      "Value": {
        "Fn::Join": [
          "",
          [
            "http://",
            {
              "Fn::GetAtt": [
                "MasterServerSubstack",
                "Outputs.MasterPublicIP"
              ]
            },
            "/ganglia/"
          ]
        ]
      },
      "Condition": "MasterPublicIp"
    },
    "ResourcesS3Bucket": {
      "Description": "S3 user bucket where AWS ParallelCluster resources are stored",
      "Value": {
        "Ref": "ResourcesS3Bucket"
      }
    },
    "ArtifactS3RootDirectory": {
      "Description": "Root directory in S3 bucket where cluster artifacts are stored",
      "Value": {
        "Ref": "ArtifactS3RootDirectory"
      }
    },
    "BatchComputeEnvironmentArn": {
      "Value": {
        "Fn::GetAtt": [
          "AWSBatchStack",
          "Outputs.ComputeEnvironmentArn"
        ]
      },
      "Condition": "CreateAWSBatchStack"
    },
    "BatchJobQueueArn": {
      "Value": {
        "Fn::GetAtt": [
          "AWSBatchStack",
          "Outputs.JobQueueArn"
        ]
      },
      "Condition": "CreateAWSBatchStack"
    },
    "BatchJobDefinitionArn": {
      "Value": {
        "Fn::GetAtt": [
          "AWSBatchStack",
          "Outputs.JobDefinitionArn"
        ]
      },
      "Condition": "CreateAWSBatchStack"
    },
    "BatchJobDefinitionMnpArn": {
      "Value": {
        "Fn::GetAtt": [
          "AWSBatchStack",
          "Outputs.MNPJobDefinitionArn"
        ]
      },
      "Condition": "CreateAWSBatchStack"
    },
    "BatchUserRole": {
      "Value": {
        "Fn::GetAtt": [
          "AWSBatchStack",
          "Outputs.BatchUserRole"
        ]
      },
      "Condition": "CreateAWSBatchStack"
    },
    "IsHITCluster": {
      "Value": "true",
      "Condition": "CreateHITSubstack"
    },
    "ClusterConfigMetadata": {
      "Value": {
        "Ref": "ClusterConfigMetadata"
      }
    }
  }
}
