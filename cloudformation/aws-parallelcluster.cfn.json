{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "AWS ParallelCluster Template. Version: aws-parallelcluster-2.10.4",
  "Parameters": {
    "KeyName": {
      "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instances using the default cluster user.",
      "Type": "String",
      "Default": "NONE"
    },
    "MasterInstanceType": {
      "Description": "Head node EC2 instance type",
      "Type": "String",
      "ConstraintDescription": "Must be a valid EC2 instance type, with support for HVM."
    },
    "ComputeInstanceType": {
      "Description": "ComputeFleet EC2 instance type",
      "Type": "String",
      "Default": "NONE",
      "ConstraintDescription": "Must be a valid EC2 instance type, with support for HVM."
    },
    "MinSize": {
      "Description": "Initial number of compute EC2 instances / vCpus to launch within the cluster.",
      "Type": "Number",
      "Default": 0
    },
    "DesiredSize": {
      "Description": "Desired number of compute EC2 instances / vCpus to launch within the cluster.",
      "Type": "Number",
      "Default": 0
    },
    "MaxSize": {
      "Description": "Maximum number of compute EC2 instances / vCpus to launch within the cluster.",
      "Type": "Number",
      "Default": 0
    },
    "ComputeSubnetId": {
      "Description": "ID of the Subnet you want to provision the Compute Servers into",
      "Type": "String",
      "Default": "NONE",
      "AllowedPattern": "(NONE|^subnet-[0-9a-z]{8}$|^subnet-[0-9a-z]{17}$)"
    },
    "SpotPrice": {
      "Description": "Spot bid price for the ComputeFleet AutoScaling Group when the ClusterType = \"spot\". When awsbatch is the scheduler, this is spot bid percentage.",
      "Type": "Number",
      "Default": "0"
    },
    "ClusterType": {
      "Description": "Type of cluster to launch. Can either be \"ondemand\" or \"spot\". Choosing \"spot\" will cause the ComputeFleet AutoScaling group to launch EC2 Spot instances. Default value is \"ondemand\".",
      "Type": "String",
      "Default": "ondemand",
      "ConstraintDescription": "Must be a supported cluster type: ondemand, spot",
      "AllowedValues": [
        "ondemand",
        "spot"
      ]
    },
    "ProxyServer": {
      "Description": "hostname and port of HTTP proxy server for cfn-init, boto and yum i.e. proxy.example.com:8080",
      "Type": "String",
      "Default": "NONE"
    },
    "VolumeSize": {
      "Description": "Comma delimited list of size of EBS volume in GB, if creating a new one",
      "Type": "String",
      "Default": "NONE,NONE,NONE,NONE,NONE"
    },
    "VolumeType": {
      "Description": "Comma delimited list of type of volume to create either new or from snapshot",
      "Type": "String",
      "Default": "gp2,gp2,gp2,gp2,gp2",
      "ConstraintDescription": "must be a supported volume type: standard, io1, io2, gp2, gp3, st1, sc1",
      "AllowedPattern": "^(NONE|standard|io1|io2|gp2|gp3|st1|sc1)((,|, )(NONE|standard|io1|io2|gp2|gp3|st1|sc1)){4}$"
    },
    "MasterSubnetId": {
      "Description": "ID of the Subnet you want to provision the head node into",
      "Type": "AWS::EC2::Subnet::Id"
    },
    "AvailabilityZone": {
      "Description": "Availability Zone the cluster will launch into. THIS IS REQUIRED",
      "Type": "AWS::EC2::AvailabilityZone::Name"
    },
    "EBSSnapshotId": {
      "Description": "Comma delimited list of Id of EBS snapshot if using snapshot as source for volume",
      "Type": "String",
      "Default": "NONE,NONE,NONE,NONE,NONE",
      "AllowedPattern": "^(NONE|snap-[0-9a-z]{8}|snap-[0-9a-z]{17})((,|, )(NONE|snap-[0-9a-z]{8}|snap-[0-9a-z]{17})){4}$"
    },
    "CustomAMI": {
      "Description": "ID of a Custom AMI, to use instead of published AMI's",
      "Type": "String",
      "Default": "NONE",
      "AllowedPattern": "(NONE|^ami-[0-9a-z]{8}$|^ami-[0-9a-z]{17}$)"
    },
    "VPCId": {
      "Description": "ID of the VPC you want to provision cluster into. Only used with UseVPCBase=false",
      "Type": "AWS::EC2::VPC::Id"
    },
    "AccessFrom": {
      "Description": "Lockdown SSH/HTTP access (default can be accessed from anywhere)",
      "Type": "String",
      "MinLength": "9",
      "MaxLength": "18",
      "Default": "0.0.0.0/0",
      "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription": "must be a valid CIDR range of the form x.x.x.x/x."
    },
    "ComputeSubnetCidr": {
      "Description": "CIDR(s) for new backend subnet(s) i.e. 10.0.100.0/24. This is a comma-delimited list and can support multiple CIDR ranges for a multi-AZ cluster. The order and length of this list MUST match the AvailabilityZones parameter.",
      "Type": "String",
      "ConstraintDescription": "must be a valid CIDR range of the form x.x.x.x/x.",
      "AllowedPattern": "(NONE|(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2}))",
      "Default": "NONE"
    },
    "UsePublicIps": {
      "Description": "Boolean flag to use public IP's for instances. If false, the VPC must be correctly setup to use NAT for all traffic.",
      "Type": "String",
      "Default": "true",
      "ConstraintDescription": "true/false",
      "AllowedValues": [
        "true",
        "false"
      ]
    },
    "VolumeIOPS": {
      "Description": "Comma delimited list of number of IOPS for volume type io1, io2 and gp3. Not used for other volume types.",
      "Type": "String",
      "Default": "NONE,NONE,NONE,NONE,NONE"
    },
    "VolumeThroughput": {
      "Description": "Comma delimited list of number of Throughtput for volume type gp3. Not used for other volume types.",
      "Type": "String",
      "Default": "125,125,125,125,125"
    },
    "PreInstallScript": {
      "Description": "Preinstall script URL. This is run before any host configuration.",
      "Type": "String",
      "Default": "NONE"
    },
    "PostInstallScript": {
      "Description": "Postinstall script URL. This is run before any host configuration.",
      "Type": "String",
      "Default": "NONE"
    },
    "S3ReadResource": {
      "Description": "S3 resource with read access from AWS ParallelCluster nodes",
      "Type": "String",
      "Default": "NONE"
    },
    "S3ReadWriteResource": {
      "Description": "Addtional policy document to be added to EC2 IAM role created and assigned to all nodes.",
      "Type": "String",
      "Default": "NONE"
    },
    "Placement": {
      "Description": "Type of placement requird in AWS ParallelCluster, it can either be cluster or compute.",
      "Type": "String",
      "Default": "compute",
      "AllowedValues": [
        "cluster",
        "compute"
      ]
    },
    "PlacementGroup": {
      "Description": "The name of an existing placement group",
      "Type": "String",
      "Default": "NONE"
    },
    "EncryptedEphemeral": {
      "Description": "Boolean flag to encrypt local ephemeral drives. The keys are in-memory and non-recoverable.",
      "Type": "String",
      "Default": "false",
      "ConstraintDescription": "true/false",
      "AllowedValues": [
        "true",
        "false"
      ]
    },
    "PreInstallArgs": {
      "Description": "Preinstall script args passed to the preinstall script.",
      "Type": "String",
      "Default": "NONE"
    },
    "PostInstallArgs": {
      "Description": "Postinstall script args passed to the postinstall script.",
      "Type": "String",
      "Default": "NONE"
    },
    "EBSEncryption": {
      "Description": "Comma delimited list of boolean flag to use EBS encryption for /shared volume. (Not to be used for snapshots)",
      "Type": "String",
      "Default": "false,false,false,false,false",
      "ConstraintDescription": "true/false",
      "AllowedPattern": "^(NONE|true|false)((,|, )(NONE|true|false)){4}$"
    },
    "EphemeralDir": {
      "Description": "The path/mountpoint for the ephemeral drive",
      "Type": "String",
      "Default": "/scratch"
    },
    "BaseOS": {
      "Description": "Base OS type for cluster AMI",
      "Type": "String",
      "Default": "alinux2",
      "ConstraintDescription": "must be a supported base OS",
      "AllowedValues": [
        "centos7",
        "centos8",
        "alinux2",
        "ubuntu1804",
        "ubuntu2004"
      ]
    },
    "Architecture": {
      "Description": "Architecture to use when selecting default AMIs",
      "Type": "String",
      "Default": "x86_64",
      "ConstraintDescription": "Must be either x86_64 or arm64",
      "AllowedValues": [
        "x86_64",
        "arm64"
      ]
    },
    "ScaleDownIdleTime": {
      "Description": "Period in minutes without jobs after which compute node will terminate ",
      "Type": "String",
      "Default": "10"
    },
    "Scheduler": {
      "Description": "Cluster scheduler",
      "Type": "String",
      "Default": "slurm",
      "ConstraintDescription": "must be a supported scheduler",
      "AllowedValues": [
        "sge",
        "torque",
        "slurm",
        "awsbatch"
      ]
    },
    "SharedDir": {
      "Description": "The path/mountpoint for the shared drive",
      "Type": "String",
      "Default": "/shared"
    },
    "ClusterConfigMetadata": {
      "Description": "Cluster configuration metadata.",
      "Type": "String",
      "Default": "{}"
    },
    "AdditionalSG": {
      "Description": "Additional VPC security group to be added to instances. Defaults to NONE",
      "Type": "String",
      "Default": "NONE",
      "AllowedPattern": "(NONE|^sg-[0-9a-z]{8}$|^sg-[0-9a-z]{17}$)"
    },
    "CustomChefCookbook": {
      "Description": "URL of custom cookbook that will override the default. This will be unpacked and then dependencies resolved with Berkshelf.",
      "Type": "String",
      "Default": "NONE"
    },
    "ExtraJson": {
      "Description": "Extra json to be added to Chef dna.json",
      "Type": "String",
      "Default": "{}"
    },
    "EBSKMSKeyId": {
      "Description": "Comma delimited list of KMS ARN for customer created master key, will be used for EBS encryption",
      "Type": "String",
      "Default": "NONE,NONE,NONE,NONE,NONE"
    },
    "MasterRootVolumeSize": {
      "Description": "Size of head node EBS root volume in GB",
      "Type": "Number",
      "Default": "35",
      "MinValue": "35"
    },
    "ComputeRootVolumeSize": {
      "Description": "Size of ComputeFleet EBS root volume in GB",
      "Type": "Number",
      "Default": "35",
      "MinValue": "35"
    },
    "EC2IAMRoleName": {
      "Description": "Existing EC2 IAM role name",
      "Type": "String",
      "Default": "NONE"
    },
    "EC2IAMPolicies": {
      "Description": "Attach additional IAM Policies to the created Root Role",
      "Type": "CommaDelimitedList",
      "Default": "NONE"
    },
    "IAMLambdaRoleName": {
      "Description": "Existing IAM role name for Lambda functions",
      "Type": "String",
      "Default": "NONE"
    },
    "VPCSecurityGroupId": {
      "Description": "Existing VPC security group Id",
      "Type": "String",
      "Default": "NONE",
      "AllowedPattern": "(NONE|^sg-[0-9a-z]{8}$|^sg-[0-9a-z]{17}$)"
    },
    "EBSVolumeId": {
      "Description": "Comma delimited list of existing EBS volume Id",
      "Type": "String",
      "Default": "NONE,NONE,NONE,NONE,NONE",
      "AllowedPattern": "^(NONE|vol-[0-9a-z]{8}|vol-[0-9a-z]{17})((,|, )(NONE|vol-[0-9a-z]{8}|vol-[0-9a-z]{17})){4}$"
    },
    "AdditionalCfnTemplate": {
      "Description": "A second CloudFormation template to launch with the cluster",
      "Type": "String",
      "Default": "NONE"
    },
    "ResourcesS3Bucket": {
      "Description": "S3 bucket where resources needed by the stack are located. The bucket gets deleted on stack deletion if it is not user-provided.",
      "Type": "String"
    },
    "ArtifactS3RootDirectory": {
      "Description": "Root directory in S3 bucket where cluster artifacts are stored, i.e. cluster artifacts would be under {ResourcesS3Bucket}/{ArtifactS3RootDirectory}.",
      "Type": "String"
    },
    "RemoveBucketOnDeletion": {
      "Description": "Parameter to control if bucket is removed on cluster deletion. pcluster created buckets are alway removed, user provided buckets are kept.",
      "Type": "String"
    },
    "RAIDOptions": {
      "Description": "Comma Separated List of RAID related options, 9 parameters in total, [shared_dir,raid_type,num_of_raid_volumes,volume_type,volume_size,volume_iops,encrypted,ebs_kms_key_id,volume_throughput]",
      "Type": "String",
      "Default": "NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE",
      "AllowedPattern": "^(NONE|.+)(,|, )(NONE|\\d)(,|, )(NONE|\\d)(,|, )(NONE|standard|io1|io2|gp2|gp3|st1|sc1)(,|, )(NONE|\\d+)(,|, )(NONE|\\d+)(,|, )(NONE|true|false)(,|, )(NONE|.+)(,|, )(NONE|\\d+)$"
    },
    "NumberOfEBSVol": {
      "Description": "Number of EBS Volumes the user requested, up to 5",
      "Type": "Number",
      "Default": "1"
    },
    "FSXOptions": {
      "Description": "Comma separated list of FSx related options, 19 parameters in total, [shared_dir,fsx_fs_id,storage_capacity,fsx_kms_key_id,imported_file_chunk_size,export_path,import_path,weekly_maintenance_start_time,deployment_type,per_unit_storage_throughput,daily_automatic_backup_start_time,automatic_backup_retention_days,copy_tags_to_backups,fsx_backup_id,auto_import_policy,storage_type,drive_cache_type,existing_mount_name,existing_dns_name]",
      "Type": "String",
      "Default": "NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE"
    },
    "EFSOptions": {
      "Description": "Comma separated list of EFS related options, 9 parameters in total, [shared_dir,efs_fs_id,performance_mode,efs_kms_key_id,provisioned_throughput,encrypted,throughput_mode,exists_valid_head_node_mt,exists_valid_compute_mt]",
      "Type": "String",
      "Default": "NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE"
    },
    "Cores": {
      "Description": "Comma seperated string of [head node cores], [compute cores], [head node instance type supports disabling hyperthreading via CPU options], [compute instance type supports disabling hyperthreading via CPU options].",
      "Type": "CommaDelimitedList",
      "Default": "NONE,NONE,NONE,NONE"
    },
    "EFA": {
      "Description": "Enable EFA on the compute nodes, enable_efa = compute",
      "Type": "String",
      "Default": "NONE"
    },
    "EFAGDR": {
      "Description": "Enable EFA GPUDirect Support on the compute nodes, enable_efa_gdr = compute",
      "Type": "String",
      "Default": "NONE"
    },
    "DCVOptions": {
      "Description": "Comma separated list of NICE DCV related options, 3 parameters in total, [enabled,port,access_from]",
      "Type": "String",
      "Default": "NONE,NONE,NONE"
    },
    "IntelHPCPlatform": {
      "Description": "Enable Intel HPC Platform packages.",
      "Type": "String",
      "AllowedValues": [
        "true",
        "false"
      ]
    },
    "CWLogOptions": {
      "Description": "Comma separated list of CloudWatch logging, 2 parameters in total, [enabled, retention_days]",
      "Type": "String",
      "Default": "true,14"
    },
    "NetworkInterfacesCount": {
      "Description": "Comma separated string of [head node network interfaces], [compute network interfaces].",
      "Type": "CommaDelimitedList",
      "Default": "1,1"
    },
    "InstanceTypesData": {
      "Description": "Json string with information about instance types, as returned from EC2 describe-instance-types",
      "Type": "String",
      "Default": "{}"
    }
  },
  "Conditions": {
    "CreateEFSSubstack": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "0",
                {
                  "Fn::Split": [
                    ",",
                    {
                      "Ref": "EFSOptions"
                    }
                  ]
                }
              ]
            },
            "NONE"
          ]
        }
      ]
    },
    "CreateRAIDSubstack": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            "NONE",
            {
              "Fn::Select": [
                "0",
                {
                  "Fn::Split": [
                    ",",
                    {
                      "Ref": "RAIDOptions"
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    "CreateFSXSubstack": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "0",
                {
                  "Fn::Split": [
                    ",",
                    {
                      "Ref": "FSXOptions"
                    }
                  ]
                }
              ]
            },
            "NONE"
          ]
        }
      ]
    },
    "UseSpotPrice": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "SpotPrice"
            },
            "0"
          ]
        }
      ]
    },
    "CreateComputeSubnetForCompute": {
      "Fn::And": [
        {
          "Fn::Equals": [
            {
              "Ref": "ComputeSubnetId"
            },
            "NONE"
          ]
        },
        {
          "Fn::Not": [
            {
              "Fn::Equals": [
                {
                  "Ref": "ComputeSubnetCidr"
                },
                "NONE"
              ]
            }
          ]
        }
      ]
    },
    "UseMasterSubnetForCompute": {
      "Fn::Or": [
        {
          "Fn::And": [
            {
              "Fn::Equals": [
                {
                  "Ref": "ComputeSubnetId"
                },
                "NONE"
              ]
            },
            {
              "Fn::Equals": [
                {
                  "Ref": "ComputeSubnetCidr"
                },
                "NONE"
              ]
            }
          ]
        },
        {
          "Fn::Equals": [
            {
              "Ref": "ComputeSubnetId"
            },
            {
              "Ref": "MasterSubnetId"
            }
          ]
        }
      ]
    },
    "UseCustomAMI": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "CustomAMI"
            },
            "NONE"
          ]
        }
      ]
    },
    "MasterPublicIp": {
      "Fn::Equals": [
        {
          "Ref": "UsePublicIps"
        },
        "true"
      ]
    },
    "ComputePublicIps": {
      "Fn::And": [
        {
          "Fn::Equals": [
            {
              "Ref": "UsePublicIps"
            },
            "true"
          ]
        },
        {
          "Condition": "UseMasterSubnetForCompute"
        }
      ]
    },
    "UseS3ReadPolicy": {
      "Fn::And": [
        {
          "Fn::Not": [
            {
              "Fn::Equals": [
                {
                  "Ref": "S3ReadResource"
                },
                "NONE"
              ]
            }
          ]
        },
        {
          "Condition": "CreateEC2IAMRole"
        }
      ]
    },
    "UsePlacementGroup": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "PlacementGroup"
            },
            "NONE"
          ]
        }
      ]
    },
    "UseClusterPlacement": {
      "Fn::And": [
        {
          "Fn::Equals": [
            {
              "Ref": "Placement"
            },
            "cluster"
          ]
        },
        {
          "Condition": "UsePlacementGroup"
        }
      ]
    },
    "UseS3ReadWritePolicy": {
      "Fn::And": [
        {
          "Fn::Not": [
            {
              "Fn::Equals": [
                {
                  "Ref": "S3ReadWriteResource"
                },
                "NONE"
              ]
            }
          ]
        },
        {
          "Condition": "CreateEC2IAMRole"
        }
      ]
    },
    "AddAdditionalSG": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AdditionalSG"
            },
            "NONE"
          ]
        }
      ]
    },
    "UseEC2IAMRole": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "EC2IAMRoleName"
            },
            "NONE"
          ]
        }
      ]
    },
    "UseEC2IAMPolicies": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "0",
                {
                  "Ref": "EC2IAMPolicies"
                }
              ]
            },
            "NONE"
          ]
        }
      ]
    },
    "CreateEC2IAMRole": {
      "Fn::Equals": [
        {
          "Ref": "EC2IAMRoleName"
        },
        "NONE"
      ]
    },
    "CreateIAMLambdaRole": {
      "Fn::Equals": [
        {
          "Ref": "IAMLambdaRoleName"
        },
        "NONE"
      ]
    },
    "UseExistingSecurityGroup": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "VPCSecurityGroupId"
            },
            "NONE"
          ]
        }
      ]
    },
    "CreateSecurityGroups": {
      "Fn::Equals": [
        {
          "Ref": "VPCSecurityGroupId"
        },
        "NONE"
      ]
    },
    "CreateSubStack": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AdditionalCfnTemplate"
            },
            "NONE"
          ]
        }
      ]
    },
    "CreatePlacementGroup": {
      "Fn::And": [
        {
          "Fn::Equals": [
            {
              "Ref": "PlacementGroup"
            },
            "DYNAMIC"
          ]
        },
        {
          "Condition": "UsePlacementGroup"
        },
        {
          "Fn::Not": [
            {
              "Condition": "CreateHITSubstack"
            }
          ]
        }
      ]
    },
    "CreateComputeFleet": {
      "Fn::Not": [
        {
          "Fn::Or": [
            {
              "Fn::Equals": [
                {
                  "Ref": "Scheduler"
                },
                "awsbatch"
              ]
            },
            {
              "Condition": "CreateHITSubstack"
            }
          ]
        }
      ]
    },
    "CreateHITSubstack": {
      "Fn::Equals": [
        {
          "Ref": "Scheduler"
        },
        "slurm"
      ]
    },
    "CreateAWSBatchStack": {
      "Fn::Equals": [
        {
          "Ref": "Scheduler"
        },
        "awsbatch"
      ]
    },
    "EnableDCV": {
      "Fn::Equals": [
        {
          "Fn::Select": [
            "0",
            {
              "Fn::Split": [
                ",",
                {
                  "Ref": "DCVOptions"
                }
              ]
            }
          ]
        },
        "master"
      ]
    },
    "UseArmAMIs": {
      "Fn::Equals": [
        {
          "Ref": "Architecture"
        },
        "arm64"
      ]
    },
    "UseProvidedResourcesS3Bucket": {
      "Fn::Equals": [
        {
          "Ref": "RemoveBucketOnDeletion"
        },
        "False"
      ]
    }
  },
  "Mappings": {
    "AWSRegionOS2AMIarm64": {
      "af-south-1": {
        "alinux2": "ami-0ae8652bd168684f3",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-0d8410c47fc3112e0",
        "ubuntu1804": "ami-09037fe1c42341264",
        "ubuntu2004": "UNSUPPORTED"
      },
      "ap-east-1": {
        "alinux2": "ami-05f622f2fa7c4c305",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-0bce52242167b32ff",
        "ubuntu1804": "ami-0c96ab82a56224d70",
        "ubuntu2004": "UNSUPPORTED"
      },
      "ap-northeast-1": {
        "alinux2": "ami-054390b522f9d6b55",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-0326091ad900b6ae6",
        "ubuntu1804": "ami-085bea02e79a275e7",
        "ubuntu2004": "UNSUPPORTED"
      },
      "ap-northeast-2": {
        "alinux2": "ami-05ca3f3af04970c7b",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-0cbf14503529037ac",
        "ubuntu1804": "ami-0442d4cfe553d6bd5",
        "ubuntu2004": "UNSUPPORTED"
      },
      "ap-northeast-3": {
        "alinux2": "UNSUPPORTED",
        "centos7": "UNSUPPORTED",
        "centos8": "UNSUPPORTED",
        "ubuntu1804": "UNSUPPORTED",
        "ubuntu2004": "UNSUPPORTED"
      },
      "ap-south-1": {
        "alinux2": "ami-0b25ef945709f5579",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-01600e672cfee57ee",
        "ubuntu1804": "ami-06818818b274d154f",
        "ubuntu2004": "UNSUPPORTED"
      },
      "ap-southeast-1": {
        "alinux2": "ami-01876b73270099d01",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-017fd95ac6d2eb895",
        "ubuntu1804": "ami-08a6fcbc9c129dee7",
        "ubuntu2004": "UNSUPPORTED"
      },
      "ap-southeast-2": {
        "alinux2": "ami-021c97acdaeefa550",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-0fb175eb0fb41f248",
        "ubuntu1804": "ami-071157ca383286292",
        "ubuntu2004": "UNSUPPORTED"
      },
      "ca-central-1": {
        "alinux2": "ami-01cc5030fd1239fe7",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-085b789a3061fab78",
        "ubuntu1804": "ami-06207e8ed2e97394c",
        "ubuntu2004": "UNSUPPORTED"
      },
      "cn-north-1": {
        "alinux2": "ami-0a4381163ee1f004f",
        "centos7": "UNSUPPORTED",
        "centos8": "UNSUPPORTED",
        "ubuntu1804": "ami-0582fcf140044dcd7",
        "ubuntu2004": "UNSUPPORTED"
      },
      "cn-northwest-1": {
        "alinux2": "ami-04edf9397d06b1b98",
        "centos7": "UNSUPPORTED",
        "centos8": "UNSUPPORTED",
        "ubuntu1804": "ami-0cc92afadad348a45",
        "ubuntu2004": "UNSUPPORTED"
      },
      "eu-central-1": {
        "alinux2": "ami-046f617a9c90130fd",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-062219530533a937e",
        "ubuntu1804": "ami-0390471e8a95dccbc",
        "ubuntu2004": "UNSUPPORTED"
      },
      "eu-north-1": {
        "alinux2": "ami-03dba52d81e513071",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-09daecf523450087f",
        "ubuntu1804": "ami-0dac54546a6b8239a",
        "ubuntu2004": "UNSUPPORTED"
      },
      "eu-south-1": {
        "alinux2": "ami-06cbdc297c2b3c597",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-06c7f17ecf0d1912d",
        "ubuntu1804": "ami-0fa57e8469cfbc71e",
        "ubuntu2004": "UNSUPPORTED"
      },
      "eu-west-1": {
        "alinux2": "ami-00c2aad506cc966c2",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-0bfc1302346fc0bdd",
        "ubuntu1804": "ami-022355730feadc8ed",
        "ubuntu2004": "UNSUPPORTED"
      },
      "eu-west-2": {
        "alinux2": "ami-01c1c956ab6b1a5e2",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-0a554cfbc6f493b8b",
        "ubuntu1804": "ami-0df11f238c365de84",
        "ubuntu2004": "UNSUPPORTED"
      },
      "eu-west-3": {
        "alinux2": "ami-0edaa940720047009",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-07f9ee48b3275134d",
        "ubuntu1804": "ami-074e3d19d16a792e8",
        "ubuntu2004": "UNSUPPORTED"
      },
      "me-south-1": {
        "alinux2": "ami-0cd0a5dea72889081",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-02d5107f066b0b734",
        "ubuntu1804": "ami-0c554b35d53ad3ebf",
        "ubuntu2004": "UNSUPPORTED"
      },
      "sa-east-1": {
        "alinux2": "ami-02c01e930efc305fb",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-043cee8474e331f15",
        "ubuntu1804": "ami-0a76484b50f285c87",
        "ubuntu2004": "UNSUPPORTED"
      },
      "us-east-1": {
        "alinux2": "ami-00c32efc4e86df429",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-0012b0e32aeeb20bc",
        "ubuntu1804": "ami-0c39beb7642835b23",
        "ubuntu2004": "UNSUPPORTED"
      },
      "us-east-2": {
        "alinux2": "ami-0d0b42c26da3de35e",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-0b4fa48a1683f863f",
        "ubuntu1804": "ami-08c3a90b143349b7d",
        "ubuntu2004": "UNSUPPORTED"
      },
      "us-gov-east-1": {
        "alinux2": "ami-0159e9d1b85f662a9",
        "centos7": "UNSUPPORTED",
        "centos8": "UNSUPPORTED",
        "ubuntu1804": "ami-0dfa1a7bd99115541",
        "ubuntu2004": "UNSUPPORTED"
      },
      "us-gov-west-1": {
        "alinux2": "ami-0c45b37651d914887",
        "centos7": "UNSUPPORTED",
        "centos8": "UNSUPPORTED",
        "ubuntu1804": "ami-08c53d6c71a0a7a86",
        "ubuntu2004": "UNSUPPORTED"
      },
      "us-west-1": {
        "alinux2": "ami-09095fb50533f8bac",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-0c56f4d1503d0eac6",
        "ubuntu1804": "ami-032452eb8eab63a5d",
        "ubuntu2004": "UNSUPPORTED"
      },
      "us-west-2": {
        "alinux2": "ami-0b98e2b1f524778dc",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-08f28b0c18a48620c",
        "ubuntu1804": "ami-06733b488c5ca2d78",
        "ubuntu2004": "UNSUPPORTED"
      }
    },
    "AWSRegionOS2AMIx86": {
      "af-south-1": {
        "alinux2": "ami-0492363e938a0a97e",
        "centos7": "ami-0ac62a0e823c8c42e",
        "centos8": "ami-004fa354de5065c5b",
        "ubuntu1804": "ami-0ae93c07553adfc4f",
        "ubuntu2004": "UNSUPPORTED"
      },
      "ap-east-1": {
        "alinux2": "ami-06f42bcea8114c8be",
        "centos7": "ami-0d9a73d7e905cdf92",
        "centos8": "ami-03a80478bb498d067",
        "ubuntu1804": "ami-06127ee6e8c5aead8",
        "ubuntu2004": "UNSUPPORTED"
      },
      "ap-northeast-1": {
        "alinux2": "ami-0833248af2d826f84",
        "centos7": "ami-0ddd78201f66fed77",
        "centos8": "ami-0333dc86fb0a479d3",
        "ubuntu1804": "ami-055b5f7c8b888d85e",
        "ubuntu2004": "UNSUPPORTED"
      },
      "ap-northeast-2": {
        "alinux2": "ami-04b65ff2bb5f7c167",
        "centos7": "ami-0e03b07c86087b7c3",
        "centos8": "ami-056c2362d29850c83",
        "ubuntu1804": "ami-02fa29a113072f4bd",
        "ubuntu2004": "UNSUPPORTED"
      },
      "ap-northeast-3": {
        "alinux2": "UNSUPPORTED",
        "centos7": "UNSUPPORTED",
        "centos8": "UNSUPPORTED",
        "ubuntu1804": "UNSUPPORTED",
        "ubuntu2004": "UNSUPPORTED"
      },
      "ap-south-1": {
        "alinux2": "ami-076df33ecf633c513",
        "centos7": "ami-00a32cadcf734d224",
        "centos8": "ami-066d1ec3742f0d145",
        "ubuntu1804": "ami-0eeb4441d3cb369ae",
        "ubuntu2004": "UNSUPPORTED"
      },
      "ap-southeast-1": {
        "alinux2": "ami-003ba8880edd465a4",
        "centos7": "ami-04d26a15b5364c9bb",
        "centos8": "ami-09cb42c339f5a5586",
        "ubuntu1804": "ami-0c19691fd10c9450e",
        "ubuntu2004": "UNSUPPORTED"
      },
      "ap-southeast-2": {
        "alinux2": "ami-0aed9829b5a29d091",
        "centos7": "ami-0698b03d06ab04975",
        "centos8": "ami-00290ba14fbcfe206",
        "ubuntu1804": "ami-04308f8c46c0369f5",
        "ubuntu2004": "UNSUPPORTED"
      },
      "ca-central-1": {
        "alinux2": "ami-0df96d96b03f3db26",
        "centos7": "ami-041055ac2346e5299",
        "centos8": "ami-0fdaf3ffdc422f7ce",
        "ubuntu1804": "ami-04fcfce08c6273e21",
        "ubuntu2004": "UNSUPPORTED"
      },
      "cn-north-1": {
        "alinux2": "ami-0101f31fbdcd7a97b",
        "centos7": "UNSUPPORTED",
        "centos8": "UNSUPPORTED",
        "ubuntu1804": "ami-04411bc152945662d",
        "ubuntu2004": "UNSUPPORTED"
      },
      "cn-northwest-1": {
        "alinux2": "ami-01d3295801c18a7ca",
        "centos7": "UNSUPPORTED",
        "centos8": "UNSUPPORTED",
        "ubuntu1804": "ami-08a54b16a0bae581e",
        "ubuntu2004": "UNSUPPORTED"
      },
      "eu-central-1": {
        "alinux2": "ami-0edca376e1abcee1e",
        "centos7": "ami-0213a3307c0c4e08c",
        "centos8": "ami-0448393d2a0ed6691",
        "ubuntu1804": "ami-0b25399c43b1e6073",
        "ubuntu2004": "UNSUPPORTED"
      },
      "eu-north-1": {
        "alinux2": "ami-0f20bc4f0a2e53704",
        "centos7": "ami-0ac31d064f0e20a24",
        "centos8": "ami-001aa7910f00c9118",
        "ubuntu1804": "ami-04cefe480409bb100",
        "ubuntu2004": "UNSUPPORTED"
      },
      "eu-south-1": {
        "alinux2": "ami-0999ab2b50fe268e8",
        "centos7": "ami-06932fae07d685394",
        "centos8": "ami-0dc8f9bab39e1c030",
        "ubuntu1804": "ami-01017e46f294de104",
        "ubuntu2004": "UNSUPPORTED"
      },
      "eu-west-1": {
        "alinux2": "ami-0960a2b2bc3354e21",
        "centos7": "ami-01725f8a02a13db16",
        "centos8": "ami-0be7ce1b2009c48d7",
        "ubuntu1804": "ami-082fc76bae38d94f6",
        "ubuntu2004": "UNSUPPORTED"
      },
      "eu-west-2": {
        "alinux2": "ami-09af88b3c29693ebb",
        "centos7": "ami-076656441e97a8b14",
        "centos8": "ami-0fb02cfe2b0393700",
        "ubuntu1804": "ami-07fe00ff90675f471",
        "ubuntu2004": "UNSUPPORTED"
      },
      "eu-west-3": {
        "alinux2": "ami-0d189c087b57e2f34",
        "centos7": "ami-00dd73ecac5423335",
        "centos8": "ami-09f9f4c17a08a121a",
        "ubuntu1804": "ami-03ecd5d0bbc65018f",
        "ubuntu2004": "UNSUPPORTED"
      },
      "me-south-1": {
        "alinux2": "ami-0902401acd7fdea89",
        "centos7": "ami-05ffbe7bd5e3095d6",
        "centos8": "ami-0acce2ed315358503",
        "ubuntu1804": "ami-0a811b7ac2b870ef4",
        "ubuntu2004": "UNSUPPORTED"
      },
      "sa-east-1": {
        "alinux2": "ami-0f1b13c34f777b326",
        "centos7": "ami-044e0736104925db7",
        "centos8": "ami-041c1a1cd3afea1ba",
        "ubuntu1804": "ami-0351cb8e2c34772ec",
        "ubuntu2004": "UNSUPPORTED"
      },
      "us-east-1": {
        "alinux2": "ami-043bed31bde73d741",
        "centos7": "ami-0dd5f4f618a061968",
        "centos8": "ami-0598a2f18554d1972",
        "ubuntu1804": "ami-095348d25d5081d12",
        "ubuntu2004": "UNSUPPORTED"
      },
      "us-east-2": {
        "alinux2": "ami-00d8bdc53d410b012",
        "centos7": "ami-05690d4a043d92860",
        "centos8": "ami-0346552e1584e526e",
        "ubuntu1804": "ami-00c145829972fe4f8",
        "ubuntu2004": "UNSUPPORTED"
      },
      "us-gov-east-1": {
        "alinux2": "ami-0e25153391dbabb76",
        "centos7": "UNSUPPORTED",
        "centos8": "UNSUPPORTED",
        "ubuntu1804": "ami-0328268dd2788cdd3",
        "ubuntu2004": "UNSUPPORTED"
      },
      "us-gov-west-1": {
        "alinux2": "ami-0576f9d3f2f7fd25d",
        "centos7": "UNSUPPORTED",
        "centos8": "UNSUPPORTED",
        "ubuntu1804": "ami-01c024579c1ee8aa8",
        "ubuntu2004": "UNSUPPORTED"
      },
      "us-west-1": {
        "alinux2": "ami-0f1328eb1e03d7fb2",
        "centos7": "ami-04ce60aea4137705b",
        "centos8": "ami-030eb79b692fdfd0a",
        "ubuntu1804": "ami-071d4e66f7384c51a",
        "ubuntu2004": "UNSUPPORTED"
      },
      "us-west-2": {
        "alinux2": "ami-0810fa0629dfa72aa",
        "centos7": "ami-002aec2dda2fa4123",
        "centos8": "ami-0b3c4ad599894cef9",
        "ubuntu1804": "ami-060036528b540166e",
        "ubuntu2004": "UNSUPPORTED"
      }
    },
    "OSFeatures": {
      "centos7": {
        "User": "centos",
        "RootDevice": "/dev/sda1"
      },
      "centos8": {
        "User": "centos",
        "RootDevice": "/dev/sda1"
      },
      "alinux2": {
        "User": "ec2-user",
        "RootDevice": "/dev/xvda"
      },
      "ubuntu1804": {
        "User": "ubuntu",
        "RootDevice": "/dev/sda1"
      },
      "ubuntu2004": {
        "User": "ubuntu",
        "RootDevice": "/dev/sda1"
      }
    },
    "PackagesVersions": {
      "default": {
        "parallelcluster": "2.10.4",
        "cookbook": "aws-parallelcluster-cookbook-2.10.4",
        "chef": "16.13.16",
        "berkshelf": "7.0.10",
        "ami": "dev"
      }
    },
    "Partition2Url": {
      "aws": {
        "url": "amazonaws.com"
      },
      "aws-us-gov": {
        "url": "amazonaws.com"
      },
      "aws-cn": {
        "url": "amazonaws.com.cn"
      }
    }
  },
  "Resources": {
    "EFSSubstack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "Parameters": {
          "EFSOptions": {
            "Ref": "EFSOptions"
          },
          "ComputeSecurityGroup": {
            "Fn::If": [
              "CreateSecurityGroups",
              {
                "Ref": "ComputeSecurityGroup"
              },
              {
                "Ref": "VPCSecurityGroupId"
              }
            ]
          },
          "MasterSubnetId": {
            "Ref": "MasterSubnetId"
          },
          "ComputeSubnetId": {
            "Ref": "ComputeSubnetId"
          }
        },
        "TemplateURL": {
          "Fn::Sub": [
            "https://${AWS::Region}-aws-parallelcluster.s3.${AWS::Region}.${s3_url}/templates/efs-substack-${version}.cfn.json",
            {
              "s3_url": {
                "Fn::FindInMap": [
                  "Partition2Url",
                  {
                    "Ref": "AWS::Partition"
                  },
                  "url"
                ]
              },
              "version": {
                "Fn::FindInMap": [
                  "PackagesVersions",
                  "default",
                  "parallelcluster"
                ]
              }
            }
          ]
        }
      },
      "Condition": "CreateEFSSubstack"
    },
    "CloudWatchLogsSubstack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "Parameters": {
          "CWLogOptions": {
            "Ref": "CWLogOptions"
          },
          "CWLogGroupName": {
            "Fn::Sub": [
              "/aws/parallelcluster/${cluster_name}",
              {
                "cluster_name": {
                  "Fn::Select": [
                    "1",
                    {
                      "Fn::Split": [
                        "parallelcluster-",
                        {
                          "Ref": "AWS::StackName"
                        }
                      ]
                    }
                  ]
                }
              }
            ]
          },
          "MainStackName": {
            "Ref": "AWS::StackName"
          },
          "MainStackUniqueId": {
            "Fn::Select": [
              "2",
              {
                "Fn::Split": [
                  "/",
                  {
                    "Ref": "AWS::StackId"
                  }
                ]
              }
            ]
          },
          "CreateHITSubstack": {
            "Fn::If": [
              "CreateHITSubstack",
              "true",
              "false"
            ]
          },
          "CreateAWSBatchLogGroups": {
            "Fn::If": [
              "CreateAWSBatchStack",
              "true",
              "false"
            ]
          }
        },
        "TemplateURL": {
          "Fn::Sub": [
            "https://${AWS::Region}-aws-parallelcluster.s3.${AWS::Region}.${s3_url}/templates/cw-logs-substack-${version}.cfn.json",
            {
              "s3_url": {
                "Fn::FindInMap": [
                  "Partition2Url",
                  {
                    "Ref": "AWS::Partition"
                  },
                  "url"
                ]
              },
              "version": {
                "Fn::FindInMap": [
                  "PackagesVersions",
                  "default",
                  "parallelcluster"
                ]
              }
            }
          ]
        }
      }
    },
    "SQS": {
      "Type": "AWS::SQS::Queue",
      "Properties": {
        "MessageRetentionPeriod": 1209600,
        "QueueName": {
          "Ref": "AWS::StackName"
        }
      },
      "Condition": "CreateComputeFleet"
    },
    "FSXSubstack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "Parameters": {
          "FSXOptions": {
            "Ref": "FSXOptions"
          },
          "ComputeSecurityGroup": {
            "Fn::If": [
              "CreateSecurityGroups",
              {
                "Ref": "ComputeSecurityGroup"
              },
              {
                "Ref": "VPCSecurityGroupId"
              }
            ]
          },
          "ComputeSecurityGroupIngress": {
            "Fn::If": [
              "CreateSecurityGroups",
              {
                "Ref": "ComputeSecurityGroupIngress"
              },
              {
                "Ref": "VPCSecurityGroupId"
              }
            ]
          },
          "SubnetId": {
            "Ref": "MasterSubnetId"
          }
        },
        "TemplateURL": {
          "Fn::Sub": [
            "https://${AWS::Region}-aws-parallelcluster.s3.${AWS::Region}.${s3_url}/templates/fsx-substack-${version}.cfn.json",
            {
              "s3_url": {
                "Fn::FindInMap": [
                  "Partition2Url",
                  {
                    "Ref": "AWS::Partition"
                  },
                  "url"
                ]
              },
              "version": {
                "Fn::FindInMap": [
                  "PackagesVersions",
                  "default",
                  "parallelcluster"
                ]
              }
            }
          ]
        }
      },
      "Condition": "CreateFSXSubstack"
    },
    "SQSPolicy": {
      "Type": "AWS::SQS::QueuePolicy",
      "Properties": {
        "PolicyDocument": {
          "Id": "MyQueuePolicy",
          "Statement": [
            {
              "Sid": "Allow-SendMessage-From-AS-SNS-Topic",
              "Effect": "Allow",
              "Principal": {
                "AWS": "*"
              },
              "Action": [
                "sqs:SendMessage"
              ],
              "Resource": "*",
              "Condition": {
                "ArnEquals": {
                  "aws:SourceArn": {
                    "Ref": "SNS"
                  }
                }
              }
            }
          ]
        },
        "Queues": [
          {
            "Ref": "SQS"
          }
        ]
      },
      "Condition": "CreateComputeFleet"
    },
    "SNS": {
      "Type": "AWS::SNS::Topic",
      "Condition": "CreateComputeFleet"
    },
    "SNSSubscription": {
      "Type": "AWS::SNS::Subscription",
      "Properties": {
        "Endpoint": {
          "Fn::GetAtt": [
            "SQS",
            "Arn"
          ]
        },
        "Protocol": "sqs",
        "TopicArn": {
          "Ref": "SNS"
        }
      },
      "Condition": "CreateComputeFleet"
    },
    "DynamoDBTable": {
      "Type": "AWS::DynamoDB::Table",
      "UpdateReplacePolicy": "Retain",
      "DeletionPolicy": "Delete",
      "Properties": {
        "TableName": {
          "Ref": "AWS::StackName"
        },
        "AttributeDefinitions": [
          {
            "AttributeName": "instanceId",
            "AttributeType": "S"
          }
        ],
        "KeySchema": [
          {
            "AttributeName": "instanceId",
            "KeyType": "HASH"
          }
        ],
        "BillingMode": "PAY_PER_REQUEST"
      },
      "Condition": "CreateComputeFleet"
    },
    "RootRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": {
          "Fn::If": [
            "UseEC2IAMPolicies",
            {
              "Ref": "EC2IAMPolicies"
            },
            {
              "Ref": "AWS::NoValue"
            }
          ]
        },
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  {
                    "Fn::Sub": [
                      "ec2.${s3_url}",
                      {
                        "s3_url": {
                          "Fn::FindInMap": [
                            "Partition2Url",
                            {
                              "Ref": "AWS::Partition"
                            },
                            "url"
                          ]
                        }
                      }
                    ]
                  }
                ]
              },
              "Action": [
                "sts:AssumeRole"
              ]
            }
          ]
        },
        "Path": "/"
      },
      "Condition": "CreateEC2IAMRole"
    },
    "RootInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Fn::If": [
              "UseEC2IAMRole",
              {
                "Ref": "EC2IAMRoleName"
              },
              {
                "Ref": "RootRole"
              }
            ]
          }
        ]
      }
    },
    "ParallelClusterPolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyName": "parallelcluster",
        "PolicyDocument": {
          "Statement": [
            {
              "Sid": "EC2",
              "Action": [
                "ec2:DescribeVolumes",
                "ec2:AttachVolume",
                "ec2:DescribeInstanceAttribute",
                "ec2:DescribeInstanceStatus",
                "ec2:DescribeInstances",
                "ec2:DescribeInstanceTypes"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Sid": "DynamoDBList",
              "Action": [
                "dynamodb:ListTables"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Sid": "SQSQueue",
              "Action": [
                "sqs:SendMessage",
                "sqs:ReceiveMessage",
                "sqs:ChangeMessageVisibility",
                "sqs:DeleteMessage",
                "sqs:GetQueueUrl"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:${AWS::Partition}:sqs:${AWS::Region}:${AWS::AccountId}:${AWS::StackName}"
                }
              ]
            },
            {
              "Sid": "Autoscaling",
              "Action": [
                "autoscaling:DescribeAutoScalingGroups",
                "autoscaling:TerminateInstanceInAutoScalingGroup",
                "autoscaling:SetDesiredCapacity",
                "autoscaling:UpdateAutoScalingGroup",
                "autoscaling:DescribeTags",
                "autoscaling:SetInstanceHealth"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Sid": "Cloudformation",
              "Action": [
                "cloudformation:DescribeStacks",
                "cloudformation:DescribeStackResource",
                "cloudformation:SignalResource"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:${AWS::Partition}:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/parallelcluster-*/*"
                }
              ]
            },
            {
              "Sid": "DynamoDBTable",
              "Action": [
                "dynamodb:PutItem",
                "dynamodb:BatchWriteItem",
                "dynamodb:GetItem",
                "dynamodb:DeleteItem",
                "dynamodb:DescribeTable"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${AWS::StackName}"
                }
              ]
            },
            {
              "Sid": "S3GetObj",
              "Action": [
                "s3:GetObject"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:${AWS::Partition}:s3:::${AWS::Region}-aws-parallelcluster/*"
                }
              ]
            },
            {
              "Sid": "S3PutObj",
              "Action": [
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:${AWS::Partition}:s3:::${ResourcesS3Bucket}/${ArtifactS3RootDirectory}/batch/*"
                }
              ]
            },
            {
              "Sid": "SQSList",
              "Action": [
                "sqs:ListQueues"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Sid": "FSx",
              "Action": [
                "fsx:DescribeFileSystems"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Sid": "BatchJobPassRole",
              "Action": [
                "iam:PassRole"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:${AWS::Partition}:iam::${AWS::AccountId}:role/parallelcluster-*"
                }
              ]
            },
            {
              "Sid": "DcvLicense",
              "Effect": "Allow",
              "Action": "s3:GetObject",
              "Resource": [
                {
                  "Fn::Sub": "arn:${AWS::Partition}:s3:::dcv-license.${AWS::Region}/*"
                }
              ]
            }
          ]
        },
        "Roles": [
          {
            "Ref": "RootRole"
          }
        ]
      },
      "Condition": "CreateEC2IAMRole"
    },
    "S3ReadRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyName": "S3Read",
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "S3Read",
              "Effect": "Allow",
              "Action": [
                "s3:Get*",
                "s3:List*"
              ],
              "Resource": [
                {
                  "Ref": "S3ReadResource"
                }
              ]
            }
          ]
        },
        "Roles": [
          {
            "Ref": "RootRole"
          }
        ]
      },
      "Condition": "UseS3ReadPolicy"
    },
    "S3ReadWriteRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyName": "S3ReadWrite",
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "S3ReadWrite",
              "Effect": "Allow",
              "Action": [
                "s3:*"
              ],
              "Resource": [
                {
                  "Ref": "S3ReadWriteResource"
                }
              ]
            }
          ]
        },
        "Roles": [
          {
            "Ref": "RootRole"
          }
        ]
      },
      "Condition": "UseS3ReadWritePolicy"
    },
    "MasterEIP": {
      "Type": "AWS::EC2::EIP",
      "Properties": {
        "Domain": "vpc"
      },
      "Condition": "MasterPublicIp"
    },
    "ComputeSubnet": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {
          "Ref": "VPCId"
        },
        "CidrBlock": {
          "Ref": "ComputeSubnetCidr"
        },
        "Tags": [
          {
            "Key": "Network",
            "Value": "ComputeSubnet"
          }
        ],
        "AvailabilityZone": {
          "Ref": "AvailabilityZone"
        }
      },
      "Condition": "CreateComputeSubnetForCompute"
    },
    "ComputeRouteTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {
          "Ref": "VPCId"
        },
        "Tags": [
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "Network",
            "Value": "ComputeSubnet"
          }
        ]
      },
      "Condition": "CreateComputeSubnetForCompute"
    },
    "ComputeRoute": {
      "Type": "AWS::EC2::Route",
      "Properties": {
        "RouteTableId": {
          "Ref": "ComputeRouteTable"
        },
        "DestinationCidrBlock": "0.0.0.0/0",
        "NetworkInterfaceId": {
          "Ref": "MasterENI"
        }
      },
      "Condition": "CreateComputeSubnetForCompute"
    },
    "ComputeSubnetRouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": {
          "Ref": "ComputeSubnet"
        },
        "RouteTableId": {
          "Ref": "ComputeRouteTable"
        }
      },
      "Condition": "CreateComputeSubnetForCompute"
    },
    "MasterSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Enable access to the head node",
        "VpcId": {
          "Ref": "VPCId"
        },
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 22,
            "ToPort": 22,
            "CidrIp": {
              "Ref": "AccessFrom"
            }
          },
          {
            "Fn::If": [
              "EnableDCV",
              {
                "IpProtocol": "tcp",
                "FromPort": {
                  "Fn::Select": [
                    "1",
                    {
                      "Fn::Split": [
                        ",",
                        {
                          "Ref": "DCVOptions"
                        }
                      ]
                    }
                  ]
                },
                "ToPort": {
                  "Fn::Select": [
                    "1",
                    {
                      "Fn::Split": [
                        ",",
                        {
                          "Ref": "DCVOptions"
                        }
                      ]
                    }
                  ]
                },
                "CidrIp": {
                  "Fn::Select": [
                    "2",
                    {
                      "Fn::Split": [
                        ",",
                        {
                          "Ref": "DCVOptions"
                        }
                      ]
                    }
                  ]
                }
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          }
        ]
      },
      "Condition": "CreateSecurityGroups"
    },
    "MasterSecurityGroupIngress": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "IpProtocol": "-1",
        "FromPort": 0,
        "ToPort": 65535,
        "SourceSecurityGroupId": {
          "Ref": "ComputeSecurityGroup"
        },
        "GroupId": {
          "Ref": "MasterSecurityGroup"
        }
      },
      "Condition": "CreateSecurityGroups"
    },
    "ComputeSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Allow access to resources in subnets behind front",
        "VpcId": {
          "Ref": "VPCId"
        },
        "SecurityGroupIngress": [
          {
            "SourceSecurityGroupId": {
              "Ref": "MasterSecurityGroup"
            },
            "IpProtocol": "-1",
            "FromPort": 0,
            "ToPort": 65535
          }
        ]
      },
      "Condition": "CreateSecurityGroups"
    },
    "ComputeSecurityGroupEgress": {
      "Type": "AWS::EC2::SecurityGroupEgress",
      "Properties": {
        "IpProtocol": "-1",
        "FromPort": 0,
        "ToPort": 65535,
        "DestinationSecurityGroupId": {
          "Ref": "ComputeSecurityGroup"
        },
        "GroupId": {
          "Ref": "ComputeSecurityGroup"
        }
      },
      "Condition": "CreateSecurityGroups"
    },
    "ComputeSecurityGroupNormalEgress": {
      "Type": "AWS::EC2::SecurityGroupEgress",
      "Properties": {
        "IpProtocol": "-1",
        "FromPort": 0,
        "ToPort": 65535,
        "CidrIp": "0.0.0.0/0",
        "GroupId": {
          "Ref": "ComputeSecurityGroup"
        }
      },
      "DependsOn": "ComputeSecurityGroupEgress",
      "Condition": "CreateSecurityGroups"
    },
    "ComputeSecurityGroupIngress": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "IpProtocol": "-1",
        "FromPort": 0,
        "ToPort": 65535,
        "SourceSecurityGroupId": {
          "Ref": "ComputeSecurityGroup"
        },
        "GroupId": {
          "Ref": "ComputeSecurityGroup"
        }
      },
      "Condition": "CreateSecurityGroups"
    },
    "MasterENI": {
      "Type": "AWS::EC2::NetworkInterface",
      "Properties": {
        "Description": "AWS ParallelCluster head node interface",
        "SubnetId": {
          "Ref": "MasterSubnetId"
        },
        "SourceDestCheck": false,
        "GroupSet": [
          {
            "Fn::If": [
              "CreateSecurityGroups",
              {
                "Ref": "MasterSecurityGroup"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          },
          {
            "Fn::If": [
              "AddAdditionalSG",
              {
                "Ref": "AdditionalSG"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          },
          {
            "Fn::If": [
              "UseExistingSecurityGroup",
              {
                "Ref": "VPCSecurityGroupId"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          }
        ]
      }
    },
    "AdditionalCfnStack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": {
          "Ref": "AdditionalCfnTemplate"
        }
      },
      "Condition": "CreateSubStack"
    },
    "AWSBatchStack": {
      "Type": "AWS::CloudFormation::Stack",
      "DependsOn": [
        "CleanupResourcesS3BucketCustomResource",
        "CloudWatchLogsSubstack"
      ],
      "Properties": {
        "Parameters": {
          "AttributeTags": {
            "Fn::Sub": [
              "${BaseOS}, ${Scheduler}, ${version}, ${Architecture}",
              {
                "version": {
                  "Fn::FindInMap": [
                    "PackagesVersions",
                    "default",
                    "parallelcluster"
                  ]
                }
              }
            ]
          },
          "S3Url": {
            "Fn::FindInMap": [
              "Partition2Url",
              {
                "Ref": "AWS::Partition"
              },
              "url"
            ]
          },
          "FileSystemTags": {
            "Fn::Sub": [
              "efs=${efs}, multiebs=${NumberOfEBSVol}, raid=${raid}",
              {
                "efs": {
                  "Fn::If": [
                    "CreateEFSSubstack",
                    "1",
                    "0"
                  ]
                },
                "raid": {
                  "Fn::If": [
                    "CreateRAIDSubstack",
                    "1",
                    "0"
                  ]
                }
              }
            ]
          },
          "EFSSharedDir": {
            "Fn::Select": [
              "0",
              {
                "Fn::Split": [
                  ",",
                  {
                    "Ref": "EFSOptions"
                  }
                ]
              }
            ]
          },
          "EFSFSId": {
            "Fn::If": [
              "CreateEFSSubstack",
              {
                "Fn::GetAtt": [
                  "EFSSubstack",
                  "Outputs.FileSystemId"
                ]
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          },
          "MinvCpus": {
            "Ref": "MinSize"
          },
          "DesiredvCpus": {
            "Ref": "DesiredSize"
          },
          "MaxvCpus": {
            "Ref": "MaxSize"
          },
          "InstanceTypes": {
            "Ref": "ComputeInstanceType"
          },
          "Subnet": {
            "Fn::If": [
              "UseMasterSubnetForCompute",
              {
                "Ref": "MasterSubnetId"
              },
              {
                "Fn::If": [
                  "CreateComputeSubnetForCompute",
                  {
                    "Ref": "ComputeSubnet"
                  },
                  {
                    "Ref": "ComputeSubnetId"
                  }
                ]
              }
            ]
          },
          "SecurityGroups": {
            "Fn::Join": [
              ",",
              [
                {
                  "Fn::If": [
                    "CreateSecurityGroups",
                    {
                      "Ref": "ComputeSecurityGroup"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                },
                {
                  "Fn::If": [
                    "AddAdditionalSG",
                    {
                      "Ref": "AdditionalSG"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                },
                {
                  "Fn::If": [
                    "UseExistingSecurityGroup",
                    {
                      "Ref": "VPCSecurityGroupId"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                }
              ]
            ]
          },
          "OS": {
            "Ref": "BaseOS"
          },
          "ClusterName": {
            "Ref": "AWS::StackName"
          },
          "ClusterType": {
            "Ref": "ClusterType"
          },
          "KeyName": {
            "Ref": "KeyName"
          },
          "SpotBidPercentage": {
            "Fn::If": [
              "UseSpotPrice",
              {
                "Ref": "SpotPrice"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          },
          "ResourcesS3Bucket": {
            "Ref": "ResourcesS3Bucket"
          },
          "ArtifactS3RootDirectory": {
            "Ref": "ArtifactS3RootDirectory"
          },
          "SharedDir": {
            "Ref": "SharedDir"
          },
          "RAIDSharedDir": {
            "Fn::Select": [
              "0",
              {
                "Fn::Split": [
                  ",",
                  {
                    "Ref": "RAIDOptions"
                  }
                ]
              }
            ]
          },
          "MainStackUniqueId": {
            "Fn::Select": [
              "2",
              {
                "Fn::Split": [
                  "/",
                  {
                    "Ref": "AWS::StackId"
                  }
                ]
              }
            ]
          },
          "Architecture": {
            "Ref": "Architecture"
          },
          "MasterPrivateIP": {
            "Fn::GetAtt": [
              "MasterServerSubstack",
              "Outputs.MasterPrivateIP"
            ]
          },
          "IAMLambdaRoleName": {
            "Ref": "IAMLambdaRoleName"
          }
        },
        "TemplateURL": {
          "Fn::Sub": [
            "https://${AWS::Region}-aws-parallelcluster.s3.${AWS::Region}.${s3_url}/templates/batch-substack-${version}.cfn.json",
            {
              "s3_url": {
                "Fn::FindInMap": [
                  "Partition2Url",
                  {
                    "Ref": "AWS::Partition"
                  },
                  "url"
                ]
              },
              "version": {
                "Fn::FindInMap": [
                  "PackagesVersions",
                  "default",
                  "parallelcluster"
                ]
              }
            }
          ]
        }
      },
      "Condition": "CreateAWSBatchStack"
    },
    "AssociateEIP": {
      "Type": "AWS::EC2::EIPAssociation",
      "Properties": {
        "AllocationId": {
          "Fn::GetAtt": [
            "MasterEIP",
            "AllocationId"
          ]
        },
        "NetworkInterfaceId": {
          "Ref": "MasterENI"
        }
      },
      "Condition": "MasterPublicIp"
    },
    "DynamicPlacementGroup": {
      "Type": "AWS::EC2::PlacementGroup",
      "Properties": {
        "Strategy": "cluster"
      },
      "Condition": "CreatePlacementGroup"
    },
    "CleanupResourcesFunctionExecutionRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [
                "sts:AssumeRole"
              ],
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "lambda.amazonaws.com"
                ]
              }
            }
          ],
          "Version": "2012-10-17"
        },
        "Path": "/",
        "Policies": [
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": [
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Effect": "Allow",
                  "Resource": {
                    "Fn::Sub": "arn:${AWS::Partition}:logs:*:*:*"
                  },
                  "Sid": "CloudWatchLogsPolicy"
                },
                {
                  "Action": {
                    "Fn::If": [
                      "UseProvidedResourcesS3Bucket",
                      [
                        "s3:DeleteObject",
                        "s3:DeleteObjectVersion",
                        "s3:ListBucket",
                        "s3:ListBucketVersions"
                      ],
                      [
                        "s3:DeleteBucket",
                        "s3:DeleteObject",
                        "s3:DeleteObjectVersion",
                        "s3:ListBucket",
                        "s3:ListBucketVersions"
                      ]
                    ]
                  },
                  "Effect": "Allow",
                  "Resource": [
                    {
                      "Fn::Sub": "arn:${AWS::Partition}:s3:::${ResourcesS3Bucket}"
                    },
                    {
                      "Fn::Sub": "arn:${AWS::Partition}:s3:::${ResourcesS3Bucket}/${ArtifactS3RootDirectory}/*"
                    }
                  ],
                  "Sid": "S3BucketPolicy"
                },
                {
                  "Fn::If": [
                    "CreateHITSubstack",
                    {
                      "Sid": "DescribeInstances",
                      "Effect": "Allow",
                      "Action": [
                        "ec2:DescribeInstances"
                      ],
                      "Resource": "*"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                },
                {
                  "Fn::If": [
                    "CreateHITSubstack",
                    {
                      "Sid": "FleetTerminatePolicy",
                      "Effect": "Allow",
                      "Action": [
                        "ec2:TerminateInstances"
                      ],
                      "Resource": "*",
                      "Condition": {
                        "StringEquals": {
                          "ec2:ResourceTag/Application": {
                            "Ref": "AWS::StackName"
                          }
                        }
                      }
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                }
              ],
              "Version": "2012-10-17"
            },
            "PolicyName": "LambdaPolicy"
          }
        ]
      },
      "Condition": "CreateIAMLambdaRole"
    },
    "CleanupResourcesS3BucketCustomResource": {
      "Type": "AWS::CloudFormation::CustomResource",
      "Properties": {
        "ResourcesS3Bucket": {
          "Ref": "ResourcesS3Bucket"
        },
        "ArtifactS3RootDirectory": {
          "Ref": "ArtifactS3RootDirectory"
        },
        "RemoveBucketOnDeletion": {
          "Ref": "RemoveBucketOnDeletion"
        },
        "Action": "DELETE_S3_ARTIFACTS",
        "ServiceToken": {
          "Fn::GetAtt": [
            "CleanupResourcesFunction",
            "Arn"
          ]
        }
      }
    },
    "TerminateComputeFleetCustomResource": {
      "Type": "AWS::CloudFormation::CustomResource",
      "Properties": {
        "StackName": {
          "Ref": "AWS::StackName"
        },
        "Action": "TERMINATE_EC2_INSTANCES",
        "ServiceToken": {
          "Fn::GetAtt": [
            "CleanupResourcesFunction",
            "Arn"
          ]
        }
      },
      "DependsOn": [
        "CloudWatchLogsSubstack",
        "ComputeFleetHITSubstack"
      ],
      "Condition": "CreateHITSubstack"
    },
    "CleanupResourcesFunction": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "FunctionName": {
          "Fn::Sub": [
            "pcluster-CleanupResources-${StackId}",
            {
              "StackId": {
                "Fn::Select": [
                  "2",
                  {
                    "Fn::Split": [
                      "/",
                      {
                        "Ref": "AWS::StackId"
                      }
                    ]
                  }
                ]
              }
            }
          ]
        },
        "Code": {
          "S3Bucket": {
            "Ref": "ResourcesS3Bucket"
          },
          "S3Key": {
            "Fn::Sub": "${ArtifactS3RootDirectory}/custom_resources_code/artifacts.zip"
          }
        },
        "Handler": "cleanup_resources.handler",
        "MemorySize": 128,
        "Role": {
          "Fn::If": [
            "CreateIAMLambdaRole",
            {
              "Fn::GetAtt": [
                "CleanupResourcesFunctionExecutionRole",
                "Arn"
              ]
            },
            {
              "Fn::Sub": "arn:${AWS::Partition}:iam::${AWS::AccountId}:role/${IAMLambdaRoleName}"
            }
          ]
        },
        "Runtime": "python3.8",
        "Timeout": 900
      }
    },
    "RAIDSubstack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "Parameters": {
          "RAIDOptions": {
            "Ref": "RAIDOptions"
          },
          "AvailabilityZone": {
            "Ref": "AvailabilityZone"
          }
        },
        "TemplateURL": {
          "Fn::Sub": [
            "https://${AWS::Region}-aws-parallelcluster.s3.${AWS::Region}.${s3_url}/templates/raid-substack-${version}.cfn.json",
            {
              "s3_url": {
                "Fn::FindInMap": [
                  "Partition2Url",
                  {
                    "Ref": "AWS::Partition"
                  },
                  "url"
                ]
              },
              "version": {
                "Fn::FindInMap": [
                  "PackagesVersions",
                  "default",
                  "parallelcluster"
                ]
              }
            }
          ]
        }
      },
      "Condition": "CreateRAIDSubstack"
    },
    "EBSCfnStack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "Parameters": {
          "AvailabilityZone": {
            "Ref": "AvailabilityZone"
          },
          "VolumeSize": {
            "Ref": "VolumeSize"
          },
          "VolumeType": {
            "Ref": "VolumeType"
          },
          "VolumeIOPS": {
            "Ref": "VolumeIOPS"
          },
          "VolumeThroughput": {
            "Ref": "VolumeThroughput"
          },
          "EBSEncryption": {
            "Ref": "EBSEncryption"
          },
          "EBSKMSKeyId": {
            "Ref": "EBSKMSKeyId"
          },
          "EBSVolumeId": {
            "Ref": "EBSVolumeId"
          },
          "EBSSnapshotId": {
            "Ref": "EBSSnapshotId"
          },
          "NumberOfEBSVol": {
            "Ref": "NumberOfEBSVol"
          }
        },
        "TemplateURL": {
          "Fn::Sub": [
            "https://${AWS::Region}-aws-parallelcluster.s3.${AWS::Region}.${s3_url}/templates/ebs-substack-${version}.cfn.json",
            {
              "s3_url": {
                "Fn::FindInMap": [
                  "Partition2Url",
                  {
                    "Ref": "AWS::Partition"
                  },
                  "url"
                ]
              },
              "version": {
                "Fn::FindInMap": [
                  "PackagesVersions",
                  "default",
                  "parallelcluster"
                ]
              }
            }
          ]
        }
      }
    },
    "MasterServerSubstack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "Parameters": {
          "MasterInstanceType": {
            "Ref": "MasterInstanceType"
          },
          "MasterSecurityGroups": {
            "Fn::Join": [
              ",",
              [
                {
                  "Fn::If": [
                    "CreateSecurityGroups",
                    {
                      "Ref": "MasterSecurityGroup"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                },
                {
                  "Fn::If": [
                    "AddAdditionalSG",
                    {
                      "Ref": "AdditionalSG"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                },
                {
                  "Fn::If": [
                    "UseExistingSecurityGroup",
                    {
                      "Ref": "VPCSecurityGroupId"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                }
              ]
            ]
          },
          "ComputeInstanceType": {
            "Ref": "ComputeInstanceType"
          },
          "MasterSubnetId": {
            "Ref": "MasterSubnetId"
          },
          "MasterCoreCount": {
            "Fn::Join": [
              ",",
              [
                {
                  "Fn::Select": [
                    "0",
                    {
                      "Ref": "Cores"
                    }
                  ]
                },
                {
                  "Fn::Select": [
                    "2",
                    {
                      "Ref": "Cores"
                    }
                  ]
                }
              ]
            ]
          },
          "ComputeCoreCount": {
            "Fn::Select": [
              "1",
              {
                "Ref": "Cores"
              }
            ]
          },
          "RootDevice": {
            "Fn::FindInMap": [
              "OSFeatures",
              {
                "Ref": "BaseOS"
              },
              "RootDevice"
            ]
          },
          "RootVolumeSize": {
            "Ref": "MasterRootVolumeSize"
          },
          "KeyName": {
            "Ref": "KeyName"
          },
          "MainStackName": {
            "Ref": "AWS::StackName"
          },
          "AttributesTagValue": {
            "Fn::Sub": [
              "${BaseOS}, ${Scheduler}, ${version}, ${Architecture}",
              {
                "version": {
                  "Fn::FindInMap": [
                    "PackagesVersions",
                    "default",
                    "parallelcluster"
                  ]
                }
              }
            ]
          },
          "NetworkingTagValue": {
            "Fn::Sub": "EFA=${EFA}"
          },
          "FilesystemTagValue": {
            "Fn::Sub": [
              "efs=${efs}, multiebs=${NumberOfEBSVol}, raid=${raid}, fsx=${fsx}",
              {
                "efs": {
                  "Fn::If": [
                    "CreateEFSSubstack",
                    "1",
                    "0"
                  ]
                },
                "raid": {
                  "Fn::If": [
                    "CreateRAIDSubstack",
                    "1",
                    "0"
                  ]
                },
                "fsx": {
                  "Fn::If": [
                    "CreateFSXSubstack",
                    "1",
                    "0"
                  ]
                }
              }
            ]
          },
          "MasterENI": {
            "Ref": "MasterENI"
          },
          "UseMasterPublicIp": {
            "Fn::If": [
              "MasterPublicIp",
              true,
              false
            ]
          },
          "ImageId": {
            "Fn::If": [
              "UseCustomAMI",
              {
                "Ref": "CustomAMI"
              },
              {
                "Fn::If": [
                  "UseArmAMIs",
                  {
                    "Fn::FindInMap": [
                      "AWSRegionOS2AMIarm64",
                      {
                        "Ref": "AWS::Region"
                      },
                      {
                        "Ref": "BaseOS"
                      }
                    ]
                  },
                  {
                    "Fn::FindInMap": [
                      "AWSRegionOS2AMIx86",
                      {
                        "Ref": "AWS::Region"
                      },
                      {
                        "Ref": "BaseOS"
                      }
                    ]
                  }
                ]
              }
            ]
          },
          "IamInstanceProfile": {
            "Ref": "RootInstanceProfile"
          },
          "IamRoleName": {
            "Fn::If": [
              "UseEC2IAMRole",
              {
                "Ref": "EC2IAMRoleName"
              },
              {
                "Ref": "RootRole"
              }
            ]
          },
          "PlacementGroup": {
            "Fn::If": [
              "UseClusterPlacement",
              {
                "Fn::If": [
                  "CreatePlacementGroup",
                  {
                    "Ref": "DynamicPlacementGroup"
                  },
                  {
                    "Ref": "PlacementGroup"
                  }
                ]
              },
              "NONE"
            ]
          },
          "EFA": {
            "Ref": "EFA"
          },
          "BaseOS": {
            "Ref": "BaseOS"
          },
          "OSUser": {
            "Fn::FindInMap": [
              "OSFeatures",
              {
                "Ref": "BaseOS"
              },
              "User"
            ]
          },
          "PreInstallScript": {
            "Ref": "PreInstallScript"
          },
          "PreInstallArgs": {
            "Ref": "PreInstallArgs"
          },
          "PostInstallScript": {
            "Ref": "PostInstallScript"
          },
          "PostInstallArgs": {
            "Ref": "PostInstallArgs"
          },
          "RAIDVolIds": {
            "Fn::If": [
              "CreateRAIDSubstack",
              {
                "Fn::GetAtt": [
                  "RAIDSubstack",
                  "Outputs.Volumeids"
                ]
              },
              ""
            ]
          },
          "RAIDOptions": {
            "Ref": "RAIDOptions"
          },
          "EFSId": {
            "Fn::If": [
              "CreateEFSSubstack",
              {
                "Fn::GetAtt": [
                  "EFSSubstack",
                  "Outputs.FileSystemId"
                ]
              },
              ""
            ]
          },
          "EFSOptions": {
            "Ref": "EFSOptions"
          },
          "FSXId": {
            "Fn::If": [
              "CreateFSXSubstack",
              {
                "Fn::GetAtt": [
                  "FSXSubstack",
                  "Outputs.FileSystemId"
                ]
              },
              ""
            ]
          },
          "FSXMountName": {
            "Fn::If": [
              "CreateFSXSubstack",
              {
                "Fn::GetAtt": [
                  "FSXSubstack",
                  "Outputs.MountName"
                ]
              },
              ""
            ]
          },
          "FSXDNSName": {
            "Fn::If": [
              "CreateFSXSubstack",
              {
                "Fn::GetAtt": [
                  "FSXSubstack",
                  "Outputs.DNSName"
                ]
              },
              ""
            ]
          },
          "FSXOptions": {
            "Ref": "FSXOptions"
          },
          "EBSVolIds": {
            "Fn::GetAtt": [
              "EBSCfnStack",
              "Outputs.Volumeids"
            ]
          },
          "Scheduler": {
            "Ref": "Scheduler"
          },
          "EncryptedEphemeral": {
            "Ref": "EncryptedEphemeral"
          },
          "EphemeralDir": {
            "Ref": "EphemeralDir"
          },
          "SharedDir": {
            "Ref": "SharedDir"
          },
          "ProxyServer": {
            "Ref": "ProxyServer"
          },
          "ClusterDNSDomain": {
            "Fn::If": [
              "CreateHITSubstack",
              {
                "Fn::GetAtt": [
                  "ComputeFleetHITSubstack",
                  "Outputs.ClusterDNSDomain"
                ]
              },
              ""
            ]
          },
          "ClusterHostedZone": {
            "Fn::If": [
              "CreateHITSubstack",
              {
                "Fn::GetAtt": [
                  "ComputeFleetHITSubstack",
                  "Outputs.ClusterHostedZone"
                ]
              },
              ""
            ]
          },
          "MaxSize": {
            "Ref": "MaxSize"
          },
          "DynamoDBTable": {
            "Ref": "AWS::StackName"
          },
          "SQSQueueName": {
            "Ref": "AWS::StackName"
          },
          "DCVEnabled": {
            "Fn::If": [
              "EnableDCV",
              "master",
              "false"
            ]
          },
          "DCVPort": {
            "Fn::Select": [
              "1",
              {
                "Fn::Split": [
                  ",",
                  {
                    "Ref": "DCVOptions"
                  }
                ]
              }
            ]
          },
          "IntelHPCPlatform": {
            "Ref": "IntelHPCPlatform"
          },
          "CWLoggingEnabled": {
            "Fn::GetAtt": [
              "CloudWatchLogsSubstack",
              "Outputs.Enabled"
            ]
          },
          "ExtraJson": {
            "Ref": "ExtraJson"
          },
          "CustomChefCookbook": {
            "Ref": "CustomChefCookbook"
          },
          "AWSDomain": {
            "Fn::FindInMap": [
              "Partition2Url",
              {
                "Ref": "AWS::Partition"
              },
              "url"
            ]
          },
          "ParallelClusterVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "parallelcluster"
            ]
          },
          "CookbookVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "cookbook"
            ]
          },
          "ChefVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "chef"
            ]
          },
          "BerkshelfVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "berkshelf"
            ]
          },
          "ResourcesS3Bucket": {
            "Ref": "ResourcesS3Bucket"
          },
          "ArtifactS3RootDirectory": {
            "Ref": "ArtifactS3RootDirectory"
          },
          "DependsOnCustomResources": {
            "Fn::If": [
              "CreateHITSubstack",
              {
                "Fn::Sub": [
                  "DependsOn${fleetTermination}And${route53cleanup}",
                  {
                    "fleetTermination": {
                      "Ref": "TerminateComputeFleetCustomResource"
                    },
                    "route53cleanup": {
                      "Fn::GetAtt": [
                        "ComputeFleetHITSubstack",
                        "Outputs.CleanupRoute53CustomResource"
                      ]
                    }
                  }
                ]
              },
              ""
            ]
          },
          "HITConfigVersion": {
            "Fn::If": [
              "CreateHITSubstack",
              {
                "Fn::GetAtt": [
                  "ComputeFleetHITSubstack",
                  "Outputs.ConfigVersion"
                ]
              },
              ""
            ]
          },
          "UpdateWaiterFunctionArn": {
            "Fn::If": [
              "CreateHITSubstack",
              {
                "Fn::GetAtt": [
                  "ComputeFleetHITSubstack",
                  "Outputs.UpdateWaiterFunctionArn"
                ]
              },
              "NONE"
            ]
          },
          "MasterNetworkInterfacesCount": {
            "Fn::Select": [
              "0",
              {
                "Ref": "NetworkInterfacesCount"
              }
            ]
          },
          "InstanceTypesData": {
            "Ref": "InstanceTypesData"
          }
        },
        "TemplateURL": {
          "Fn::Sub": [
            "https://${AWS::Region}-aws-parallelcluster.s3.${AWS::Region}.${s3_url}/templates/master-server-substack-${version}.cfn.yaml",
            {
              "s3_url": {
                "Fn::FindInMap": [
                  "Partition2Url",
                  {
                    "Ref": "AWS::Partition"
                  },
                  "url"
                ]
              },
              "version": {
                "Fn::FindInMap": [
                  "PackagesVersions",
                  "default",
                  "parallelcluster"
                ]
              }
            }
          ]
        }
      }
    },
    "ComputeFleetSubstack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "Parameters": {
          "ComputeInstanceType": {
            "Ref": "ComputeInstanceType"
          },
          "ComputeSubnetId": {
            "Fn::If": [
              "UseMasterSubnetForCompute",
              {
                "Ref": "MasterSubnetId"
              },
              {
                "Fn::If": [
                  "CreateComputeSubnetForCompute",
                  {
                    "Ref": "ComputeSubnet"
                  },
                  {
                    "Ref": "ComputeSubnetId"
                  }
                ]
              }
            ]
          },
          "ComputeCoreCount": {
            "Fn::Join": [
              ",",
              [
                {
                  "Fn::Select": [
                    "1",
                    {
                      "Ref": "Cores"
                    }
                  ]
                },
                {
                  "Fn::Select": [
                    "3",
                    {
                      "Ref": "Cores"
                    }
                  ]
                }
              ]
            ]
          },
          "SNSTopic": {
            "Ref": "SNS"
          },
          "RootDevice": {
            "Fn::FindInMap": [
              "OSFeatures",
              {
                "Ref": "BaseOS"
              },
              "RootDevice"
            ]
          },
          "RootVolumeSize": {
            "Ref": "ComputeRootVolumeSize"
          },
          "KeyName": {
            "Ref": "KeyName"
          },
          "MainStackName": {
            "Ref": "AWS::StackName"
          },
          "AttributesTagValue": {
            "Fn::Sub": [
              "${BaseOS}, ${Scheduler}, ${version}, ${Architecture}",
              {
                "version": {
                  "Fn::FindInMap": [
                    "PackagesVersions",
                    "default",
                    "parallelcluster"
                  ]
                }
              }
            ]
          },
          "NetworkingTagValue": {
            "Fn::Sub": "EFA=${EFA}"
          },
          "FilesystemTagValue": {
            "Fn::Sub": [
              "efs=${efs}, multiebs=${NumberOfEBSVol}, raid=${raid}, fsx=${fsx}",
              {
                "efs": {
                  "Fn::If": [
                    "CreateEFSSubstack",
                    "1",
                    "0"
                  ]
                },
                "raid": {
                  "Fn::If": [
                    "CreateRAIDSubstack",
                    "1",
                    "0"
                  ]
                },
                "fsx": {
                  "Fn::If": [
                    "CreateFSXSubstack",
                    "1",
                    "0"
                  ]
                }
              }
            ]
          },
          "ImageId": {
            "Fn::If": [
              "UseCustomAMI",
              {
                "Ref": "CustomAMI"
              },
              {
                "Fn::If": [
                  "UseArmAMIs",
                  {
                    "Fn::FindInMap": [
                      "AWSRegionOS2AMIarm64",
                      {
                        "Ref": "AWS::Region"
                      },
                      {
                        "Ref": "BaseOS"
                      }
                    ]
                  },
                  {
                    "Fn::FindInMap": [
                      "AWSRegionOS2AMIx86",
                      {
                        "Ref": "AWS::Region"
                      },
                      {
                        "Ref": "BaseOS"
                      }
                    ]
                  }
                ]
              }
            ]
          },
          "IamInstanceProfile": {
            "Ref": "RootInstanceProfile"
          },
          "IamRoleName": {
            "Fn::If": [
              "UseEC2IAMRole",
              {
                "Ref": "EC2IAMRoleName"
              },
              {
                "Ref": "RootRole"
              }
            ]
          },
          "PlacementGroup": {
            "Fn::If": [
              "UsePlacementGroup",
              {
                "Fn::If": [
                  "CreatePlacementGroup",
                  {
                    "Ref": "DynamicPlacementGroup"
                  },
                  {
                    "Ref": "PlacementGroup"
                  }
                ]
              },
              "NONE"
            ]
          },
          "EFA": {
            "Ref": "EFA"
          },
          "EFAGDR": {
            "Ref": "EFAGDR"
          },
          "BaseOS": {
            "Ref": "BaseOS"
          },
          "OSUser": {
            "Fn::FindInMap": [
              "OSFeatures",
              {
                "Ref": "BaseOS"
              },
              "User"
            ]
          },
          "PreInstallScript": {
            "Ref": "PreInstallScript"
          },
          "PreInstallArgs": {
            "Ref": "PreInstallArgs"
          },
          "PostInstallScript": {
            "Ref": "PostInstallScript"
          },
          "PostInstallArgs": {
            "Ref": "PostInstallArgs"
          },
          "RAIDOptions": {
            "Ref": "RAIDOptions"
          },
          "EFSId": {
            "Fn::If": [
              "CreateEFSSubstack",
              {
                "Fn::GetAtt": [
                  "EFSSubstack",
                  "Outputs.FileSystemId"
                ]
              },
              ""
            ]
          },
          "EFSOptions": {
            "Ref": "EFSOptions"
          },
          "FSXId": {
            "Fn::If": [
              "CreateFSXSubstack",
              {
                "Fn::GetAtt": [
                  "FSXSubstack",
                  "Outputs.FileSystemId"
                ]
              },
              ""
            ]
          },
          "FSXMountName": {
            "Fn::If": [
              "CreateFSXSubstack",
              {
                "Fn::GetAtt": [
                  "FSXSubstack",
                  "Outputs.MountName"
                ]
              },
              ""
            ]
          },
          "FSXDNSName": {
            "Fn::If": [
              "CreateFSXSubstack",
              {
                "Fn::GetAtt": [
                  "FSXSubstack",
                  "Outputs.DNSName"
                ]
              },
              ""
            ]
          },
          "FSXOptions": {
            "Ref": "FSXOptions"
          },
          "Scheduler": {
            "Ref": "Scheduler"
          },
          "EncryptedEphemeral": {
            "Ref": "EncryptedEphemeral"
          },
          "EphemeralDir": {
            "Ref": "EphemeralDir"
          },
          "SharedDir": {
            "Ref": "SharedDir"
          },
          "ProxyServer": {
            "Ref": "ProxyServer"
          },
          "MaxSize": {
            "Ref": "MaxSize"
          },
          "MinSize": {
            "Ref": "MinSize"
          },
          "DesiredSize": {
            "Ref": "DesiredSize"
          },
          "SQSQueue": {
            "Ref": "SQS"
          },
          "IntelHPCPlatform": {
            "Ref": "IntelHPCPlatform"
          },
          "CWLoggingEnabled": {
            "Fn::GetAtt": [
              "CloudWatchLogsSubstack",
              "Outputs.Enabled"
            ]
          },
          "ExtraJson": {
            "Ref": "ExtraJson"
          },
          "CustomChefCookbook": {
            "Ref": "CustomChefCookbook"
          },
          "AWSDomain": {
            "Fn::FindInMap": [
              "Partition2Url",
              {
                "Ref": "AWS::Partition"
              },
              "url"
            ]
          },
          "ParallelClusterVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "parallelcluster"
            ]
          },
          "CookbookVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "cookbook"
            ]
          },
          "ChefVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "chef"
            ]
          },
          "BerkshelfVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "berkshelf"
            ]
          },
          "ComputeSecurityGroups": {
            "Fn::Join": [
              ",",
              [
                {
                  "Fn::If": [
                    "CreateSecurityGroups",
                    {
                      "Ref": "ComputeSecurityGroup"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                },
                {
                  "Fn::If": [
                    "AddAdditionalSG",
                    {
                      "Ref": "AdditionalSG"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                },
                {
                  "Fn::If": [
                    "UseExistingSecurityGroup",
                    {
                      "Ref": "VPCSecurityGroupId"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                }
              ]
            ]
          },
          "AssociatePublicIpAddress": {
            "Fn::If": [
              "ComputePublicIps",
              true,
              false
            ]
          },
          "ClusterType": {
            "Ref": "ClusterType"
          },
          "SpotPrice": {
            "Ref": "SpotPrice"
          },
          "ScaleDownIdleTime": {
            "Ref": "ScaleDownIdleTime"
          },
          "MasterPrivateDnsName": {
            "Fn::GetAtt": [
              "MasterServerSubstack",
              "Outputs.MasterPrivateDnsName"
            ]
          },
          "MasterPrivateIP": {
            "Fn::GetAtt": [
              "MasterServerSubstack",
              "Outputs.MasterPrivateIP"
            ]
          },
          "ComputeNetworkInterfacesCount": {
            "Fn::Select": [
              "1",
              {
                "Ref": "NetworkInterfacesCount"
              }
            ]
          },
          "InstanceTypesData": {
            "Ref": "InstanceTypesData"
          }
        },
        "TemplateURL": {
          "Fn::Sub": [
            "https://${AWS::Region}-aws-parallelcluster.s3.${AWS::Region}.${s3_url}/templates/compute-fleet-substack-${version}.cfn.yaml",
            {
              "s3_url": {
                "Fn::FindInMap": [
                  "Partition2Url",
                  {
                    "Ref": "AWS::Partition"
                  },
                  "url"
                ]
              },
              "version": {
                "Fn::FindInMap": [
                  "PackagesVersions",
                  "default",
                  "parallelcluster"
                ]
              }
            }
          ]
        }
      },
      "Condition": "CreateComputeFleet"
    },
    "ComputeFleetHITSubstack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "Parameters": {
          "ComputeSubnetId": {
            "Fn::If": [
              "UseMasterSubnetForCompute",
              {
                "Ref": "MasterSubnetId"
              },
              {
                "Fn::If": [
                  "CreateComputeSubnetForCompute",
                  {
                    "Ref": "ComputeSubnet"
                  },
                  {
                    "Ref": "ComputeSubnetId"
                  }
                ]
              }
            ]
          },
          "RootDevice": {
            "Fn::FindInMap": [
              "OSFeatures",
              {
                "Ref": "BaseOS"
              },
              "RootDevice"
            ]
          },
          "RootVolumeSize": {
            "Ref": "ComputeRootVolumeSize"
          },
          "KeyName": {
            "Ref": "KeyName"
          },
          "MainStackName": {
            "Ref": "AWS::StackName"
          },
          "MainStackUniqueId": {
            "Fn::Select": [
              "2",
              {
                "Fn::Split": [
                  "/",
                  {
                    "Ref": "AWS::StackId"
                  }
                ]
              }
            ]
          },
          "AttributesTagValue": {
            "Fn::Sub": [
              "${BaseOS}, ${Scheduler}, ${version}, ${Architecture}",
              {
                "version": {
                  "Fn::FindInMap": [
                    "PackagesVersions",
                    "default",
                    "parallelcluster"
                  ]
                }
              }
            ]
          },
          "NetworkingTagValue": {
            "Fn::Sub": "EFA=${EFA}"
          },
          "FilesystemTagValue": {
            "Fn::Sub": [
              "efs=${efs}, multiebs=${NumberOfEBSVol}, raid=${raid}, fsx=${fsx}",
              {
                "efs": {
                  "Fn::If": [
                    "CreateEFSSubstack",
                    "1",
                    "0"
                  ]
                },
                "raid": {
                  "Fn::If": [
                    "CreateRAIDSubstack",
                    "1",
                    "0"
                  ]
                },
                "fsx": {
                  "Fn::If": [
                    "CreateFSXSubstack",
                    "1",
                    "0"
                  ]
                }
              }
            ]
          },
          "ImageId": {
            "Fn::If": [
              "UseCustomAMI",
              {
                "Ref": "CustomAMI"
              },
              {
                "Fn::If": [
                  "UseArmAMIs",
                  {
                    "Fn::FindInMap": [
                      "AWSRegionOS2AMIarm64",
                      {
                        "Ref": "AWS::Region"
                      },
                      {
                        "Ref": "BaseOS"
                      }
                    ]
                  },
                  {
                    "Fn::FindInMap": [
                      "AWSRegionOS2AMIx86",
                      {
                        "Ref": "AWS::Region"
                      },
                      {
                        "Ref": "BaseOS"
                      }
                    ]
                  }
                ]
              }
            ]
          },
          "IamInstanceProfile": {
            "Ref": "RootInstanceProfile"
          },
          "BaseOS": {
            "Ref": "BaseOS"
          },
          "OSUser": {
            "Fn::FindInMap": [
              "OSFeatures",
              {
                "Ref": "BaseOS"
              },
              "User"
            ]
          },
          "PreInstallScript": {
            "Ref": "PreInstallScript"
          },
          "PreInstallArgs": {
            "Ref": "PreInstallArgs"
          },
          "PostInstallScript": {
            "Ref": "PostInstallScript"
          },
          "PostInstallArgs": {
            "Ref": "PostInstallArgs"
          },
          "RAIDOptions": {
            "Ref": "RAIDOptions"
          },
          "EFSId": {
            "Fn::If": [
              "CreateEFSSubstack",
              {
                "Fn::GetAtt": [
                  "EFSSubstack",
                  "Outputs.FileSystemId"
                ]
              },
              ""
            ]
          },
          "EFSOptions": {
            "Ref": "EFSOptions"
          },
          "FSXId": {
            "Fn::If": [
              "CreateFSXSubstack",
              {
                "Fn::GetAtt": [
                  "FSXSubstack",
                  "Outputs.FileSystemId"
                ]
              },
              ""
            ]
          },
          "FSXMountName": {
            "Fn::If": [
              "CreateFSXSubstack",
              {
                "Fn::GetAtt": [
                  "FSXSubstack",
                  "Outputs.MountName"
                ]
              },
              ""
            ]
          },
          "FSXDNSName": {
            "Fn::If": [
              "CreateFSXSubstack",
              {
                "Fn::GetAtt": [
                  "FSXSubstack",
                  "Outputs.DNSName"
                ]
              },
              ""
            ]
          },
          "FSXOptions": {
            "Ref": "FSXOptions"
          },
          "Scheduler": {
            "Ref": "Scheduler"
          },
          "EncryptedEphemeral": {
            "Ref": "EncryptedEphemeral"
          },
          "EphemeralDir": {
            "Ref": "EphemeralDir"
          },
          "SharedDir": {
            "Ref": "SharedDir"
          },
          "ProxyServer": {
            "Ref": "ProxyServer"
          },
          "ClusterDNSDomain": {
            "Fn::Sub": [
              "${ClusterName}.pcluster",
              {
                "ClusterName": {
                  "Fn::Select": [
                    "1",
                    {
                      "Fn::Split": [
                        "parallelcluster-",
                        {
                          "Ref": "AWS::StackName"
                        }
                      ]
                    }
                  ]
                }
              }
            ]
          },
          "IntelHPCPlatform": {
            "Ref": "IntelHPCPlatform"
          },
          "CWLoggingEnabled": {
            "Fn::GetAtt": [
              "CloudWatchLogsSubstack",
              "Outputs.Enabled"
            ]
          },
          "ExtraJson": {
            "Ref": "ExtraJson"
          },
          "CustomChefCookbook": {
            "Ref": "CustomChefCookbook"
          },
          "AWSDomain": {
            "Fn::FindInMap": [
              "Partition2Url",
              {
                "Ref": "AWS::Partition"
              },
              "url"
            ]
          },
          "ParallelClusterVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "parallelcluster"
            ]
          },
          "CookbookVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "cookbook"
            ]
          },
          "ChefVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "chef"
            ]
          },
          "BerkshelfVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "berkshelf"
            ]
          },
          "ComputeSecurityGroups": {
            "Fn::Join": [
              ",",
              [
                {
                  "Fn::If": [
                    "CreateSecurityGroups",
                    {
                      "Ref": "ComputeSecurityGroup"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                },
                {
                  "Fn::If": [
                    "AddAdditionalSG",
                    {
                      "Ref": "AdditionalSG"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                },
                {
                  "Fn::If": [
                    "UseExistingSecurityGroup",
                    {
                      "Ref": "VPCSecurityGroupId"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                }
              ]
            ]
          },
          "AssociatePublicIpAddress": {
            "Fn::If": [
              "ComputePublicIps",
              true,
              false
            ]
          },
          "VPCId": {
            "Ref": "VPCId"
          },
          "RootRole": {
            "Fn::If": [
              "UseEC2IAMRole",
              "NONE",
              {
                "Ref": "RootRole"
              }
            ]
          },
          "IAMLambdaRoleName": {
            "Ref": "IAMLambdaRoleName"
          },
          "ResourcesS3Bucket": {
            "Ref": "ResourcesS3Bucket"
          },
          "ArtifactS3RootDirectory": {
            "Ref": "ArtifactS3RootDirectory"
          },
          "UseProvidedResourcesS3Bucket": {
            "Fn::If": [
              "UseProvidedResourcesS3Bucket",
              "true",
              "false"
            ]
          },
          "CreateEC2IAMRole": {
            "Fn::If": [
              "CreateEC2IAMRole",
              "true",
              "false"
            ]
          }
        },
        "TemplateURL": {
          "Fn::Sub": [
            "https://${ResourcesS3Bucket}.s3.${AWS::Region}.${s3_url}/${ArtifactS3RootDirectory}/templates/compute-fleet-hit-substack.rendered.cfn.yaml",
            {
              "s3_url": {
                "Fn::FindInMap": [
                  "Partition2Url",
                  {
                    "Ref": "AWS::Partition"
                  },
                  "url"
                ]
              }
            }
          ]
        }
      },
      "Condition": "CreateHITSubstack"
    },
    "CloudWatchDashboardSubstack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "Parameters": {
          "PclusterStackName": {
            "Ref": "AWS::StackName"
          },
          "CWLogGroupName": {
            "Fn::Sub": [
              "/aws/parallelcluster/${cluster_name}",
              {
                "cluster_name": {
                  "Fn::Select": [
                    "1",
                    {
                      "Fn::Split": [
                        "parallelcluster-",
                        {
                          "Ref": "AWS::StackName"
                        }
                      ]
                    }
                  ]
                }
              }
            ]
          },
          "MasterInstanceId": {
            "Fn::GetAtt": [
              "MasterServerSubstack",
              "Outputs.MasterInstanceID"
            ]
          },
          "MasterPrivateIP": {
            "Fn::GetAtt": [
              "MasterServerSubstack",
              "Outputs.MasterPrivateIP"
            ]
          },
          "EBSVolumesIds": {
            "Fn::GetAtt": [
              "EBSCfnStack",
              "Outputs.Volumeids"
            ]
          },
          "RAIDVolumesIds": {
            "Fn::If": [
              "CreateRAIDSubstack",
              {
                "Fn::GetAtt": [
                  "RAIDSubstack",
                  "Outputs.Volumeids"
                ]
              },
              "NONE"
            ]
          },
          "EFSFileSystemId": {
            "Fn::If": [
              "CreateEFSSubstack",
              {
                "Fn::GetAtt": [
                  "EFSSubstack",
                  "Outputs.FileSystemId"
                ]
              },
              "NONE"
            ]
          },
          "FSXFileSystemId": {
            "Fn::If": [
              "CreateFSXSubstack",
              {
                "Fn::GetAtt": [
                  "FSXSubstack",
                  "Outputs.FileSystemId"
                ]
              },
              "NONE"
            ]
          }
        },
        "TemplateURL": {
          "Fn::Sub": [
            "https://${ResourcesS3Bucket}.s3.${AWS::Region}.${s3_url}/${ArtifactS3RootDirectory}/templates/cw-dashboard-substack.rendered.cfn.yaml",
            {
              "s3_url": {
                "Fn::FindInMap": [
                  "Partition2Url",
                  {
                    "Ref": "AWS::Partition"
                  },
                  "url"
                ]
              }
            }
          ]
        }
      }
    }
  },
  "Outputs": {
    "ClusterUser": {
      "Description": "Username to login to head node",
      "Value": {
        "Fn::FindInMap": [
          "OSFeatures",
          {
            "Ref": "BaseOS"
          },
          "User"
        ]
      }
    },
    "MasterPrivateIP": {
      "Description": "Private IP Address of the head node",
      "Value": {
        "Fn::GetAtt": [
          "MasterServerSubstack",
          "Outputs.MasterPrivateIP"
        ]
      }
    },
    "MasterPublicIP": {
      "Description": "Public IP Address of the head node",
      "Value": {
        "Fn::GetAtt": [
          "MasterServerSubstack",
          "Outputs.MasterPublicIP"
        ]
      },
      "Condition": "MasterPublicIp"
    },
    "GangliaPrivateURL": {
      "Description": "Private URL to access Ganglia (disabled by default)",
      "Value": {
        "Fn::Join": [
          "",
          [
            "http://",
            {
              "Fn::GetAtt": [
                "MasterServerSubstack",
                "Outputs.MasterPrivateIP"
              ]
            },
            "/ganglia/"
          ]
        ]
      }
    },
    "GangliaPublicURL": {
      "Description": "Public URL to access Ganglia (disabled by default)",
      "Value": {
        "Fn::Join": [
          "",
          [
            "http://",
            {
              "Fn::GetAtt": [
                "MasterServerSubstack",
                "Outputs.MasterPublicIP"
              ]
            },
            "/ganglia/"
          ]
        ]
      },
      "Condition": "MasterPublicIp"
    },
    "ResourcesS3Bucket": {
      "Description": "S3 user bucket where AWS ParallelCluster resources are stored",
      "Value": {
        "Ref": "ResourcesS3Bucket"
      }
    },
    "ArtifactS3RootDirectory": {
      "Description": "Root directory in S3 bucket where cluster artifacts are stored",
      "Value": {
        "Ref": "ArtifactS3RootDirectory"
      }
    },
    "BatchComputeEnvironmentArn": {
      "Value": {
        "Fn::GetAtt": [
          "AWSBatchStack",
          "Outputs.ComputeEnvironmentArn"
        ]
      },
      "Condition": "CreateAWSBatchStack"
    },
    "BatchJobQueueArn": {
      "Value": {
        "Fn::GetAtt": [
          "AWSBatchStack",
          "Outputs.JobQueueArn"
        ]
      },
      "Condition": "CreateAWSBatchStack"
    },
    "BatchJobDefinitionArn": {
      "Value": {
        "Fn::GetAtt": [
          "AWSBatchStack",
          "Outputs.JobDefinitionArn"
        ]
      },
      "Condition": "CreateAWSBatchStack"
    },
    "BatchJobDefinitionMnpArn": {
      "Value": {
        "Fn::GetAtt": [
          "AWSBatchStack",
          "Outputs.MNPJobDefinitionArn"
        ]
      },
      "Condition": "CreateAWSBatchStack"
    },
    "BatchUserRole": {
      "Value": {
        "Fn::GetAtt": [
          "AWSBatchStack",
          "Outputs.BatchUserRole"
        ]
      },
      "Condition": "CreateAWSBatchStack"
    },
    "ASGName": {
      "Value": {
        "Fn::GetAtt": [
          "ComputeFleetSubstack",
          "Outputs.ASGName"
        ]
      },
      "Condition": "CreateComputeFleet"
    },
    "IsHITCluster": {
      "Value": "true",
      "Condition": "CreateHITSubstack"
    },
    "ClusterConfigMetadata": {
      "Value": {
        "Ref": "ClusterConfigMetadata"
      }
    }
  }
}
