{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "AWS ParallelCluster Template. Version: aws-parallelcluster-2.10.1",
  "Parameters": {
    "KeyName": {
      "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instances using the default cluster user.",
      "Type": "AWS::EC2::KeyPair::KeyName"
    },
    "MasterInstanceType": {
      "Description": "Head node EC2 instance type",
      "Type": "String",
      "ConstraintDescription": "Must be a valid EC2 instance type, with support for HVM."
    },
    "ComputeInstanceType": {
      "Description": "ComputeFleet EC2 instance type",
      "Type": "String",
      "Default": "NONE",
      "ConstraintDescription": "Must be a valid EC2 instance type, with support for HVM."
    },
    "MinSize": {
      "Description": "Initial number of compute EC2 instances / vCpus to launch within the cluster.",
      "Type": "Number",
      "Default": 0
    },
    "DesiredSize": {
      "Description": "Desired number of compute EC2 instances / vCpus to launch within the cluster.",
      "Type": "Number",
      "Default": 0
    },
    "MaxSize": {
      "Description": "Maximum number of compute EC2 instances / vCpus to launch within the cluster.",
      "Type": "Number",
      "Default": 0
    },
    "ComputeSubnetId": {
      "Description": "ID of the Subnet you want to provision the Compute Servers into",
      "Type": "String",
      "Default": "NONE",
      "AllowedPattern": "(NONE|^subnet-[0-9a-z]{8}$|^subnet-[0-9a-z]{17}$)"
    },
    "SpotPrice": {
      "Description": "Spot bid price for the ComputeFleet AutoScaling Group when the ClusterType = \"spot\". When awsbatch is the scheduler, this is spot bid percentage.",
      "Type": "Number",
      "Default": "0"
    },
    "ClusterType": {
      "Description": "Type of cluster to launch. Can either be \"ondemand\" or \"spot\". Choosing \"spot\" will cause the ComputeFleet AutoScaling group to launch EC2 Spot instances. Default value is \"ondemand\".",
      "Type": "String",
      "Default": "ondemand",
      "ConstraintDescription": "Must be a supported cluster type: ondemand, spot",
      "AllowedValues": [
        "ondemand",
        "spot"
      ]
    },
    "ProxyServer": {
      "Description": "hostname and port of HTTP proxy server for cfn-init, boto and yum i.e. proxy.example.com:8080",
      "Type": "String",
      "Default": "NONE"
    },
    "VolumeSize": {
      "Description": "Comma delimited list of size of EBS volume in GB, if creating a new one",
      "Type": "String",
      "Default": "NONE,NONE,NONE,NONE,NONE"
    },
    "VolumeType": {
      "Description": "Comma delimited list of type of volume to create either new or from snapshot",
      "Type": "String",
      "Default": "gp2,gp2,gp2,gp2,gp2",
      "ConstraintDescription": "must be a supported volume type: standard, io1, io2, gp2, gp3, st1, sc1",
      "AllowedPattern": "^(NONE|standard|io1|io2|gp2|gp3|st1|sc1)((,|, )(NONE|standard|io1|io2|gp2|gp3|st1|sc1)){4}$"
    },
    "MasterSubnetId": {
      "Description": "ID of the Subnet you want to provision the head node into",
      "Type": "AWS::EC2::Subnet::Id"
    },
    "AvailabilityZone": {
      "Description": "Availability Zone the cluster will launch into. THIS IS REQUIRED",
      "Type": "AWS::EC2::AvailabilityZone::Name"
    },
    "EBSSnapshotId": {
      "Description": "Comma delimited list of Id of EBS snapshot if using snapshot as source for volume",
      "Type": "String",
      "Default": "NONE,NONE,NONE,NONE,NONE",
      "AllowedPattern": "^(NONE|snap-[0-9a-z]{8}|snap-[0-9a-z]{17})((,|, )(NONE|snap-[0-9a-z]{8}|snap-[0-9a-z]{17})){4}$"
    },
    "CustomAMI": {
      "Description": "ID of a Custom AMI, to use instead of published AMI's",
      "Type": "String",
      "Default": "NONE",
      "AllowedPattern": "(NONE|^ami-[0-9a-z]{8}$|^ami-[0-9a-z]{17}$)"
    },
    "VPCId": {
      "Description": "ID of the VPC you want to provision cluster into. Only used with UseVPCBase=false",
      "Type": "AWS::EC2::VPC::Id"
    },
    "AccessFrom": {
      "Description": "Lockdown SSH/HTTP access (default can be accessed from anywhere)",
      "Type": "String",
      "MinLength": "9",
      "MaxLength": "18",
      "Default": "0.0.0.0/0",
      "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription": "must be a valid CIDR range of the form x.x.x.x/x."
    },
    "ComputeSubnetCidr": {
      "Description": "CIDR(s) for new backend subnet(s) i.e. 10.0.100.0/24. This is a comma-delimited list and can support multiple CIDR ranges for a multi-AZ cluster. The order and length of this list MUST match the AvailabilityZones parameter.",
      "Type": "String",
      "ConstraintDescription": "must be a valid CIDR range of the form x.x.x.x/x.",
      "AllowedPattern": "(NONE|(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2}))",
      "Default": "NONE"
    },
    "UsePublicIps": {
      "Description": "Boolean flag to use public IP's for instances. If false, the VPC must be correctly setup to use NAT for all traffic.",
      "Type": "String",
      "Default": "true",
      "ConstraintDescription": "true/false",
      "AllowedValues": [
        "true",
        "false"
      ]
    },
    "VolumeIOPS": {
      "Description": "Comma delimited list of number of IOPS for volume type io1, io2 and gp3. Not used for other volume types.",
      "Type": "String",
      "Default": "NONE,NONE,NONE,NONE,NONE"
    },
    "VolumeThroughput": {
      "Description": "Comma delimited list of number of Throughtput for volume type gp3. Not used for other volume types.",
      "Type": "String",
      "Default": "125,125,125,125,125"
    },
    "PreInstallScript": {
      "Description": "Preinstall script URL. This is run before any host configuration.",
      "Type": "String",
      "Default": "NONE"
    },
    "PostInstallScript": {
      "Description": "Postinstall script URL. This is run before any host configuration.",
      "Type": "String",
      "Default": "NONE"
    },
    "S3ReadResource": {
      "Description": "S3 resource with read access from AWS ParallelCluster nodes",
      "Type": "String",
      "Default": "NONE"
    },
    "S3ReadWriteResource": {
      "Description": "Addtional policy document to be added to EC2 IAM role created and assigned to all nodes.",
      "Type": "String",
      "Default": "NONE"
    },
    "Placement": {
      "Description": "Type of placement requird in AWS ParallelCluster, it can either be cluster or compute.",
      "Type": "String",
      "Default": "compute",
      "AllowedValues": [
        "cluster",
        "compute"
      ]
    },
    "PlacementGroup": {
      "Description": "The name of an existing placement group",
      "Type": "String",
      "Default": "NONE"
    },
    "EncryptedEphemeral": {
      "Description": "Boolean flag to encrypt local ephemeral drives. The keys are in-memory and non-recoverable.",
      "Type": "String",
      "Default": "false",
      "ConstraintDescription": "true/false",
      "AllowedValues": [
        "true",
        "false"
      ]
    },
    "PreInstallArgs": {
      "Description": "Preinstall script args passed to the preinstall script.",
      "Type": "String",
      "Default": "NONE"
    },
    "PostInstallArgs": {
      "Description": "Postinstall script args passed to the postinstall script.",
      "Type": "String",
      "Default": "NONE"
    },
    "EBSEncryption": {
      "Description": "Comma delimited list of boolean flag to use EBS encryption for /shared volume. (Not to be used for snapshots)",
      "Type": "String",
      "Default": "false,false,false,false,false",
      "ConstraintDescription": "true/false",
      "AllowedPattern": "^(NONE|true|false)((,|, )(NONE|true|false)){4}$"
    },
    "EphemeralDir": {
      "Description": "The path/mountpoint for the ephemeral drive",
      "Type": "String",
      "Default": "/scratch"
    },
    "BaseOS": {
      "Description": "Base OS type for cluster AMI",
      "Type": "String",
      "Default": "alinux2",
      "ConstraintDescription": "must be a supported base OS",
      "AllowedValues": [
        "centos7",
        "centos8",
        "alinux",
        "alinux2",
        "ubuntu1604",
        "ubuntu1804"
      ]
    },
    "Architecture": {
      "Description": "Architecture to use when selecting default AMIs",
      "Type": "String",
      "Default": "x86_64",
      "ConstraintDescription": "Must be either x86_64 or arm64",
      "AllowedValues": [
        "x86_64",
        "arm64"
      ]
    },
    "ScaleDownIdleTime": {
      "Description": "Period in minutes without jobs after which compute node will terminate ",
      "Type": "String",
      "Default": "10"
    },
    "Scheduler": {
      "Description": "Cluster scheduler",
      "Type": "String",
      "Default": "slurm",
      "ConstraintDescription": "must be a supported scheduler",
      "AllowedValues": [
        "sge",
        "torque",
        "slurm",
        "awsbatch"
      ]
    },
    "SharedDir": {
      "Description": "The path/mountpoint for the shared drive",
      "Type": "String",
      "Default": "/shared"
    },
    "ClusterConfigMetadata": {
      "Description": "Cluster configuration metadata.",
      "Type": "String",
      "Default": "{}"
    },
    "AdditionalSG": {
      "Description": "Additional VPC security group to be added to instances. Defaults to NONE",
      "Type": "String",
      "Default": "NONE",
      "AllowedPattern": "(NONE|^sg-[0-9a-z]{8}$|^sg-[0-9a-z]{17}$)"
    },
    "CustomChefCookbook": {
      "Description": "URL of custom cookbook that will override the default. This will be unpacked and then dependencies resolved with Berkshelf.",
      "Type": "String",
      "Default": "NONE"
    },
    "ExtraJson": {
      "Description": "Extra json to be added to Chef dna.json",
      "Type": "String",
      "Default": "{}"
    },
    "EBSKMSKeyId": {
      "Description": "Comma delimited list of KMS ARN for customer created master key, will be used for EBS encryption",
      "Type": "String",
      "Default": "NONE,NONE,NONE,NONE,NONE"
    },
    "MasterRootVolumeSize": {
      "Description": "Size of head node EBS root volume in GB",
      "Type": "Number",
      "Default": "25",
      "MinValue": "25"
    },
    "ComputeRootVolumeSize": {
      "Description": "Size of ComputeFleet EBS root volume in GB",
      "Type": "Number",
      "Default": "25",
      "MinValue": "25"
    },
    "EC2IAMRoleName": {
      "Description": "Existing EC2 IAM role name",
      "Type": "String",
      "Default": "NONE"
    },
    "EC2IAMPolicies": {
      "Description": "Attach additional IAM Policies to the created Root Role",
      "Type": "CommaDelimitedList",
      "Default": "NONE"
    },
    "IAMLambdaRoleName": {
      "Description": "Existing IAM role name for Lambda functions",
      "Type": "String",
      "Default": "NONE"
    },
    "VPCSecurityGroupId": {
      "Description": "Existing VPC security group Id",
      "Type": "String",
      "Default": "NONE",
      "AllowedPattern": "(NONE|^sg-[0-9a-z]{8}$|^sg-[0-9a-z]{17}$)"
    },
    "EBSVolumeId": {
      "Description": "Comma delimited list of existing EBS volume Id",
      "Type": "String",
      "Default": "NONE,NONE,NONE,NONE,NONE",
      "AllowedPattern": "^(NONE|vol-[0-9a-z]{8}|vol-[0-9a-z]{17})((,|, )(NONE|vol-[0-9a-z]{8}|vol-[0-9a-z]{17})){4}$"
    },
    "AdditionalCfnTemplate": {
      "Description": "A second CloudFormation template to launch with the cluster",
      "Type": "String",
      "Default": "NONE"
    },
    "ResourcesS3Bucket": {
      "Description": "S3 bucket where resources needed by the stack are located. The bucket gets deleted on stack deletion if it is not user-provided.",
      "Type": "String"
    },
    "ArtifactS3RootDirectory": {
      "Description": "Root directory in S3 bucket where cluster artifacts are stored, i.e. cluster artifacts would be under {ResourcesS3Bucket}/{ArtifactS3RootDirectory}.",
      "Type": "String"
    },
    "RemoveBucketOnDeletion": {
      "Description": "Parameter to control if bucket is removed on cluster deletion. pcluster created buckets are alway removed, user provided buckets are kept.",
      "Type": "String"
    },
    "RAIDOptions": {
      "Description": "Comma Separated List of RAID related options, 9 parameters in total, [shared_dir,raid_type,num_of_raid_volumes,volume_type,volume_size,volume_iops,encrypted,ebs_kms_key_id,volume_throughput]",
      "Type": "String",
      "Default": "NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE",
      "AllowedPattern": "^(NONE|.+)(,|, )(NONE|\\d)(,|, )(NONE|\\d)(,|, )(NONE|standard|io1|io2|gp2|gp3|st1|sc1)(,|, )(NONE|\\d+)(,|, )(NONE|\\d+)(,|, )(NONE|true|false)(,|, )(NONE|.+)(,|, )(NONE|\\d+)$"
    },
    "NumberOfEBSVol": {
      "Description": "Number of EBS Volumes the user requested, up to 5",
      "Type": "Number",
      "Default": "1"
    },
    "FSXOptions": {
      "Description": "Comma separated list of FSx related options, 17 parameters in total, [shared_dir,fsx_fs_id,storage_capacity,fsx_kms_key_id,imported_file_chunk_size,export_path,import_path,weekly_maintenance_start_time,deployment_type,per_unit_storage_throughput,daily_automatic_backup_start_time,automatic_backup_retention_days,copy_tags_to_backups,fsx_backup_id,auto_import_policy,storage_type,drive_cache_type]",
      "Type": "String",
      "Default": "NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE"
    },
    "EFSOptions": {
      "Description": "Comma separated list of EFS related options, 9 parameters in total, [shared_dir,efs_fs_id,performance_mode,efs_kms_key_id,provisioned_throughput,encrypted,throughput_mode,exists_valid_head_node_mt,exists_valid_compute_mt]",
      "Type": "String",
      "Default": "NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE"
    },
    "Cores": {
      "Description": "Comma seperated string of [head node cores], [compute cores], [head node instance type supports disabling hyperthreading via CPU options], [compute instance type supports disabling hyperthreading via CPU options].",
      "Type": "CommaDelimitedList",
      "Default": "NONE,NONE,NONE,NONE"
    },
    "EFA": {
      "Description": "Enable EFA on the compute nodes, enable_efa = compute",
      "Type": "String",
      "Default": "NONE"
    },
    "EFAGDR": {
      "Description": "Enable EFA GPUDirect Support on the compute nodes, enable_efa_gdr = compute",
      "Type": "String",
      "Default": "NONE"
    },
    "DCVOptions": {
      "Description": "Comma separated list of NICE DCV related options, 3 parameters in total, [enabled,port,access_from]",
      "Type": "String",
      "Default": "NONE,NONE,NONE"
    },
    "IntelHPCPlatform": {
      "Description": "Enable Intel HPC Platform packages.",
      "Type": "String",
      "AllowedValues": [
        "true",
        "false"
      ]
    },
    "CWLogOptions": {
      "Description": "Comma separated list of CloudWatch logging, 2 parameters in total, [enabled, retention_days]",
      "Type": "String",
      "Default": "true,14"
    },
    "NetworkInterfacesCount": {
      "Description": "Comma separated string of [head node network interfaces], [compute network interfaces].",
      "Type": "CommaDelimitedList",
      "Default": "1,1"
    }
  },
  "Conditions": {
    "CreateEFSSubstack": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "0",
                {
                  "Fn::Split": [
                    ",",
                    {
                      "Ref": "EFSOptions"
                    }
                  ]
                }
              ]
            },
            "NONE"
          ]
        }
      ]
    },
    "CreateRAIDSubstack": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            "NONE",
            {
              "Fn::Select": [
                "0",
                {
                  "Fn::Split": [
                    ",",
                    {
                      "Ref": "RAIDOptions"
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    "CreateFSXSubstack": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "0",
                {
                  "Fn::Split": [
                    ",",
                    {
                      "Ref": "FSXOptions"
                    }
                  ]
                }
              ]
            },
            "NONE"
          ]
        }
      ]
    },
    "UseSpotPrice": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "SpotPrice"
            },
            "0"
          ]
        }
      ]
    },
    "CreateComputeSubnetForCompute": {
      "Fn::And": [
        {
          "Fn::Equals": [
            {
              "Ref": "ComputeSubnetId"
            },
            "NONE"
          ]
        },
        {
          "Fn::Not": [
            {
              "Fn::Equals": [
                {
                  "Ref": "ComputeSubnetCidr"
                },
                "NONE"
              ]
            }
          ]
        }
      ]
    },
    "UseMasterSubnetForCompute": {
      "Fn::Or": [
        {
          "Fn::And": [
            {
              "Fn::Equals": [
                {
                  "Ref": "ComputeSubnetId"
                },
                "NONE"
              ]
            },
            {
              "Fn::Equals": [
                {
                  "Ref": "ComputeSubnetCidr"
                },
                "NONE"
              ]
            }
          ]
        },
        {
          "Fn::Equals": [
            {
              "Ref": "ComputeSubnetId"
            },
            {
              "Ref": "MasterSubnetId"
            }
          ]
        }
      ]
    },
    "UseCustomAMI": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "CustomAMI"
            },
            "NONE"
          ]
        }
      ]
    },
    "MasterPublicIp": {
      "Fn::Equals": [
        {
          "Ref": "UsePublicIps"
        },
        "true"
      ]
    },
    "ComputePublicIps": {
      "Fn::And": [
        {
          "Fn::Equals": [
            {
              "Ref": "UsePublicIps"
            },
            "true"
          ]
        },
        {
          "Condition": "UseMasterSubnetForCompute"
        }
      ]
    },
    "UseS3ReadPolicy": {
      "Fn::And": [
        {
          "Fn::Not": [
            {
              "Fn::Equals": [
                {
                  "Ref": "S3ReadResource"
                },
                "NONE"
              ]
            }
          ]
        },
        {
          "Condition": "CreateEC2IAMRole"
        }
      ]
    },
    "UsePlacementGroup": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "PlacementGroup"
            },
            "NONE"
          ]
        }
      ]
    },
    "UseClusterPlacement": {
      "Fn::And": [
        {
          "Fn::Equals": [
            {
              "Ref": "Placement"
            },
            "cluster"
          ]
        },
        {
          "Condition": "UsePlacementGroup"
        }
      ]
    },
    "UseS3ReadWritePolicy": {
      "Fn::And": [
        {
          "Fn::Not": [
            {
              "Fn::Equals": [
                {
                  "Ref": "S3ReadWriteResource"
                },
                "NONE"
              ]
            }
          ]
        },
        {
          "Condition": "CreateEC2IAMRole"
        }
      ]
    },
    "AddAdditionalSG": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AdditionalSG"
            },
            "NONE"
          ]
        }
      ]
    },
    "UseEC2IAMRole": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "EC2IAMRoleName"
            },
            "NONE"
          ]
        }
      ]
    },
    "UseEC2IAMPolicies": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                "0",
                {
                  "Ref": "EC2IAMPolicies"
                }
              ]
            },
            "NONE"
          ]
        }
      ]
    },
    "CreateEC2IAMRole": {
      "Fn::Equals": [
        {
          "Ref": "EC2IAMRoleName"
        },
        "NONE"
      ]
    },
    "CreateIAMLambdaRole": {
      "Fn::Equals": [
        {
          "Ref": "IAMLambdaRoleName"
        },
        "NONE"
      ]
    },
    "AddHITIamPolicies": {
      "Fn::And": [
        {
          "Condition": "CreateEC2IAMRole"
        },
        {
          "Condition": "CreateHITSubstack"
        }
      ]
    },
    "UseExistingSecurityGroup": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "VPCSecurityGroupId"
            },
            "NONE"
          ]
        }
      ]
    },
    "CreateSecurityGroups": {
      "Fn::Equals": [
        {
          "Ref": "VPCSecurityGroupId"
        },
        "NONE"
      ]
    },
    "CreateSubStack": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AdditionalCfnTemplate"
            },
            "NONE"
          ]
        }
      ]
    },
    "CreatePlacementGroup": {
      "Fn::And": [
        {
          "Fn::Equals": [
            {
              "Ref": "PlacementGroup"
            },
            "DYNAMIC"
          ]
        },
        {
          "Condition": "UsePlacementGroup"
        },
        {
          "Fn::Not": [
            {
              "Condition": "CreateHITSubstack"
            }
          ]
        }
      ]
    },
    "CreateComputeFleet": {
      "Fn::Not": [
        {
          "Fn::Or": [
            {
              "Fn::Equals": [
                {
                  "Ref": "Scheduler"
                },
                "awsbatch"
              ]
            },
            {
              "Condition": "CreateHITSubstack"
            }
          ]
        }
      ]
    },
    "CreateHITSubstack": {
      "Fn::Equals": [
        {
          "Ref": "Scheduler"
        },
        "slurm"
      ]
    },
    "CreateAWSBatchStack": {
      "Fn::Equals": [
        {
          "Ref": "Scheduler"
        },
        "awsbatch"
      ]
    },
    "EnableDCV": {
      "Fn::Equals": [
        {
          "Fn::Select": [
            "0",
            {
              "Fn::Split": [
                ",",
                {
                  "Ref": "DCVOptions"
                }
              ]
            }
          ]
        },
        "master"
      ]
    },
    "UseArmAMIs": {
      "Fn::Equals": [
        {
          "Ref": "Architecture"
        },
        "arm64"
      ]
    },
    "UseProvidedResourcesS3Bucket": {
      "Fn::Equals": [
        {
          "Ref": "RemoveBucketOnDeletion"
        },
        "False"
      ]
    }
  },
  "Mappings": {
    "AWSRegionOS2AMIarm64": {
      "af-south-1": {
        "alinux": "UNSUPPORTED",
        "alinux2": "ami-00cd9a9915d5abf79",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-0b0a12580b8fcdfe5",
        "ubuntu1604": "UNSUPPORTED",
        "ubuntu1804": "ami-046d98477dd9fc7eb"
      },
      "ap-east-1": {
        "alinux": "UNSUPPORTED",
        "alinux2": "ami-0f73d5986d43564e2",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-007ed99f82a962cc1",
        "ubuntu1604": "UNSUPPORTED",
        "ubuntu1804": "ami-0d2624d4b9e6970e7"
      },
      "ap-northeast-1": {
        "alinux": "UNSUPPORTED",
        "alinux2": "ami-0802175acef9f342e",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-0490e30625fc3466f",
        "ubuntu1604": "UNSUPPORTED",
        "ubuntu1804": "ami-08efda47b57a7c048"
      },
      "ap-northeast-2": {
        "alinux": "UNSUPPORTED",
        "alinux2": "ami-0b67c1511fe4c46e1",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-03222a04de4228c08",
        "ubuntu1604": "UNSUPPORTED",
        "ubuntu1804": "ami-05ae60c35b06f34e5"
      },
      "ap-northeast-3": {
        "alinux": "UNSUPPORTED",
        "alinux2": "UNSUPPORTED",
        "centos7": "UNSUPPORTED",
        "centos8": "UNSUPPORTED",
        "ubuntu1604": "UNSUPPORTED",
        "ubuntu1804": "UNSUPPORTED"
      },
      "ap-south-1": {
        "alinux": "UNSUPPORTED",
        "alinux2": "ami-0e75152f8053094c3",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-0075369b2abf46b05",
        "ubuntu1604": "UNSUPPORTED",
        "ubuntu1804": "ami-0ef07d3677758fee7"
      },
      "ap-southeast-1": {
        "alinux": "UNSUPPORTED",
        "alinux2": "ami-0da4635ceb6d846d9",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-086fd32165ac4e0a2",
        "ubuntu1604": "UNSUPPORTED",
        "ubuntu1804": "ami-052b40fbf4a7d852f"
      },
      "ap-southeast-2": {
        "alinux": "UNSUPPORTED",
        "alinux2": "ami-0d7a81adbdde9dce5",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-07fb6c0c050a39292",
        "ubuntu1604": "UNSUPPORTED",
        "ubuntu1804": "ami-02a57f04d151d2ce2"
      },
      "ca-central-1": {
        "alinux": "UNSUPPORTED",
        "alinux2": "ami-070c24fa069a27265",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-04be4e45fe60b19e1",
        "ubuntu1604": "UNSUPPORTED",
        "ubuntu1804": "ami-0bef62a8de524cc3d"
      },
      "cn-north-1": {
        "alinux": "UNSUPPORTED",
        "alinux2": "UNSUPPORTED",
        "centos7": "UNSUPPORTED",
        "centos8": "UNSUPPORTED",
        "ubuntu1604": "UNSUPPORTED",
        "ubuntu1804": "UNSUPPORTED"
      },
      "cn-northwest-1": {
        "alinux": "UNSUPPORTED",
        "alinux2": "UNSUPPORTED",
        "centos7": "UNSUPPORTED",
        "centos8": "UNSUPPORTED",
        "ubuntu1604": "UNSUPPORTED",
        "ubuntu1804": "UNSUPPORTED"
      },
      "eu-central-1": {
        "alinux": "UNSUPPORTED",
        "alinux2": "ami-0331d559f079efd03",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-02ea94742b76197a4",
        "ubuntu1604": "UNSUPPORTED",
        "ubuntu1804": "ami-0ab72b2539a8e4eaf"
      },
      "eu-north-1": {
        "alinux": "UNSUPPORTED",
        "alinux2": "ami-03e4cc7f565c8efec",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-052bb6243fc4b84a3",
        "ubuntu1604": "UNSUPPORTED",
        "ubuntu1804": "ami-00315391fc87d6a4a"
      },
      "eu-south-1": {
        "alinux": "UNSUPPORTED",
        "alinux2": "ami-0392d65ba7c8af2b5",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-015ae8f55912771fe",
        "ubuntu1604": "UNSUPPORTED",
        "ubuntu1804": "ami-00d476744294f458a"
      },
      "eu-west-1": {
        "alinux": "UNSUPPORTED",
        "alinux2": "ami-0b86c4a8da59d6d11",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-0773e67d6a7466681",
        "ubuntu1604": "UNSUPPORTED",
        "ubuntu1804": "ami-0224e61822e0603ba"
      },
      "eu-west-2": {
        "alinux": "UNSUPPORTED",
        "alinux2": "ami-039c5ad24328545a9",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-009ac53f9323b9865",
        "ubuntu1604": "UNSUPPORTED",
        "ubuntu1804": "ami-06496496998c0480a"
      },
      "eu-west-3": {
        "alinux": "UNSUPPORTED",
        "alinux2": "ami-067a371d97ca6fcf2",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-021787c0ad5f60f6b",
        "ubuntu1604": "UNSUPPORTED",
        "ubuntu1804": "ami-0d16162157fa31ea4"
      },
      "me-south-1": {
        "alinux": "UNSUPPORTED",
        "alinux2": "ami-0ea4909cdeeef4b03",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-085892d9aec1ed9f9",
        "ubuntu1604": "UNSUPPORTED",
        "ubuntu1804": "ami-0ce1e2728e4ba14c6"
      },
      "sa-east-1": {
        "alinux": "UNSUPPORTED",
        "alinux2": "ami-013861b8a2b1a63b5",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-0d3e6fbc43aaa308c",
        "ubuntu1604": "UNSUPPORTED",
        "ubuntu1804": "ami-079a46ad6559d1023"
      },
      "us-east-1": {
        "alinux": "UNSUPPORTED",
        "alinux2": "ami-0b1f998cf2b1498db",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-02839a5871b4ec582",
        "ubuntu1604": "UNSUPPORTED",
        "ubuntu1804": "ami-0a5c0725ce4d960f1"
      },
      "us-east-2": {
        "alinux": "UNSUPPORTED",
        "alinux2": "ami-059703a477566540c",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-0d4f0890ef069afc0",
        "ubuntu1604": "UNSUPPORTED",
        "ubuntu1804": "ami-08776e764b05c8fa7"
      },
      "us-gov-east-1": {
        "alinux": "UNSUPPORTED",
        "alinux2": "UNSUPPORTED",
        "centos7": "UNSUPPORTED",
        "centos8": "UNSUPPORTED",
        "ubuntu1604": "UNSUPPORTED",
        "ubuntu1804": "UNSUPPORTED"
      },
      "us-gov-west-1": {
        "alinux": "UNSUPPORTED",
        "alinux2": "UNSUPPORTED",
        "centos7": "UNSUPPORTED",
        "centos8": "UNSUPPORTED",
        "ubuntu1604": "UNSUPPORTED",
        "ubuntu1804": "UNSUPPORTED"
      },
      "us-west-1": {
        "alinux": "UNSUPPORTED",
        "alinux2": "ami-08540a991b0cd29bd",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-0aaeb3457c5f4a511",
        "ubuntu1604": "UNSUPPORTED",
        "ubuntu1804": "ami-0ca03ec3eca322ace"
      },
      "us-west-2": {
        "alinux": "UNSUPPORTED",
        "alinux2": "ami-0257f455a26d9ed84",
        "centos7": "UNSUPPORTED",
        "centos8": "ami-02a5f2d441ae4ea8e",
        "ubuntu1604": "UNSUPPORTED",
        "ubuntu1804": "ami-0f67bacfcdf1f2374"
      }
    },
    "AWSRegionOS2AMIx86": {
      "af-south-1": {
        "alinux": "ami-0f2e2135a05f814df",
        "alinux2": "ami-046f49b550ce90d8a",
        "centos7": "ami-0e0fb5acd64f2be5e",
        "centos8": "ami-0d881910a58319c15",
        "ubuntu1604": "ami-041e26e4bfed8cd7b",
        "ubuntu1804": "ami-04280c7f4bee35afe"
      },
      "ap-east-1": {
        "alinux": "ami-05ef7cb79d3a43092",
        "alinux2": "ami-0ec0d099b8a276aec",
        "centos7": "ami-0d6f16d7fceae84ee",
        "centos8": "ami-0ca1228e9ddcfa963",
        "ubuntu1604": "ami-04539233794f181f7",
        "ubuntu1804": "ami-0d16f6585c134b76d"
      },
      "ap-northeast-1": {
        "alinux": "ami-006b7f4c929aaf4a9",
        "alinux2": "ami-0a13402dc88c19be2",
        "centos7": "ami-03a451be7ebcc159e",
        "centos8": "ami-075b3892ecd63214f",
        "ubuntu1604": "ami-01fe6e75948fa65df",
        "ubuntu1804": "ami-096205fd8c1ea23b8"
      },
      "ap-northeast-2": {
        "alinux": "ami-06a49824cc501a981",
        "alinux2": "ami-0bdfbd3521caa5dd2",
        "centos7": "ami-0ba51cb6c4ceae756",
        "centos8": "ami-02287a8528bba818d",
        "ubuntu1604": "ami-05dd0b07a0e8cf644",
        "ubuntu1804": "ami-04ef860d893888eee"
      },
      "ap-northeast-3": {
        "alinux": "UNSUPPORTED",
        "alinux2": "UNSUPPORTED",
        "centos7": "UNSUPPORTED",
        "centos8": "UNSUPPORTED",
        "ubuntu1604": "UNSUPPORTED",
        "ubuntu1804": "UNSUPPORTED"
      },
      "ap-south-1": {
        "alinux": "ami-0a47fd68cf7034c58",
        "alinux2": "ami-0059d599d21636768",
        "centos7": "ami-0919124b7770af8d9",
        "centos8": "ami-0602d9f62b83744f5",
        "ubuntu1604": "ami-06aec0a1241e29730",
        "ubuntu1804": "ami-09fe484636519a7fd"
      },
      "ap-southeast-1": {
        "alinux": "ami-0e6cfdde386164836",
        "alinux2": "ami-074f58cccc7ebb68f",
        "centos7": "ami-021e3e90b0458781f",
        "centos8": "ami-0e789f414c14f6332",
        "ubuntu1604": "ami-0f35154dc0071f71b",
        "ubuntu1804": "ami-0d2894ee85aac22c0"
      },
      "ap-southeast-2": {
        "alinux": "ami-0ba7f788162c4a4de",
        "alinux2": "ami-04b4a20ee9f67608f",
        "centos7": "ami-0f5a161afeed62a35",
        "centos8": "ami-0d1d7229f7b73a5de",
        "ubuntu1604": "ami-0da4c39e17cdfef89",
        "ubuntu1804": "ami-07de67a2c91b2605c"
      },
      "ca-central-1": {
        "alinux": "ami-0808f2df200c7006c",
        "alinux2": "ami-0523a9bc4151ee96e",
        "centos7": "ami-057fc92460a096dab",
        "centos8": "ami-03ea006f20d390940",
        "ubuntu1604": "ami-098c762477bc6b1fb",
        "ubuntu1804": "ami-0b8b3c3a561758ae3"
      },
      "cn-north-1": {
        "alinux": "ami-050c2b7b0181fbfd5",
        "alinux2": "ami-0a12307d2d0ddc535",
        "centos7": "UNSUPPORTED",
        "centos8": "UNSUPPORTED",
        "ubuntu1604": "ami-0a3f41e4d89bdff32",
        "ubuntu1804": "ami-0abc7e40f18e6cda4"
      },
      "cn-northwest-1": {
        "alinux": "ami-07d8dd2f175498353",
        "alinux2": "ami-0ef379c7fd5eb332e",
        "centos7": "UNSUPPORTED",
        "centos8": "UNSUPPORTED",
        "ubuntu1604": "ami-0d304a0c5d04ac4e2",
        "ubuntu1804": "ami-0f52a155923e4de7f"
      },
      "eu-central-1": {
        "alinux": "ami-032358687770c43e1",
        "alinux2": "ami-07055c21834b0bc56",
        "centos7": "ami-0a0f1b95d41e6a651",
        "centos8": "ami-02277a3e208351cc6",
        "ubuntu1604": "ami-0df794834b461ba22",
        "ubuntu1804": "ami-07d1489352b517f39"
      },
      "eu-north-1": {
        "alinux": "ami-038781ae9b21b98ca",
        "alinux2": "ami-0fe475ca307943eb1",
        "centos7": "ami-0c191b20554866575",
        "centos8": "ami-00b01d23b71fff297",
        "ubuntu1604": "ami-06975933696e0263a",
        "ubuntu1804": "ami-0c47a559ed268c649"
      },
      "eu-south-1": {
        "alinux": "ami-0a9a6c50dc32a934f",
        "alinux2": "ami-042fc69d71433a75c",
        "centos7": "ami-03276d70dacf1a574",
        "centos8": "ami-0ffbb41ac00ef5dff",
        "ubuntu1604": "ami-0842531296e56778e",
        "ubuntu1804": "ami-01cfe122f3044a34d"
      },
      "eu-west-1": {
        "alinux": "ami-0dd799c2e1a68608e",
        "alinux2": "ami-063ac3df7f8595751",
        "centos7": "ami-000a3d84d3c77fdb3",
        "centos8": "ami-04a5c9c04faa5b9f7",
        "ubuntu1604": "ami-0d9c6bf221068c7c3",
        "ubuntu1804": "ami-0cbef8b383ddeff80"
      },
      "eu-west-2": {
        "alinux": "ami-0849a887182dd033a",
        "alinux2": "ami-086111e12527fa455",
        "centos7": "ami-0a347ff9b26c5e34c",
        "centos8": "ami-017fab72fc1db3851",
        "ubuntu1604": "ami-0d2a3fa50134294e9",
        "ubuntu1804": "ami-08d337feaf0f0a59f"
      },
      "eu-west-3": {
        "alinux": "ami-060df914a5b5ad680",
        "alinux2": "ami-0258a5a8320ccfa42",
        "centos7": "ami-02f8c6e2622c3804f",
        "centos8": "ami-041e8760a7b80cfde",
        "ubuntu1604": "ami-010b0bc4570ec96a3",
        "ubuntu1804": "ami-074fae2e6420b8ac7"
      },
      "me-south-1": {
        "alinux": "ami-0d68c8e916ccf0418",
        "alinux2": "ami-0c98692d98eb38c50",
        "centos7": "ami-0a64f83dd01c08dab",
        "centos8": "ami-0e30fd8da5a1ddc84",
        "ubuntu1604": "ami-08d2926b1669d79d2",
        "ubuntu1804": "ami-0d7bc19407d2b26a9"
      },
      "sa-east-1": {
        "alinux": "ami-0d4a17532432d5aa2",
        "alinux2": "ami-0f463bcf6d86cad85",
        "centos7": "ami-082aafa914dc04479",
        "centos8": "ami-005096f26ee208519",
        "ubuntu1604": "ami-0ae46391f64fa0b71",
        "ubuntu1804": "ami-0b7b49d35034bbc2f"
      },
      "us-east-1": {
        "alinux": "ami-0604e4a14869de93f",
        "alinux2": "ami-0b71488efbe422723",
        "centos7": "ami-0516dc2ba9f4fc177",
        "centos8": "ami-0f56d9873066cb6b9",
        "ubuntu1604": "ami-0b3dfe986b324a1bf",
        "ubuntu1804": "ami-009fdaa0002906c5b"
      },
      "us-east-2": {
        "alinux": "ami-00d4efc81188687a0",
        "alinux2": "ami-0075df3faa5b6e07e",
        "centos7": "ami-07d1461ceceb4df43",
        "centos8": "ami-073e63c94c971cc69",
        "ubuntu1604": "ami-04fd4dda7bb2fcaff",
        "ubuntu1804": "ami-0ec51c20170525d3f"
      },
      "us-gov-east-1": {
        "alinux": "ami-01d57910cd71ea0c4",
        "alinux2": "ami-057f7c2d5a1ca7b7d",
        "centos7": "UNSUPPORTED",
        "centos8": "UNSUPPORTED",
        "ubuntu1604": "ami-00150b953797bdaa4",
        "ubuntu1804": "ami-04a13dedb7a0a1cfa"
      },
      "us-gov-west-1": {
        "alinux": "ami-0cfc4f4eb94c9f403",
        "alinux2": "ami-01222b796bafd609f",
        "centos7": "UNSUPPORTED",
        "centos8": "UNSUPPORTED",
        "ubuntu1604": "ami-06bfdc6f4185351c5",
        "ubuntu1804": "ami-0be2fc1895e4b4d9f"
      },
      "us-west-1": {
        "alinux": "ami-0c8decb747bfca25f",
        "alinux2": "ami-01c4b0b6d5597b80b",
        "centos7": "ami-0a426e145ced105df",
        "centos8": "ami-0f3085000b53339e0",
        "ubuntu1604": "ami-00fbdde9fb06d3b09",
        "ubuntu1804": "ami-04ac69ccbff147270"
      },
      "us-west-2": {
        "alinux": "ami-018ccd7660ecade5e",
        "alinux2": "ami-079facc5ab3fdf701",
        "centos7": "ami-0e92bdb4aee551791",
        "centos8": "ami-029dc099ae4e121f1",
        "ubuntu1604": "ami-008383c0ab2a2d425",
        "ubuntu1804": "ami-01a7264e2e3bf272f"
      }
    },
    "OSFeatures": {
      "centos7": {
        "User": "centos",
        "RootDevice": "/dev/sda1"
      },
      "centos8": {
        "User": "centos",
        "RootDevice": "/dev/sda1"
      },
      "alinux": {
        "User": "ec2-user",
        "RootDevice": "/dev/xvda"
      },
      "alinux2": {
        "User": "ec2-user",
        "RootDevice": "/dev/xvda"
      },
      "ubuntu1604": {
        "User": "ubuntu",
        "RootDevice": "/dev/sda1"
      },
      "ubuntu1804": {
        "User": "ubuntu",
        "RootDevice": "/dev/sda1"
      }
    },
    "PackagesVersions": {
      "default": {
        "parallelcluster": "2.10.1",
        "cookbook": "aws-parallelcluster-cookbook-2.10.1",
        "chef": "15.11.8",
        "berkshelf": "7.0.10",
        "ami": "dev"
      }
    },
    "Partition2Url": {
      "aws": {
        "url": "amazonaws.com"
      },
      "aws-us-gov": {
        "url": "amazonaws.com"
      },
      "aws-cn": {
        "url": "amazonaws.com.cn"
      }
    }
  },
  "Resources": {
    "EFSSubstack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "Parameters": {
          "EFSOptions": {
            "Ref": "EFSOptions"
          },
          "ComputeSecurityGroup": {
            "Fn::If": [
              "CreateSecurityGroups",
              {
                "Ref": "ComputeSecurityGroup"
              },
              {
                "Ref": "VPCSecurityGroupId"
              }
            ]
          },
          "MasterSubnetId": {
            "Ref": "MasterSubnetId"
          },
          "ComputeSubnetId": {
            "Ref": "ComputeSubnetId"
          }
        },
        "TemplateURL": {
          "Fn::Sub": [
            "https://${AWS::Region}-aws-parallelcluster.s3.${AWS::Region}.${s3_url}/templates/efs-substack-${version}.cfn.json",
            {
              "s3_url": {
                "Fn::FindInMap": [
                  "Partition2Url",
                  {
                    "Ref": "AWS::Partition"
                  },
                  "url"
                ]
              },
              "version": {
                "Fn::FindInMap": [
                  "PackagesVersions",
                  "default",
                  "parallelcluster"
                ]
              }
            }
          ]
        }
      },
      "Condition": "CreateEFSSubstack"
    },
    "CloudWatchLogsSubstack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "Parameters": {
          "CWLogOptions": {
            "Ref": "CWLogOptions"
          },
          "CWLogGroupName": {
            "Fn::Sub": [
              "/aws/parallelcluster/${cluster_name}",
              {
                "cluster_name": {
                  "Fn::Select": [
                    "1",
                    {
                      "Fn::Split": [
                        "parallelcluster-",
                        {
                          "Ref": "AWS::StackName"
                        }
                      ]
                    }
                  ]
                }
              }
            ]
          },
          "MainStackName": {
            "Ref": "AWS::StackName"
          },
          "MainStackUniqueId": {
            "Fn::Select": [
              "2",
              {
                "Fn::Split": [
                  "/",
                  {
                    "Ref": "AWS::StackId"
                  }
                ]
              }
            ]
          },
          "CreateHITSubstack": {
            "Fn::If": [
              "CreateHITSubstack",
              "true",
              "false"
            ]
          },
          "CreateAWSBatchLogGroups": {
            "Fn::If": [
              "CreateAWSBatchStack",
              "true",
              "false"
            ]
          }
        },
        "TemplateURL": {
          "Fn::Sub": [
            "https://${AWS::Region}-aws-parallelcluster.s3.${AWS::Region}.${s3_url}/templates/cw-logs-substack-${version}.cfn.json",
            {
              "s3_url": {
                "Fn::FindInMap": [
                  "Partition2Url",
                  {
                    "Ref": "AWS::Partition"
                  },
                  "url"
                ]
              },
              "version": {
                "Fn::FindInMap": [
                  "PackagesVersions",
                  "default",
                  "parallelcluster"
                ]
              }
            }
          ]
        }
      }
    },
    "SQS": {
      "Type": "AWS::SQS::Queue",
      "Properties": {
        "MessageRetentionPeriod": 1209600,
        "QueueName": {
          "Ref": "AWS::StackName"
        }
      },
      "Condition": "CreateComputeFleet"
    },
    "FSXSubstack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "Parameters": {
          "FSXOptions": {
            "Ref": "FSXOptions"
          },
          "ComputeSecurityGroup": {
            "Fn::If": [
              "CreateSecurityGroups",
              {
                "Ref": "ComputeSecurityGroup"
              },
              {
                "Ref": "VPCSecurityGroupId"
              }
            ]
          },
          "ComputeSecurityGroupIngress": {
            "Fn::If": [
              "CreateSecurityGroups",
              {
                "Ref": "ComputeSecurityGroupIngress"
              },
              {
                "Ref": "VPCSecurityGroupId"
              }
            ]
          },
          "SubnetId": {
            "Ref": "MasterSubnetId"
          }
        },
        "TemplateURL": {
          "Fn::Sub": [
            "https://${AWS::Region}-aws-parallelcluster.s3.${AWS::Region}.${s3_url}/templates/fsx-substack-${version}.cfn.json",
            {
              "s3_url": {
                "Fn::FindInMap": [
                  "Partition2Url",
                  {
                    "Ref": "AWS::Partition"
                  },
                  "url"
                ]
              },
              "version": {
                "Fn::FindInMap": [
                  "PackagesVersions",
                  "default",
                  "parallelcluster"
                ]
              }
            }
          ]
        }
      },
      "Condition": "CreateFSXSubstack"
    },
    "SQSPolicy": {
      "Type": "AWS::SQS::QueuePolicy",
      "Properties": {
        "PolicyDocument": {
          "Id": "MyQueuePolicy",
          "Statement": [
            {
              "Sid": "Allow-SendMessage-From-AS-SNS-Topic",
              "Effect": "Allow",
              "Principal": {
                "AWS": "*"
              },
              "Action": [
                "sqs:SendMessage"
              ],
              "Resource": "*",
              "Condition": {
                "ArnEquals": {
                  "aws:SourceArn": {
                    "Ref": "SNS"
                  }
                }
              }
            }
          ]
        },
        "Queues": [
          {
            "Ref": "SQS"
          }
        ]
      },
      "Condition": "CreateComputeFleet"
    },
    "SNS": {
      "Type": "AWS::SNS::Topic",
      "Condition": "CreateComputeFleet"
    },
    "SNSSubscription": {
      "Type": "AWS::SNS::Subscription",
      "Properties": {
        "Endpoint": {
          "Fn::GetAtt": [
            "SQS",
            "Arn"
          ]
        },
        "Protocol": "sqs",
        "TopicArn": {
          "Ref": "SNS"
        }
      },
      "Condition": "CreateComputeFleet"
    },
    "DynamoDBTable": {
      "Type": "AWS::DynamoDB::Table",
      "UpdateReplacePolicy": "Retain",
      "DeletionPolicy": "Delete",
      "Properties": {
        "TableName": {
          "Ref": "AWS::StackName"
        },
        "AttributeDefinitions": [
          {
            "AttributeName": "instanceId",
            "AttributeType": "S"
          }
        ],
        "KeySchema": [
          {
            "AttributeName": "instanceId",
            "KeyType": "HASH"
          }
        ],
        "BillingMode": "PAY_PER_REQUEST"
      },
      "Condition": "CreateComputeFleet"
    },
    "RootRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": {
          "Fn::If": [
            "UseEC2IAMPolicies",
            {
              "Ref": "EC2IAMPolicies"
            },
            {
              "Ref": "AWS::NoValue"
            }
          ]
        },
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  {
                    "Fn::Sub": [
                      "ec2.${s3_url}",
                      {
                        "s3_url": {
                          "Fn::FindInMap": [
                            "Partition2Url",
                            {
                              "Ref": "AWS::Partition"
                            },
                            "url"
                          ]
                        }
                      }
                    ]
                  }
                ]
              },
              "Action": [
                "sts:AssumeRole"
              ]
            }
          ]
        },
        "Path": "/"
      },
      "Condition": "CreateEC2IAMRole"
    },
    "RootInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Fn::If": [
              "UseEC2IAMRole",
              {
                "Ref": "EC2IAMRoleName"
              },
              {
                "Ref": "RootRole"
              }
            ]
          }
        ]
      }
    },
    "ParallelClusterPolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyName": "parallelcluster",
        "PolicyDocument": {
          "Statement": [
            {
              "Sid": "EC2",
              "Action": [
                "ec2:DescribeVolumes",
                "ec2:AttachVolume",
                "ec2:DescribeInstanceAttribute",
                "ec2:DescribeInstanceStatus",
                "ec2:DescribeInstances",
                "ec2:DescribeInstanceTypes"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Sid": "DynamoDBList",
              "Action": [
                "dynamodb:ListTables"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Sid": "SQSQueue",
              "Action": [
                "sqs:SendMessage",
                "sqs:ReceiveMessage",
                "sqs:ChangeMessageVisibility",
                "sqs:DeleteMessage",
                "sqs:GetQueueUrl"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:${AWS::Partition}:sqs:${AWS::Region}:${AWS::AccountId}:${AWS::StackName}"
                }
              ]
            },
            {
              "Sid": "Autoscaling",
              "Action": [
                "autoscaling:DescribeAutoScalingGroups",
                "autoscaling:TerminateInstanceInAutoScalingGroup",
                "autoscaling:SetDesiredCapacity",
                "autoscaling:UpdateAutoScalingGroup",
                "autoscaling:DescribeTags",
                "autoscaling:SetInstanceHealth"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Sid": "Cloudformation",
              "Action": [
                "cloudformation:DescribeStacks",
                "cloudformation:DescribeStackResource",
                "cloudformation:SignalResource"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:${AWS::Partition}:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/parallelcluster-*/*"
                }
              ]
            },
            {
              "Sid": "DynamoDBTable",
              "Action": [
                "dynamodb:PutItem",
                "dynamodb:BatchWriteItem",
                "dynamodb:GetItem",
                "dynamodb:DeleteItem",
                "dynamodb:DescribeTable"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${AWS::StackName}"
                }
              ]
            },
            {
              "Sid": "S3GetObj",
              "Action": [
                "s3:GetObject"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:${AWS::Partition}:s3:::${AWS::Region}-aws-parallelcluster/*"
                }
              ]
            },
            {
              "Sid": "S3PutObj",
              "Action": [
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:${AWS::Partition}:s3:::${ResourcesS3Bucket}/${ArtifactS3RootDirectory}/batch/*"
                }
              ]
            },
            {
              "Sid": "SQSList",
              "Action": [
                "sqs:ListQueues"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Sid": "FSx",
              "Action": [
                "fsx:DescribeFileSystems"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Sid": "BatchJobPassRole",
              "Action": [
                "iam:PassRole"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:${AWS::Partition}:iam::${AWS::AccountId}:role/parallelcluster-*"
                }
              ]
            },
            {
              "Sid": "DcvLicense",
              "Effect": "Allow",
              "Action": "s3:GetObject",
              "Resource": [
                {
                  "Fn::Sub": "arn:${AWS::Partition}:s3:::dcv-license.${AWS::Region}/*"
                }
              ]
            }
          ]
        },
        "Roles": [
          {
            "Ref": "RootRole"
          }
        ]
      },
      "Condition": "CreateEC2IAMRole"
    },
    "ParallelClusterHITPolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyName": "parallelcluster-hit",
        "PolicyDocument": {
          "Statement": [
            {
              "Sid": "EC2Terminate",
              "Effect": "Allow",
              "Action": [
                "ec2:TerminateInstances"
              ],
              "Resource": "*",
              "Condition": {
                "StringEquals": {
                  "ec2:ResourceTag/Application": {
                    "Ref": "AWS::StackName"
                  }
                }
              }
            },
            {
              "Sid": "EC2",
              "Effect": "Allow",
              "Action": [
                "ec2:DescribeInstances",
                "ec2:DescribeLaunchTemplates",
                "ec2:RunInstances",
                "ec2:DescribeInstanceStatus",
                "ec2:CreateTags"
              ],
              "Resource": "*"
            },
            {
              "Sid": "ResourcesS3Bucket",
              "Effect": "Allow",
              "Action": {
                "Fn::If": [
                  "UseProvidedResourcesS3Bucket",
                  [
                    "s3:ListBucket",
                    "s3:ListBucketVersions",
                    "s3:GetObject*",
                    "s3:PutObject*"
                  ],
                  "s3:*"
                ]
              },
              "Resource": [
                {
                  "Fn::Sub": "arn:${AWS::Partition}:s3:::${ResourcesS3Bucket}"
                },
                {
                  "Fn::Sub": "arn:${AWS::Partition}:s3:::${ResourcesS3Bucket}/${ArtifactS3RootDirectory}/*"
                }
              ]
            },
            {
              "Sid": "DynamoDBTableQuery",
              "Action": [
                "dynamodb:Query"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${AWS::StackName}"
                },
                {
                  "Fn::Sub": "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${AWS::StackName}/index/*"
                }
              ]
            }
          ]
        },
        "Roles": [
          {
            "Ref": "RootRole"
          }
        ]
      },
      "Condition": "AddHITIamPolicies"
    },
    "S3ReadRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyName": "S3Read",
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "S3Read",
              "Effect": "Allow",
              "Action": [
                "s3:Get*",
                "s3:List*"
              ],
              "Resource": [
                {
                  "Ref": "S3ReadResource"
                }
              ]
            }
          ]
        },
        "Roles": [
          {
            "Ref": "RootRole"
          }
        ]
      },
      "Condition": "UseS3ReadPolicy"
    },
    "S3ReadWriteRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyName": "S3ReadWrite",
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "S3ReadWrite",
              "Effect": "Allow",
              "Action": [
                "s3:*"
              ],
              "Resource": [
                {
                  "Ref": "S3ReadWriteResource"
                }
              ]
            }
          ]
        },
        "Roles": [
          {
            "Ref": "RootRole"
          }
        ]
      },
      "Condition": "UseS3ReadWritePolicy"
    },
    "MasterEIP": {
      "Type": "AWS::EC2::EIP",
      "Properties": {
        "Domain": "vpc"
      },
      "Condition": "MasterPublicIp"
    },
    "ComputeSubnet": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {
          "Ref": "VPCId"
        },
        "CidrBlock": {
          "Ref": "ComputeSubnetCidr"
        },
        "Tags": [
          {
            "Key": "Network",
            "Value": "ComputeSubnet"
          }
        ],
        "AvailabilityZone": {
          "Ref": "AvailabilityZone"
        }
      },
      "Condition": "CreateComputeSubnetForCompute"
    },
    "ComputeRouteTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {
          "Ref": "VPCId"
        },
        "Tags": [
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "Network",
            "Value": "ComputeSubnet"
          }
        ]
      },
      "Condition": "CreateComputeSubnetForCompute"
    },
    "ComputeRoute": {
      "Type": "AWS::EC2::Route",
      "Properties": {
        "RouteTableId": {
          "Ref": "ComputeRouteTable"
        },
        "DestinationCidrBlock": "0.0.0.0/0",
        "NetworkInterfaceId": {
          "Ref": "MasterENI"
        }
      },
      "Condition": "CreateComputeSubnetForCompute"
    },
    "ComputeSubnetRouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": {
          "Ref": "ComputeSubnet"
        },
        "RouteTableId": {
          "Ref": "ComputeRouteTable"
        }
      },
      "Condition": "CreateComputeSubnetForCompute"
    },
    "MasterSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Enable access to the head node",
        "VpcId": {
          "Ref": "VPCId"
        },
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 22,
            "ToPort": 22,
            "CidrIp": {
              "Ref": "AccessFrom"
            }
          },
          {
            "Fn::If": [
              "EnableDCV",
              {
                "IpProtocol": "tcp",
                "FromPort": {
                  "Fn::Select": [
                    "1",
                    {
                      "Fn::Split": [
                        ",",
                        {
                          "Ref": "DCVOptions"
                        }
                      ]
                    }
                  ]
                },
                "ToPort": {
                  "Fn::Select": [
                    "1",
                    {
                      "Fn::Split": [
                        ",",
                        {
                          "Ref": "DCVOptions"
                        }
                      ]
                    }
                  ]
                },
                "CidrIp": {
                  "Fn::Select": [
                    "2",
                    {
                      "Fn::Split": [
                        ",",
                        {
                          "Ref": "DCVOptions"
                        }
                      ]
                    }
                  ]
                }
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          }
        ]
      },
      "Condition": "CreateSecurityGroups"
    },
    "MasterSecurityGroupIngress": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "IpProtocol": "-1",
        "FromPort": 0,
        "ToPort": 65535,
        "SourceSecurityGroupId": {
          "Ref": "ComputeSecurityGroup"
        },
        "GroupId": {
          "Ref": "MasterSecurityGroup"
        }
      },
      "Condition": "CreateSecurityGroups"
    },
    "ComputeSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Allow access to resources in subnets behind front",
        "VpcId": {
          "Ref": "VPCId"
        },
        "SecurityGroupIngress": [
          {
            "SourceSecurityGroupId": {
              "Ref": "MasterSecurityGroup"
            },
            "IpProtocol": "-1",
            "FromPort": 0,
            "ToPort": 65535
          }
        ]
      },
      "Condition": "CreateSecurityGroups"
    },
    "ComputeSecurityGroupEgress": {
      "Type": "AWS::EC2::SecurityGroupEgress",
      "Properties": {
        "IpProtocol": "-1",
        "FromPort": 0,
        "ToPort": 65535,
        "DestinationSecurityGroupId": {
          "Ref": "ComputeSecurityGroup"
        },
        "GroupId": {
          "Ref": "ComputeSecurityGroup"
        }
      },
      "Condition": "CreateSecurityGroups"
    },
    "ComputeSecurityGroupNormalEgress": {
      "Type": "AWS::EC2::SecurityGroupEgress",
      "Properties": {
        "IpProtocol": "-1",
        "FromPort": 0,
        "ToPort": 65535,
        "CidrIp": "0.0.0.0/0",
        "GroupId": {
          "Ref": "ComputeSecurityGroup"
        }
      },
      "DependsOn": "ComputeSecurityGroupEgress",
      "Condition": "CreateSecurityGroups"
    },
    "ComputeSecurityGroupIngress": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "IpProtocol": "-1",
        "FromPort": 0,
        "ToPort": 65535,
        "SourceSecurityGroupId": {
          "Ref": "ComputeSecurityGroup"
        },
        "GroupId": {
          "Ref": "ComputeSecurityGroup"
        }
      },
      "Condition": "CreateSecurityGroups"
    },
    "MasterENI": {
      "Type": "AWS::EC2::NetworkInterface",
      "Properties": {
        "Description": "AWS ParallelCluster head node interface",
        "SubnetId": {
          "Ref": "MasterSubnetId"
        },
        "SourceDestCheck": false,
        "GroupSet": [
          {
            "Fn::If": [
              "CreateSecurityGroups",
              {
                "Ref": "MasterSecurityGroup"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          },
          {
            "Fn::If": [
              "AddAdditionalSG",
              {
                "Ref": "AdditionalSG"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          },
          {
            "Fn::If": [
              "UseExistingSecurityGroup",
              {
                "Ref": "VPCSecurityGroupId"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          }
        ]
      }
    },
    "AdditionalCfnStack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": {
          "Ref": "AdditionalCfnTemplate"
        }
      },
      "Condition": "CreateSubStack"
    },
    "AWSBatchStack": {
      "Type": "AWS::CloudFormation::Stack",
      "DependsOn": [
        "CleanupResourcesS3BucketCustomResource",
        "CloudWatchLogsSubstack"
      ],
      "Properties": {
        "Parameters": {
          "AttributeTags": {
            "Fn::Sub": [
              "${BaseOS}, ${Scheduler}, ${version}, ${Architecture}",
              {
                "version": {
                  "Fn::FindInMap": [
                    "PackagesVersions",
                    "default",
                    "parallelcluster"
                  ]
                }
              }
            ]
          },
          "S3Url": {
            "Fn::FindInMap": [
              "Partition2Url",
              {
                "Ref": "AWS::Partition"
              },
              "url"
            ]
          },
          "FileSystemTags": {
            "Fn::Sub": [
              "efs=${efs}, multiebs=${NumberOfEBSVol}, raid=${raid}",
              {
                "efs": {
                  "Fn::If": [
                    "CreateEFSSubstack",
                    "1",
                    "0"
                  ]
                },
                "raid": {
                  "Fn::If": [
                    "CreateRAIDSubstack",
                    "1",
                    "0"
                  ]
                }
              }
            ]
          },
          "EFSSharedDir": {
            "Fn::Select": [
              "0",
              {
                "Fn::Split": [
                  ",",
                  {
                    "Ref": "EFSOptions"
                  }
                ]
              }
            ]
          },
          "EFSFSId": {
            "Fn::If": [
              "CreateEFSSubstack",
              {
                "Fn::GetAtt": [
                  "EFSSubstack",
                  "Outputs.FileSystemId"
                ]
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          },
          "MinvCpus": {
            "Ref": "MinSize"
          },
          "DesiredvCpus": {
            "Ref": "DesiredSize"
          },
          "MaxvCpus": {
            "Ref": "MaxSize"
          },
          "InstanceTypes": {
            "Ref": "ComputeInstanceType"
          },
          "Subnet": {
            "Fn::If": [
              "UseMasterSubnetForCompute",
              {
                "Ref": "MasterSubnetId"
              },
              {
                "Fn::If": [
                  "CreateComputeSubnetForCompute",
                  {
                    "Ref": "ComputeSubnet"
                  },
                  {
                    "Ref": "ComputeSubnetId"
                  }
                ]
              }
            ]
          },
          "SecurityGroups": {
            "Fn::Join": [
              ",",
              [
                {
                  "Fn::If": [
                    "CreateSecurityGroups",
                    {
                      "Ref": "ComputeSecurityGroup"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                },
                {
                  "Fn::If": [
                    "AddAdditionalSG",
                    {
                      "Ref": "AdditionalSG"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                },
                {
                  "Fn::If": [
                    "UseExistingSecurityGroup",
                    {
                      "Ref": "VPCSecurityGroupId"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                }
              ]
            ]
          },
          "OS": {
            "Ref": "BaseOS"
          },
          "ClusterName": {
            "Ref": "AWS::StackName"
          },
          "ClusterType": {
            "Ref": "ClusterType"
          },
          "KeyName": {
            "Ref": "KeyName"
          },
          "SpotBidPercentage": {
            "Fn::If": [
              "UseSpotPrice",
              {
                "Ref": "SpotPrice"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          },
          "ResourcesS3Bucket": {
            "Ref": "ResourcesS3Bucket"
          },
          "ArtifactS3RootDirectory": {
            "Ref": "ArtifactS3RootDirectory"
          },
          "SharedDir": {
            "Ref": "SharedDir"
          },
          "RAIDSharedDir": {
            "Fn::Select": [
              "0",
              {
                "Fn::Split": [
                  ",",
                  {
                    "Ref": "RAIDOptions"
                  }
                ]
              }
            ]
          },
          "MainStackUniqueId": {
            "Fn::Select": [
              "2",
              {
                "Fn::Split": [
                  "/",
                  {
                    "Ref": "AWS::StackId"
                  }
                ]
              }
            ]
          },
          "Architecture": {
            "Ref": "Architecture"
          },
          "MasterPrivateIP": {
            "Fn::GetAtt": [
              "MasterServerSubstack",
              "Outputs.MasterPrivateIP"
            ]
          },
          "IAMLambdaRoleName": {
            "Ref": "IAMLambdaRoleName"
          }
        },
        "TemplateURL": {
          "Fn::Sub": [
            "https://${AWS::Region}-aws-parallelcluster.s3.${AWS::Region}.${s3_url}/templates/batch-substack-${version}.cfn.json",
            {
              "s3_url": {
                "Fn::FindInMap": [
                  "Partition2Url",
                  {
                    "Ref": "AWS::Partition"
                  },
                  "url"
                ]
              },
              "version": {
                "Fn::FindInMap": [
                  "PackagesVersions",
                  "default",
                  "parallelcluster"
                ]
              }
            }
          ]
        }
      },
      "Condition": "CreateAWSBatchStack"
    },
    "AssociateEIP": {
      "Type": "AWS::EC2::EIPAssociation",
      "Properties": {
        "AllocationId": {
          "Fn::GetAtt": [
            "MasterEIP",
            "AllocationId"
          ]
        },
        "NetworkInterfaceId": {
          "Ref": "MasterENI"
        }
      },
      "Condition": "MasterPublicIp"
    },
    "DynamicPlacementGroup": {
      "Type": "AWS::EC2::PlacementGroup",
      "Properties": {
        "Strategy": "cluster"
      },
      "Condition": "CreatePlacementGroup"
    },
    "CleanupResourcesFunctionExecutionRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [
                "sts:AssumeRole"
              ],
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "lambda.amazonaws.com"
                ]
              }
            }
          ],
          "Version": "2012-10-17"
        },
        "Path": "/",
        "Policies": [
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": [
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Effect": "Allow",
                  "Resource": {
                    "Fn::Sub": "arn:${AWS::Partition}:logs:*:*:*"
                  },
                  "Sid": "CloudWatchLogsPolicy"
                },
                {
                  "Action": {
                    "Fn::If": [
                      "UseProvidedResourcesS3Bucket",
                      [
                        "s3:DeleteObject",
                        "s3:DeleteObjectVersion",
                        "s3:ListBucket",
                        "s3:ListBucketVersions"
                      ],
                      [
                        "s3:DeleteBucket",
                        "s3:DeleteObject",
                        "s3:DeleteObjectVersion",
                        "s3:ListBucket",
                        "s3:ListBucketVersions"
                      ]
                    ]
                  },
                  "Effect": "Allow",
                  "Resource": [
                    {
                      "Fn::Sub": "arn:${AWS::Partition}:s3:::${ResourcesS3Bucket}"
                    },
                    {
                      "Fn::Sub": "arn:${AWS::Partition}:s3:::${ResourcesS3Bucket}/${ArtifactS3RootDirectory}/*"
                    }
                  ],
                  "Sid": "S3BucketPolicy"
                },
                {
                  "Fn::If": [
                    "CreateHITSubstack",
                    {
                      "Sid": "DescribeInstances",
                      "Effect": "Allow",
                      "Action": [
                        "ec2:DescribeInstances"
                      ],
                      "Resource": "*"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                },
                {
                  "Fn::If": [
                    "CreateHITSubstack",
                    {
                      "Sid": "FleetTerminatePolicy",
                      "Effect": "Allow",
                      "Action": [
                        "ec2:TerminateInstances"
                      ],
                      "Resource": "*",
                      "Condition": {
                        "StringEquals": {
                          "ec2:ResourceTag/Application": {
                            "Ref": "AWS::StackName"
                          }
                        }
                      }
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                }
              ],
              "Version": "2012-10-17"
            },
            "PolicyName": "LambdaPolicy"
          }
        ]
      },
      "Condition": "CreateIAMLambdaRole"
    },
    "CleanupResourcesS3BucketCustomResource": {
      "Type": "AWS::CloudFormation::CustomResource",
      "Properties": {
        "ResourcesS3Bucket": {
          "Ref": "ResourcesS3Bucket"
        },
        "ArtifactS3RootDirectory": {
          "Ref": "ArtifactS3RootDirectory"
        },
        "RemoveBucketOnDeletion": {
          "Ref": "RemoveBucketOnDeletion"
        },
        "Action": "DELETE_S3_ARTIFACTS",
        "ServiceToken": {
          "Fn::GetAtt": [
            "CleanupResourcesFunction",
            "Arn"
          ]
        }
      }
    },
    "TerminateComputeFleetCustomResource": {
      "Type": "AWS::CloudFormation::CustomResource",
      "Properties": {
        "StackName": {
          "Ref": "AWS::StackName"
        },
        "Action": "TERMINATE_EC2_INSTANCES",
        "ServiceToken": {
          "Fn::GetAtt": [
            "CleanupResourcesFunction",
            "Arn"
          ]
        }
      },
      "DependsOn": [
        "CloudWatchLogsSubstack",
        "ComputeFleetHITSubstack"
      ],
      "Condition": "CreateHITSubstack"
    },
    "CleanupResourcesFunction": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "FunctionName": {
          "Fn::Sub": [
            "pcluster-CleanupResources-${StackId}",
            {
              "StackId": {
                "Fn::Select": [
                  "2",
                  {
                    "Fn::Split": [
                      "/",
                      {
                        "Ref": "AWS::StackId"
                      }
                    ]
                  }
                ]
              }
            }
          ]
        },
        "Code": {
          "S3Bucket": {
            "Ref": "ResourcesS3Bucket"
          },
          "S3Key": {
            "Fn::Sub": "${ArtifactS3RootDirectory}/custom_resources_code/artifacts.zip"
          }
        },
        "Handler": "cleanup_resources.handler",
        "MemorySize": 128,
        "Role": {
          "Fn::If": [
            "CreateIAMLambdaRole",
            {
              "Fn::GetAtt": [
                "CleanupResourcesFunctionExecutionRole",
                "Arn"
              ]
            },
            {
              "Fn::Sub": "arn:${AWS::Partition}:iam::${AWS::AccountId}:role/${IAMLambdaRoleName}"
            }
          ]
        },
        "Runtime": "python3.8",
        "Timeout": 900
      }
    },
    "RAIDSubstack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "Parameters": {
          "RAIDOptions": {
            "Ref": "RAIDOptions"
          },
          "AvailabilityZone": {
            "Ref": "AvailabilityZone"
          }
        },
        "TemplateURL": {
          "Fn::Sub": [
            "https://${AWS::Region}-aws-parallelcluster.s3.${AWS::Region}.${s3_url}/templates/raid-substack-${version}.cfn.json",
            {
              "s3_url": {
                "Fn::FindInMap": [
                  "Partition2Url",
                  {
                    "Ref": "AWS::Partition"
                  },
                  "url"
                ]
              },
              "version": {
                "Fn::FindInMap": [
                  "PackagesVersions",
                  "default",
                  "parallelcluster"
                ]
              }
            }
          ]
        }
      },
      "Condition": "CreateRAIDSubstack"
    },
    "EBSCfnStack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "Parameters": {
          "AvailabilityZone": {
            "Ref": "AvailabilityZone"
          },
          "VolumeSize": {
            "Ref": "VolumeSize"
          },
          "VolumeType": {
            "Ref": "VolumeType"
          },
          "VolumeIOPS": {
            "Ref": "VolumeIOPS"
          },
          "VolumeThroughput": {
            "Ref": "VolumeThroughput"
          },
          "EBSEncryption": {
            "Ref": "EBSEncryption"
          },
          "EBSKMSKeyId": {
            "Ref": "EBSKMSKeyId"
          },
          "EBSVolumeId": {
            "Ref": "EBSVolumeId"
          },
          "EBSSnapshotId": {
            "Ref": "EBSSnapshotId"
          },
          "NumberOfEBSVol": {
            "Ref": "NumberOfEBSVol"
          }
        },
        "TemplateURL": {
          "Fn::Sub": [
            "https://${AWS::Region}-aws-parallelcluster.s3.${AWS::Region}.${s3_url}/templates/ebs-substack-${version}.cfn.json",
            {
              "s3_url": {
                "Fn::FindInMap": [
                  "Partition2Url",
                  {
                    "Ref": "AWS::Partition"
                  },
                  "url"
                ]
              },
              "version": {
                "Fn::FindInMap": [
                  "PackagesVersions",
                  "default",
                  "parallelcluster"
                ]
              }
            }
          ]
        }
      }
    },
    "MasterServerSubstack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "Parameters": {
          "MasterInstanceType": {
            "Ref": "MasterInstanceType"
          },
          "MasterSecurityGroups": {
            "Fn::Join": [
              ",",
              [
                {
                  "Fn::If": [
                    "CreateSecurityGroups",
                    {
                      "Ref": "MasterSecurityGroup"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                },
                {
                  "Fn::If": [
                    "AddAdditionalSG",
                    {
                      "Ref": "AdditionalSG"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                },
                {
                  "Fn::If": [
                    "UseExistingSecurityGroup",
                    {
                      "Ref": "VPCSecurityGroupId"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                }
              ]
            ]
          },
          "ComputeInstanceType": {
            "Ref": "ComputeInstanceType"
          },
          "MasterSubnetId": {
            "Ref": "MasterSubnetId"
          },
          "MasterCoreCount": {
            "Fn::Join": [
              ",",
              [
                {
                  "Fn::Select": [
                    "0",
                    {
                      "Ref": "Cores"
                    }
                  ]
                },
                {
                  "Fn::Select": [
                    "2",
                    {
                      "Ref": "Cores"
                    }
                  ]
                }
              ]
            ]
          },
          "ComputeCoreCount": {
            "Fn::Select": [
              "1",
              {
                "Ref": "Cores"
              }
            ]
          },
          "RootDevice": {
            "Fn::FindInMap": [
              "OSFeatures",
              {
                "Ref": "BaseOS"
              },
              "RootDevice"
            ]
          },
          "RootVolumeSize": {
            "Ref": "MasterRootVolumeSize"
          },
          "KeyName": {
            "Ref": "KeyName"
          },
          "MainStackName": {
            "Ref": "AWS::StackName"
          },
          "AttributesTagValue": {
            "Fn::Sub": [
              "${BaseOS}, ${Scheduler}, ${version}, ${Architecture}",
              {
                "version": {
                  "Fn::FindInMap": [
                    "PackagesVersions",
                    "default",
                    "parallelcluster"
                  ]
                }
              }
            ]
          },
          "NetworkingTagValue": {
            "Fn::Sub": "EFA=${EFA}"
          },
          "FilesystemTagValue": {
            "Fn::Sub": [
              "efs=${efs}, multiebs=${NumberOfEBSVol}, raid=${raid}, fsx=${fsx}",
              {
                "efs": {
                  "Fn::If": [
                    "CreateEFSSubstack",
                    "1",
                    "0"
                  ]
                },
                "raid": {
                  "Fn::If": [
                    "CreateRAIDSubstack",
                    "1",
                    "0"
                  ]
                },
                "fsx": {
                  "Fn::If": [
                    "CreateFSXSubstack",
                    "1",
                    "0"
                  ]
                }
              }
            ]
          },
          "MasterENI": {
            "Ref": "MasterENI"
          },
          "UseMasterPublicIp": {
            "Fn::If": [
              "MasterPublicIp",
              true,
              false
            ]
          },
          "ImageId": {
            "Fn::If": [
              "UseCustomAMI",
              {
                "Ref": "CustomAMI"
              },
              {
                "Fn::If": [
                  "UseArmAMIs",
                  {
                    "Fn::FindInMap": [
                      "AWSRegionOS2AMIarm64",
                      {
                        "Ref": "AWS::Region"
                      },
                      {
                        "Ref": "BaseOS"
                      }
                    ]
                  },
                  {
                    "Fn::FindInMap": [
                      "AWSRegionOS2AMIx86",
                      {
                        "Ref": "AWS::Region"
                      },
                      {
                        "Ref": "BaseOS"
                      }
                    ]
                  }
                ]
              }
            ]
          },
          "IamInstanceProfile": {
            "Ref": "RootInstanceProfile"
          },
          "IamRoleName": {
            "Fn::If": [
              "UseEC2IAMRole",
              {
                "Ref": "EC2IAMRoleName"
              },
              {
                "Ref": "RootRole"
              }
            ]
          },
          "PlacementGroup": {
            "Fn::If": [
              "UseClusterPlacement",
              {
                "Fn::If": [
                  "CreatePlacementGroup",
                  {
                    "Ref": "DynamicPlacementGroup"
                  },
                  {
                    "Ref": "PlacementGroup"
                  }
                ]
              },
              "NONE"
            ]
          },
          "EFA": {
            "Ref": "EFA"
          },
          "BaseOS": {
            "Ref": "BaseOS"
          },
          "OSUser": {
            "Fn::FindInMap": [
              "OSFeatures",
              {
                "Ref": "BaseOS"
              },
              "User"
            ]
          },
          "PreInstallScript": {
            "Ref": "PreInstallScript"
          },
          "PreInstallArgs": {
            "Ref": "PreInstallArgs"
          },
          "PostInstallScript": {
            "Ref": "PostInstallScript"
          },
          "PostInstallArgs": {
            "Ref": "PostInstallArgs"
          },
          "RAIDVolIds": {
            "Fn::If": [
              "CreateRAIDSubstack",
              {
                "Fn::GetAtt": [
                  "RAIDSubstack",
                  "Outputs.Volumeids"
                ]
              },
              ""
            ]
          },
          "RAIDOptions": {
            "Ref": "RAIDOptions"
          },
          "EFSId": {
            "Fn::If": [
              "CreateEFSSubstack",
              {
                "Fn::GetAtt": [
                  "EFSSubstack",
                  "Outputs.FileSystemId"
                ]
              },
              ""
            ]
          },
          "EFSOptions": {
            "Ref": "EFSOptions"
          },
          "FSXId": {
            "Fn::If": [
              "CreateFSXSubstack",
              {
                "Fn::GetAtt": [
                  "FSXSubstack",
                  "Outputs.FileSystemId"
                ]
              },
              ""
            ]
          },
          "FSXOptions": {
            "Ref": "FSXOptions"
          },
          "EBSVolIds": {
            "Fn::GetAtt": [
              "EBSCfnStack",
              "Outputs.Volumeids"
            ]
          },
          "Scheduler": {
            "Ref": "Scheduler"
          },
          "EncryptedEphemeral": {
            "Ref": "EncryptedEphemeral"
          },
          "EphemeralDir": {
            "Ref": "EphemeralDir"
          },
          "SharedDir": {
            "Ref": "SharedDir"
          },
          "ProxyServer": {
            "Ref": "ProxyServer"
          },
          "ClusterDNSDomain": {
            "Fn::If": [
              "CreateHITSubstack",
              {
                "Fn::GetAtt": [
                  "ComputeFleetHITSubstack",
                  "Outputs.ClusterDNSDomain"
                ]
              },
              ""
            ]
          },
          "ClusterHostedZone": {
            "Fn::If": [
              "CreateHITSubstack",
              {
                "Fn::GetAtt": [
                  "ComputeFleetHITSubstack",
                  "Outputs.ClusterHostedZone"
                ]
              },
              ""
            ]
          },
          "MaxSize": {
            "Ref": "MaxSize"
          },
          "DynamoDBTable": {
            "Ref": "AWS::StackName"
          },
          "SQSQueueName": {
            "Ref": "AWS::StackName"
          },
          "DCVEnabled": {
            "Fn::If": [
              "EnableDCV",
              "master",
              "false"
            ]
          },
          "DCVPort": {
            "Fn::Select": [
              "1",
              {
                "Fn::Split": [
                  ",",
                  {
                    "Ref": "DCVOptions"
                  }
                ]
              }
            ]
          },
          "IntelHPCPlatform": {
            "Ref": "IntelHPCPlatform"
          },
          "CWLoggingEnabled": {
            "Fn::GetAtt": [
              "CloudWatchLogsSubstack",
              "Outputs.Enabled"
            ]
          },
          "ExtraJson": {
            "Ref": "ExtraJson"
          },
          "CustomChefCookbook": {
            "Ref": "CustomChefCookbook"
          },
          "AWSDomain": {
            "Fn::FindInMap": [
              "Partition2Url",
              {
                "Ref": "AWS::Partition"
              },
              "url"
            ]
          },
          "ParallelClusterVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "parallelcluster"
            ]
          },
          "CookbookVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "cookbook"
            ]
          },
          "ChefVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "chef"
            ]
          },
          "BerkshelfVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "berkshelf"
            ]
          },
          "ResourcesS3Bucket": {
            "Ref": "ResourcesS3Bucket"
          },
          "ArtifactS3RootDirectory": {
            "Ref": "ArtifactS3RootDirectory"
          },
          "DependsOnCustomResources": {
            "Fn::If": [
              "CreateHITSubstack",
              {
                "Fn::Sub": [
                  "DependsOn${fleetTermination}And${route53cleanup}",
                  {
                    "fleetTermination": {
                      "Ref": "TerminateComputeFleetCustomResource"
                    },
                    "route53cleanup": {
                      "Fn::GetAtt": [
                        "ComputeFleetHITSubstack",
                        "Outputs.CleanupRoute53CustomResource"
                      ]
                    }
                  }
                ]
              },
              ""
            ]
          },
          "HITConfigVersion": {
            "Fn::If": [
              "CreateHITSubstack",
              {
                "Fn::GetAtt": [
                  "ComputeFleetHITSubstack",
                  "Outputs.ConfigVersion"
                ]
              },
              ""
            ]
          },
          "UpdateWaiterFunctionArn": {
            "Fn::If": [
              "CreateHITSubstack",
              {
                "Fn::GetAtt": [
                  "ComputeFleetHITSubstack",
                  "Outputs.UpdateWaiterFunctionArn"
                ]
              },
              "NONE"
            ]
          },
          "MasterNetworkInterfacesCount": {
            "Fn::Select": [
              "0",
              {
                "Ref": "NetworkInterfacesCount"
              }
            ]
          }
        },
        "TemplateURL": {
          "Fn::Sub": [
            "https://${AWS::Region}-aws-parallelcluster.s3.${AWS::Region}.${s3_url}/templates/master-server-substack-${version}.cfn.yaml",
            {
              "s3_url": {
                "Fn::FindInMap": [
                  "Partition2Url",
                  {
                    "Ref": "AWS::Partition"
                  },
                  "url"
                ]
              },
              "version": {
                "Fn::FindInMap": [
                  "PackagesVersions",
                  "default",
                  "parallelcluster"
                ]
              }
            }
          ]
        }
      }
    },
    "ComputeFleetSubstack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "Parameters": {
          "ComputeInstanceType": {
            "Ref": "ComputeInstanceType"
          },
          "ComputeSubnetId": {
            "Fn::If": [
              "UseMasterSubnetForCompute",
              {
                "Ref": "MasterSubnetId"
              },
              {
                "Fn::If": [
                  "CreateComputeSubnetForCompute",
                  {
                    "Ref": "ComputeSubnet"
                  },
                  {
                    "Ref": "ComputeSubnetId"
                  }
                ]
              }
            ]
          },
          "ComputeCoreCount": {
            "Fn::Join": [
              ",",
              [
                {
                  "Fn::Select": [
                    "1",
                    {
                      "Ref": "Cores"
                    }
                  ]
                },
                {
                  "Fn::Select": [
                    "3",
                    {
                      "Ref": "Cores"
                    }
                  ]
                }
              ]
            ]
          },
          "SNSTopic": {
            "Ref": "SNS"
          },
          "RootDevice": {
            "Fn::FindInMap": [
              "OSFeatures",
              {
                "Ref": "BaseOS"
              },
              "RootDevice"
            ]
          },
          "RootVolumeSize": {
            "Ref": "ComputeRootVolumeSize"
          },
          "KeyName": {
            "Ref": "KeyName"
          },
          "MainStackName": {
            "Ref": "AWS::StackName"
          },
          "AttributesTagValue": {
            "Fn::Sub": [
              "${BaseOS}, ${Scheduler}, ${version}, ${Architecture}",
              {
                "version": {
                  "Fn::FindInMap": [
                    "PackagesVersions",
                    "default",
                    "parallelcluster"
                  ]
                }
              }
            ]
          },
          "NetworkingTagValue": {
            "Fn::Sub": "EFA=${EFA}"
          },
          "FilesystemTagValue": {
            "Fn::Sub": [
              "efs=${efs}, multiebs=${NumberOfEBSVol}, raid=${raid}, fsx=${fsx}",
              {
                "efs": {
                  "Fn::If": [
                    "CreateEFSSubstack",
                    "1",
                    "0"
                  ]
                },
                "raid": {
                  "Fn::If": [
                    "CreateRAIDSubstack",
                    "1",
                    "0"
                  ]
                },
                "fsx": {
                  "Fn::If": [
                    "CreateFSXSubstack",
                    "1",
                    "0"
                  ]
                }
              }
            ]
          },
          "ImageId": {
            "Fn::If": [
              "UseCustomAMI",
              {
                "Ref": "CustomAMI"
              },
              {
                "Fn::If": [
                  "UseArmAMIs",
                  {
                    "Fn::FindInMap": [
                      "AWSRegionOS2AMIarm64",
                      {
                        "Ref": "AWS::Region"
                      },
                      {
                        "Ref": "BaseOS"
                      }
                    ]
                  },
                  {
                    "Fn::FindInMap": [
                      "AWSRegionOS2AMIx86",
                      {
                        "Ref": "AWS::Region"
                      },
                      {
                        "Ref": "BaseOS"
                      }
                    ]
                  }
                ]
              }
            ]
          },
          "IamInstanceProfile": {
            "Ref": "RootInstanceProfile"
          },
          "IamRoleName": {
            "Fn::If": [
              "UseEC2IAMRole",
              {
                "Ref": "EC2IAMRoleName"
              },
              {
                "Ref": "RootRole"
              }
            ]
          },
          "PlacementGroup": {
            "Fn::If": [
              "UsePlacementGroup",
              {
                "Fn::If": [
                  "CreatePlacementGroup",
                  {
                    "Ref": "DynamicPlacementGroup"
                  },
                  {
                    "Ref": "PlacementGroup"
                  }
                ]
              },
              "NONE"
            ]
          },
          "EFA": {
            "Ref": "EFA"
          },
          "EFAGDR": {
            "Ref": "EFAGDR"
          },
          "BaseOS": {
            "Ref": "BaseOS"
          },
          "OSUser": {
            "Fn::FindInMap": [
              "OSFeatures",
              {
                "Ref": "BaseOS"
              },
              "User"
            ]
          },
          "PreInstallScript": {
            "Ref": "PreInstallScript"
          },
          "PreInstallArgs": {
            "Ref": "PreInstallArgs"
          },
          "PostInstallScript": {
            "Ref": "PostInstallScript"
          },
          "PostInstallArgs": {
            "Ref": "PostInstallArgs"
          },
          "RAIDOptions": {
            "Ref": "RAIDOptions"
          },
          "EFSId": {
            "Fn::If": [
              "CreateEFSSubstack",
              {
                "Fn::GetAtt": [
                  "EFSSubstack",
                  "Outputs.FileSystemId"
                ]
              },
              ""
            ]
          },
          "EFSOptions": {
            "Ref": "EFSOptions"
          },
          "FSXId": {
            "Fn::If": [
              "CreateFSXSubstack",
              {
                "Fn::GetAtt": [
                  "FSXSubstack",
                  "Outputs.FileSystemId"
                ]
              },
              ""
            ]
          },
          "FSXOptions": {
            "Ref": "FSXOptions"
          },
          "Scheduler": {
            "Ref": "Scheduler"
          },
          "EncryptedEphemeral": {
            "Ref": "EncryptedEphemeral"
          },
          "EphemeralDir": {
            "Ref": "EphemeralDir"
          },
          "SharedDir": {
            "Ref": "SharedDir"
          },
          "ProxyServer": {
            "Ref": "ProxyServer"
          },
          "MaxSize": {
            "Ref": "MaxSize"
          },
          "MinSize": {
            "Ref": "MinSize"
          },
          "DesiredSize": {
            "Ref": "DesiredSize"
          },
          "SQSQueue": {
            "Ref": "SQS"
          },
          "IntelHPCPlatform": {
            "Ref": "IntelHPCPlatform"
          },
          "CWLoggingEnabled": {
            "Fn::GetAtt": [
              "CloudWatchLogsSubstack",
              "Outputs.Enabled"
            ]
          },
          "ExtraJson": {
            "Ref": "ExtraJson"
          },
          "CustomChefCookbook": {
            "Ref": "CustomChefCookbook"
          },
          "AWSDomain": {
            "Fn::FindInMap": [
              "Partition2Url",
              {
                "Ref": "AWS::Partition"
              },
              "url"
            ]
          },
          "ParallelClusterVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "parallelcluster"
            ]
          },
          "CookbookVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "cookbook"
            ]
          },
          "ChefVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "chef"
            ]
          },
          "BerkshelfVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "berkshelf"
            ]
          },
          "ComputeSecurityGroups": {
            "Fn::Join": [
              ",",
              [
                {
                  "Fn::If": [
                    "CreateSecurityGroups",
                    {
                      "Ref": "ComputeSecurityGroup"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                },
                {
                  "Fn::If": [
                    "AddAdditionalSG",
                    {
                      "Ref": "AdditionalSG"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                },
                {
                  "Fn::If": [
                    "UseExistingSecurityGroup",
                    {
                      "Ref": "VPCSecurityGroupId"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                }
              ]
            ]
          },
          "AssociatePublicIpAddress": {
            "Fn::If": [
              "ComputePublicIps",
              true,
              false
            ]
          },
          "ClusterType": {
            "Ref": "ClusterType"
          },
          "SpotPrice": {
            "Ref": "SpotPrice"
          },
          "ScaleDownIdleTime": {
            "Ref": "ScaleDownIdleTime"
          },
          "MasterPrivateDnsName": {
            "Fn::GetAtt": [
              "MasterServerSubstack",
              "Outputs.MasterPrivateDnsName"
            ]
          },
          "MasterPrivateIP": {
            "Fn::GetAtt": [
              "MasterServerSubstack",
              "Outputs.MasterPrivateIP"
            ]
          },
          "ComputeNetworkInterfacesCount": {
            "Fn::Select": [
              "1",
              {
                "Ref": "NetworkInterfacesCount"
              }
            ]
          }
        },
        "TemplateURL": {
          "Fn::Sub": [
            "https://${AWS::Region}-aws-parallelcluster.s3.${AWS::Region}.${s3_url}/templates/compute-fleet-substack-${version}.cfn.yaml",
            {
              "s3_url": {
                "Fn::FindInMap": [
                  "Partition2Url",
                  {
                    "Ref": "AWS::Partition"
                  },
                  "url"
                ]
              },
              "version": {
                "Fn::FindInMap": [
                  "PackagesVersions",
                  "default",
                  "parallelcluster"
                ]
              }
            }
          ]
        }
      },
      "Condition": "CreateComputeFleet"
    },
    "ComputeFleetHITSubstack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "Parameters": {
          "ComputeSubnetId": {
            "Fn::If": [
              "UseMasterSubnetForCompute",
              {
                "Ref": "MasterSubnetId"
              },
              {
                "Fn::If": [
                  "CreateComputeSubnetForCompute",
                  {
                    "Ref": "ComputeSubnet"
                  },
                  {
                    "Ref": "ComputeSubnetId"
                  }
                ]
              }
            ]
          },
          "RootDevice": {
            "Fn::FindInMap": [
              "OSFeatures",
              {
                "Ref": "BaseOS"
              },
              "RootDevice"
            ]
          },
          "RootVolumeSize": {
            "Ref": "ComputeRootVolumeSize"
          },
          "KeyName": {
            "Ref": "KeyName"
          },
          "MainStackName": {
            "Ref": "AWS::StackName"
          },
          "MainStackUniqueId": {
            "Fn::Select": [
              "2",
              {
                "Fn::Split": [
                  "/",
                  {
                    "Ref": "AWS::StackId"
                  }
                ]
              }
            ]
          },
          "AttributesTagValue": {
            "Fn::Sub": [
              "${BaseOS}, ${Scheduler}, ${version}, ${Architecture}",
              {
                "version": {
                  "Fn::FindInMap": [
                    "PackagesVersions",
                    "default",
                    "parallelcluster"
                  ]
                }
              }
            ]
          },
          "NetworkingTagValue": {
            "Fn::Sub": "EFA=${EFA}"
          },
          "FilesystemTagValue": {
            "Fn::Sub": [
              "efs=${efs}, multiebs=${NumberOfEBSVol}, raid=${raid}, fsx=${fsx}",
              {
                "efs": {
                  "Fn::If": [
                    "CreateEFSSubstack",
                    "1",
                    "0"
                  ]
                },
                "raid": {
                  "Fn::If": [
                    "CreateRAIDSubstack",
                    "1",
                    "0"
                  ]
                },
                "fsx": {
                  "Fn::If": [
                    "CreateFSXSubstack",
                    "1",
                    "0"
                  ]
                }
              }
            ]
          },
          "ImageId": {
            "Fn::If": [
              "UseCustomAMI",
              {
                "Ref": "CustomAMI"
              },
              {
                "Fn::If": [
                  "UseArmAMIs",
                  {
                    "Fn::FindInMap": [
                      "AWSRegionOS2AMIarm64",
                      {
                        "Ref": "AWS::Region"
                      },
                      {
                        "Ref": "BaseOS"
                      }
                    ]
                  },
                  {
                    "Fn::FindInMap": [
                      "AWSRegionOS2AMIx86",
                      {
                        "Ref": "AWS::Region"
                      },
                      {
                        "Ref": "BaseOS"
                      }
                    ]
                  }
                ]
              }
            ]
          },
          "IamInstanceProfile": {
            "Ref": "RootInstanceProfile"
          },
          "BaseOS": {
            "Ref": "BaseOS"
          },
          "OSUser": {
            "Fn::FindInMap": [
              "OSFeatures",
              {
                "Ref": "BaseOS"
              },
              "User"
            ]
          },
          "PreInstallScript": {
            "Ref": "PreInstallScript"
          },
          "PreInstallArgs": {
            "Ref": "PreInstallArgs"
          },
          "PostInstallScript": {
            "Ref": "PostInstallScript"
          },
          "PostInstallArgs": {
            "Ref": "PostInstallArgs"
          },
          "RAIDOptions": {
            "Ref": "RAIDOptions"
          },
          "EFSId": {
            "Fn::If": [
              "CreateEFSSubstack",
              {
                "Fn::GetAtt": [
                  "EFSSubstack",
                  "Outputs.FileSystemId"
                ]
              },
              ""
            ]
          },
          "EFSOptions": {
            "Ref": "EFSOptions"
          },
          "FSXId": {
            "Fn::If": [
              "CreateFSXSubstack",
              {
                "Fn::GetAtt": [
                  "FSXSubstack",
                  "Outputs.FileSystemId"
                ]
              },
              ""
            ]
          },
          "FSXOptions": {
            "Ref": "FSXOptions"
          },
          "Scheduler": {
            "Ref": "Scheduler"
          },
          "EncryptedEphemeral": {
            "Ref": "EncryptedEphemeral"
          },
          "EphemeralDir": {
            "Ref": "EphemeralDir"
          },
          "SharedDir": {
            "Ref": "SharedDir"
          },
          "ProxyServer": {
            "Ref": "ProxyServer"
          },
          "ClusterDNSDomain": {
            "Fn::Sub": [
              "${ClusterName}.pcluster",
              {
                "ClusterName": {
                  "Fn::Select": [
                    "1",
                    {
                      "Fn::Split": [
                        "parallelcluster-",
                        {
                          "Ref": "AWS::StackName"
                        }
                      ]
                    }
                  ]
                }
              }
            ]
          },
          "IntelHPCPlatform": {
            "Ref": "IntelHPCPlatform"
          },
          "CWLoggingEnabled": {
            "Fn::GetAtt": [
              "CloudWatchLogsSubstack",
              "Outputs.Enabled"
            ]
          },
          "ExtraJson": {
            "Ref": "ExtraJson"
          },
          "CustomChefCookbook": {
            "Ref": "CustomChefCookbook"
          },
          "AWSDomain": {
            "Fn::FindInMap": [
              "Partition2Url",
              {
                "Ref": "AWS::Partition"
              },
              "url"
            ]
          },
          "ParallelClusterVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "parallelcluster"
            ]
          },
          "CookbookVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "cookbook"
            ]
          },
          "ChefVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "chef"
            ]
          },
          "BerkshelfVersion": {
            "Fn::FindInMap": [
              "PackagesVersions",
              "default",
              "berkshelf"
            ]
          },
          "ComputeSecurityGroups": {
            "Fn::Join": [
              ",",
              [
                {
                  "Fn::If": [
                    "CreateSecurityGroups",
                    {
                      "Ref": "ComputeSecurityGroup"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                },
                {
                  "Fn::If": [
                    "AddAdditionalSG",
                    {
                      "Ref": "AdditionalSG"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                },
                {
                  "Fn::If": [
                    "UseExistingSecurityGroup",
                    {
                      "Ref": "VPCSecurityGroupId"
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                }
              ]
            ]
          },
          "AssociatePublicIpAddress": {
            "Fn::If": [
              "ComputePublicIps",
              true,
              false
            ]
          },
          "VPCId": {
            "Ref": "VPCId"
          },
          "RootRole": {
            "Fn::If": [
              "UseEC2IAMRole",
              "NONE",
              {
                "Ref": "RootRole"
              }
            ]
          },
          "IAMLambdaRoleName": {
            "Ref": "IAMLambdaRoleName"
          },
          "ResourcesS3Bucket": {
            "Ref": "ResourcesS3Bucket"
          },
          "ArtifactS3RootDirectory": {
            "Ref": "ArtifactS3RootDirectory"
          }
        },
        "TemplateURL": {
          "Fn::Sub": [
            "https://${ResourcesS3Bucket}.s3.${AWS::Region}.${s3_url}/${ArtifactS3RootDirectory}/templates/compute-fleet-hit-substack.rendered.cfn.yaml",
            {
              "s3_url": {
                "Fn::FindInMap": [
                  "Partition2Url",
                  {
                    "Ref": "AWS::Partition"
                  },
                  "url"
                ]
              }
            }
          ]
        }
      },
      "Condition": "CreateHITSubstack"
    },
    "CloudWatchDashboardSubstack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "Parameters": {
          "PclusterStackName": {
            "Ref": "AWS::StackName"
          },
          "CWLogGroupName": {
            "Fn::Sub": [
              "/aws/parallelcluster/${cluster_name}",
              {
                "cluster_name": {
                  "Fn::Select": [
                    "1",
                    {
                      "Fn::Split": [
                        "parallelcluster-",
                        {
                          "Ref": "AWS::StackName"
                        }
                      ]
                    }
                  ]
                }
              }
            ]
          },
          "MasterInstanceId": {
            "Fn::GetAtt": [
              "MasterServerSubstack",
              "Outputs.MasterInstanceID"
            ]
          },
          "MasterPrivateIP": {
            "Fn::GetAtt": [
              "MasterServerSubstack",
              "Outputs.MasterPrivateIP"
            ]
          },
          "EBSVolumesIds": {
            "Fn::GetAtt": [
              "EBSCfnStack",
              "Outputs.Volumeids"
            ]
          },
          "RAIDVolumesIds": {
            "Fn::If": [
              "CreateRAIDSubstack",
              {
                "Fn::GetAtt": [
                  "RAIDSubstack",
                  "Outputs.Volumeids"
                ]
              },
              "NONE"
            ]
          },
          "EFSFileSystemId": {
            "Fn::If": [
              "CreateEFSSubstack",
              {
                "Fn::GetAtt": [
                  "EFSSubstack",
                  "Outputs.FileSystemId"
                ]
              },
              "NONE"
            ]
          },
          "FSXFileSystemId": {
            "Fn::If": [
              "CreateFSXSubstack",
              {
                "Fn::GetAtt": [
                  "FSXSubstack",
                  "Outputs.FileSystemId"
                ]
              },
              "NONE"
            ]
          }
        },
        "TemplateURL": {
          "Fn::Sub": [
            "https://${ResourcesS3Bucket}.s3.${AWS::Region}.${s3_url}/${ArtifactS3RootDirectory}/templates/cw-dashboard-substack.rendered.cfn.yaml",
            {
              "s3_url": {
                "Fn::FindInMap": [
                  "Partition2Url",
                  {
                    "Ref": "AWS::Partition"
                  },
                  "url"
                ]
              }
            }
          ]
        }
      }
    }
  },
  "Outputs": {
    "ClusterUser": {
      "Description": "Username to login to head node",
      "Value": {
        "Fn::FindInMap": [
          "OSFeatures",
          {
            "Ref": "BaseOS"
          },
          "User"
        ]
      }
    },
    "MasterPrivateIP": {
      "Description": "Private IP Address of the head node",
      "Value": {
        "Fn::GetAtt": [
          "MasterServerSubstack",
          "Outputs.MasterPrivateIP"
        ]
      }
    },
    "MasterPublicIP": {
      "Description": "Public IP Address of the head node",
      "Value": {
        "Fn::GetAtt": [
          "MasterServerSubstack",
          "Outputs.MasterPublicIP"
        ]
      },
      "Condition": "MasterPublicIp"
    },
    "GangliaPrivateURL": {
      "Description": "Private URL to access Ganglia (disabled by default)",
      "Value": {
        "Fn::Join": [
          "",
          [
            "http://",
            {
              "Fn::GetAtt": [
                "MasterServerSubstack",
                "Outputs.MasterPrivateIP"
              ]
            },
            "/ganglia/"
          ]
        ]
      }
    },
    "GangliaPublicURL": {
      "Description": "Public URL to access Ganglia (disabled by default)",
      "Value": {
        "Fn::Join": [
          "",
          [
            "http://",
            {
              "Fn::GetAtt": [
                "MasterServerSubstack",
                "Outputs.MasterPublicIP"
              ]
            },
            "/ganglia/"
          ]
        ]
      },
      "Condition": "MasterPublicIp"
    },
    "ResourcesS3Bucket": {
      "Description": "S3 user bucket where AWS ParallelCluster resources are stored",
      "Value": {
        "Ref": "ResourcesS3Bucket"
      }
    },
    "ArtifactS3RootDirectory": {
      "Description": "Root directory in S3 bucket where cluster artifacts are stored",
      "Value": {
        "Ref": "ArtifactS3RootDirectory"
      }
    },
    "BatchComputeEnvironmentArn": {
      "Value": {
        "Fn::GetAtt": [
          "AWSBatchStack",
          "Outputs.ComputeEnvironmentArn"
        ]
      },
      "Condition": "CreateAWSBatchStack"
    },
    "BatchJobQueueArn": {
      "Value": {
        "Fn::GetAtt": [
          "AWSBatchStack",
          "Outputs.JobQueueArn"
        ]
      },
      "Condition": "CreateAWSBatchStack"
    },
    "BatchJobDefinitionArn": {
      "Value": {
        "Fn::GetAtt": [
          "AWSBatchStack",
          "Outputs.JobDefinitionArn"
        ]
      },
      "Condition": "CreateAWSBatchStack"
    },
    "BatchJobDefinitionMnpArn": {
      "Value": {
        "Fn::GetAtt": [
          "AWSBatchStack",
          "Outputs.MNPJobDefinitionArn"
        ]
      },
      "Condition": "CreateAWSBatchStack"
    },
    "BatchUserRole": {
      "Value": {
        "Fn::GetAtt": [
          "AWSBatchStack",
          "Outputs.BatchUserRole"
        ]
      },
      "Condition": "CreateAWSBatchStack"
    },
    "ASGName": {
      "Value": {
        "Fn::GetAtt": [
          "ComputeFleetSubstack",
          "Outputs.ASGName"
        ]
      },
      "Condition": "CreateComputeFleet"
    },
    "IsHITCluster": {
      "Value": "true",
      "Condition": "CreateHITSubstack"
    },
    "ClusterConfigMetadata": {
      "Value": {
        "Ref": "ClusterConfigMetadata"
      }
    }
  }
}
